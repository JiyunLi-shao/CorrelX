<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cx2d_lib &#8212; CorrelX 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cx2d_lib</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># &lt;nbformat&gt;3.0&lt;/nbformat&gt;</span>

<span class="c1"># &lt;codecell&gt;</span>

<span class="c1">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1">#The MIT CorrelX Correlator</span>
<span class="c1">#</span>
<span class="c1">#https://github.com/MITHaystack/CorrelX</span>
<span class="c1">#Contact: correlX@haystack.mit.edu</span>
<span class="c1">#Project leads: Victor Pankratius, Pedro Elosegui Project developer: A.J. Vazquez Alvarez</span>
<span class="c1">#</span>
<span class="c1">#Copyright 2017 MIT Haystack Observatory</span>
<span class="c1">#</span>
<span class="c1">#Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1">#The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1">#THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#------------------------------</span>
<span class="c1">#------------------------------</span>
<span class="c1">#Project: CorrelX.</span>
<span class="c1">#File: cx2d_lib.py.</span>
<span class="c1">#Author: A.J. Vazquez Alvarez (ajvazquez@haystack.mit.edu)</span>
<span class="c1">#Description:</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module with basic functions to convert output from CorrelX/CX to DiFX/SWIN+PCAL.</span>

<span class="sd"> The objective of this library is to connect the CorrelX processing chain with:</span>
<span class="sd"> | *vex2difx+calcif2 (input): for generating the configuration files.</span>
<span class="sd"> | *difx2mark4 (output): for generating a mark4 fileset that can be processed with fourfit.</span>

<span class="sd">Conventions CorrelX</span>
<span class="sd">-------------------</span>
<span class="sd">    Make sure that the same file const_mapred.py used for the correlation is imported here, since the fields in the header are</span>
<span class="sd">      accesed using the constants const_mapred.INDEX_*.</span>

<span class="sd">Conventions DiFX</span>
<span class="sd">----------------</span>
<span class="sd">    Conventions are as defined in:</span>
<span class="sd">    |  DiFX/SWIN [DIFX_*]: CSIRO - http://www.atnf.csiro.au/vlbi/dokuwiki/doku.php/difx/files#the_swin_output_data_format (2016.01.12)</span>
<span class="sd">    |  DiFX/PCAL [PCAL_*]: [Br14] NRAO - A Guide to the DiFX Software Correlator (Version 2.2), Section 6.8.2. Pulse cal data files. (2014.06.23)</span>
<span class="sd">    |  DiFX/SWIN [*.im,*.input]: CSIRO - http://www.atnf.csiro.au/vlbi/dokuwiki/doku.php/difx/files (2016.01.12)</span>

<span class="sd">Sections of code</span>
<span class="sd">----------------</span>
<span class="sd">    | CX output (read)</span>
<span class="sd">    | CX output (debug)</span>
<span class="sd">    | DiFX/SWIN (write)</span>
<span class="sd">    | DiFX/SWIN (read)</span>
<span class="sd">    | Processing zoombands: CX -&gt; CX_zoomed</span>
<span class="sd">    | Conversion CorrelX/CX -&gt; DiFX/SWIN</span>
<span class="sd">    | Conversion CorrelX/CX -&gt; DiFX/PCAL</span>
<span class="sd">    | Conversion CorrelX/CX -&gt; DiFX/SWIN+PCAL</span>
<span class="sd">    | DiFX/.im,.input parser tools</span>
<span class="sd">    | Conversion DiFX/.im -&gt; CorrelX/delay_model+sources</span>
<span class="sd">    | Conversion DiFX/.input -&gt; CorrelX/stations+correlation+media</span>
<span class="sd">    </span>
<span class="sd">(!) Limitations</span>
<span class="sd">---------------</span>
<span class="sd">    | Single source. source_index=0</span>
<span class="sd">    | Single configuration. configuration_index=0</span>
<span class="sd">    | Single phase_centre. phase_centre=0</span>
<span class="sd">    | Single pulsar_bin. pulsar_bin=0</span>
<span class="sd">    | Data weight is forced to be 1</span>
<span class="sd">    | u,v,w are forced to be 0</span>
<span class="sd">    | Averaging currently only implemented for zoom bands</span>
<span class="sd">    | Zoom bands currently implemented during postprocessing</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd"> All constants are kept in this file due to strong dependence on external references.</span>
<span class="sd"> </span>
<span class="sd">TO DO</span>
<span class="sd">-----</span>
<span class="sd"> | Create separate library and move there the CX output file processing functions.</span>
<span class="sd"> | Configuration conversion libraries: experimental, see limitations for input_to_media().</span>
<span class="sd"> | Print remainder and do checks for CX_IMPORT_CONST_MAPRED.</span>
<span class="sd"> | Remove back_compat option (replace by custom const_mapred import).</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#History:</span>
<span class="c1">#initial version: 2016.01 ajva</span>
<span class="c1">#MIT Haystack Observatory</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>



<span class="c1">###########################################</span>
<span class="c1">#           Matplotlib support</span>
<span class="c1">###########################################</span>
<span class="n">ENABLE_PLOTTING</span><span class="o">=</span><span class="mi">1</span>                                        <span class="c1"># Disable plotting if running on a machine without matplotlib</span>
<span class="c1">#                                                        # Currently: use 0 for Python2, 1 for Python3</span>





<span class="c1">###################################################################################### CorrelX/version</span>

<span class="c1">###########################################</span>
<span class="c1">#         CorrelX/CX version</span>
<span class="c1">###########################################</span>
<span class="n">CX_IMPORT_CONST_MAPRED</span><span class="o">=</span><span class="s2">&quot;latest&quot;</span>                          <span class="c1"># Latest header format (const_mapred.py)</span>
<span class="c1">#CX_IMPORT_CONST_MAPRED=&quot;2016.08.04&quot;                      # Legacy header format (const_mapred_legacy_20160804.py)</span>
<span class="n">CX_OVERRIDE_META_LEN</span><span class="o">=-</span><span class="mi">1</span>                                  <span class="c1"># if &lt;=0 take META_LEN from const_mapred</span>
<span class="c1">#CX_OVERRIDE_META_LEN=27                                  # if &gt;0 take this value for META_LEN (number of header metadata fields)</span>






<span class="c1">###################################################################################### CorrelX/ini</span>

<span class="c1">###########################################</span>
<span class="c1">#         CorrelX/ini</span>
<span class="c1">###########################################</span>
<span class="n">CX_DEFAULT_MEDIA_DIR</span><span class="o">=</span><span class="s2">&quot;media&quot;</span>                             <span class="c1"># Folder relative to ini folder to place symbolyc links to media</span>






<span class="c1">###################################################################################### DiFX/version</span>

<span class="c1">###########################################</span>
<span class="c1">#   DiFX/SWIN+PCAL version (only display)</span>
<span class="c1">###########################################</span>
<span class="n">REFERENCE_SWIN_WEB_VERSION</span><span class="o">=</span>  <span class="s2">&quot;2016.01.12&quot;</span>                <span class="c1"># Report this on top of this file.</span>
<span class="n">REFERENCE_DIFX_GUIDE_VERSION</span><span class="o">=</span><span class="s2">&quot;2014.06.23&quot;</span>                <span class="c1"># Report this on top of this file.</span>






<span class="c1">###################################################################################### DiFX/SWIN</span>

<span class="c1">###############################################</span>
<span class="c1">#          DiFX/SWIN - filename</span>
<span class="c1">###############################################</span>
<span class="n">DIFX_FILENAME_PREFIX</span><span class="o">=</span>         <span class="s2">&quot;DIFX&quot;</span>
<span class="n">DIFX_FILENAME_SEP</span><span class="o">=</span>            <span class="s2">&quot;_&quot;</span>
<span class="n">DIFX_FILENAME_SUFFIX</span><span class="o">=</span>         <span class="s2">&quot;.s0000.b0000&quot;</span>             

<span class="c1">###########################################</span>
<span class="c1">#  DiFX/SWIN - forced values for writting</span>
<span class="c1">###########################################</span>
<span class="n">SYNC_WORD</span><span class="o">=</span>             <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00\xff\x00\xff</span><span class="s1">&#39;</span>               <span class="c1"># This sync word is for little endiannes</span>
<span class="n">FORCED_HEADER_VERSION</span><span class="o">=</span> <span class="mi">1</span>                                 <span class="c1"># Header version</span>
<span class="n">FORCED_SOURCE_INDEX</span><span class="o">=</span>   <span class="mi">0</span>                                 <span class="c1"># Source id</span>
<span class="n">FORCED_CONFIG_INDEX</span><span class="o">=</span>   <span class="mi">0</span>                                 <span class="c1"># Configuration index</span>
<span class="n">FORCED_PULSAR_BIN</span><span class="o">=</span>     <span class="mi">0</span>                                 <span class="c1"># Pulsar bin</span>
<span class="n">FORCED_WEIGHT</span><span class="o">=</span>         <span class="mf">1.0</span>                               <span class="c1"># Weight</span>
<span class="n">FORCED_U</span><span class="o">=</span>              <span class="mf">0.0</span>                               <span class="c1"># U [m]</span>
<span class="n">FORCED_V</span><span class="o">=</span>              <span class="mf">0.0</span>                               <span class="c1"># V [m]</span>
<span class="n">FORCED_W</span><span class="o">=</span>              <span class="mf">0.0</span>                               <span class="c1"># W [m]</span>

<span class="c1">###########################################</span>
<span class="c1">#   DiFX/SWIN - endiannes for writting</span>
<span class="c1">###########################################</span>
<span class="n">END_SWIN_INT</span><span class="o">=</span>         <span class="s2">&quot;&lt;I&quot;</span>                               <span class="c1"># Integer (used in header metadata</span>
<span class="n">END_SWIN_DOUBLE</span><span class="o">=</span>      <span class="s2">&quot;&lt;d&quot;</span>                               <span class="c1"># Double  (used in header metadata)</span>
<span class="n">END_SWIN_CHAR</span><span class="o">=</span>        <span class="s2">&quot;&lt;c&quot;</span>                               <span class="c1"># Char    (used in header polarization pair)</span>
<span class="n">END_SWIN_FLOAT</span><span class="o">=</span>       <span class="s2">&quot;&lt;f&quot;</span>                               <span class="c1"># Foat    (used in visibilities)</span>

<span class="c1">###########################################</span>
<span class="c1">#  DiFX/SWIN - Number of bytes for reading</span>
<span class="c1">###########################################</span>
<span class="n">NUM_BYTES_SWIN_INT</span><span class="o">=</span>    <span class="mi">4</span>
<span class="n">NUM_BYTES_SWIN_DOUBLE</span><span class="o">=</span> <span class="mi">8</span>
<span class="n">NUM_BYTES_SWIN_FLOAT</span><span class="o">=</span>  <span class="mi">4</span>
<span class="n">NUM_BYTES_SWIN_SYNC</span><span class="o">=</span>   <span class="mi">4</span>
<span class="n">NUM_BYTES_SWIN_HEADER</span><span class="o">=</span><span class="mi">74</span>

<span class="c1">###############################################</span>
<span class="c1">#  DiFX/SWIN - positions of fields for reading</span>
<span class="c1">###############################################</span>
<span class="n">POS_SWIN_SYNC</span><span class="o">=</span>         <span class="mi">0</span>                                <span class="c1"># Note that reference (web) starts numbering at 1, here at 0</span>
<span class="n">POS_SWIN_VERSION</span><span class="o">=</span>      <span class="mi">4</span>
<span class="n">POS_SWIN_BASELINE</span><span class="o">=</span>     <span class="mi">8</span>
<span class="n">POS_SWIN_MJD</span><span class="o">=</span>         <span class="mi">12</span>
<span class="n">POS_SWIN_SECONDS</span><span class="o">=</span>     <span class="mi">16</span>
<span class="n">POS_SWIN_CONFIG</span><span class="o">=</span>      <span class="mi">24</span>
<span class="n">POS_SWIN_SOURCE</span><span class="o">=</span>      <span class="mi">28</span>
<span class="n">POS_SWIN_FREQ</span><span class="o">=</span>        <span class="mi">32</span>
<span class="n">POS_SWIN_POL0</span><span class="o">=</span>        <span class="mi">36</span>
<span class="n">POS_SWIN_POL1</span><span class="o">=</span>        <span class="mi">37</span>
<span class="n">POS_SWIN_PULSAR</span><span class="o">=</span>      <span class="mi">38</span>
<span class="n">POS_SWIN_WEIGHT</span><span class="o">=</span>      <span class="mi">42</span>
<span class="n">POS_SWIN_U</span><span class="o">=</span>           <span class="mi">50</span>
<span class="n">POS_SWIN_V</span><span class="o">=</span>           <span class="mi">58</span>
<span class="n">POS_SWIN_W</span><span class="o">=</span>           <span class="mi">66</span>




<span class="c1">###################################################################################### DiFX/PCAL</span>

<span class="c1">###############################################</span>
<span class="c1">#          DiFX/PCAL - filename</span>
<span class="c1">###############################################</span>
<span class="n">PCAL_FILENAME_PREFIX</span><span class="o">=</span>         <span class="s2">&quot;PCAL&quot;</span>
<span class="n">PCAL_FILENAME_SEP</span><span class="o">=</span>            <span class="s2">&quot;_&quot;</span>
<span class="c1"># fixed length seconds</span>
<span class="n">PCAL_FILENAME_SECONDS_ZFILL</span><span class="o">=</span>  <span class="mi">6</span>                      

<span class="c1">###############################################</span>
<span class="c1">#         DiFX/PCAL - header lines</span>
<span class="c1">###############################################</span>
<span class="n">PCAL_HEADER_TITLE</span><span class="o">=</span>            <span class="s2">&quot;# cx-derived pulse cal data&quot;</span>
<span class="n">PCAL_HEADER_VERSION</span><span class="o">=</span>          <span class="s2">&quot;# File version = &quot;</span>
<span class="n">PCAL_HEADER_MJD</span><span class="o">=</span>              <span class="s2">&quot;# Start MJD = &quot;</span>
<span class="n">PCAL_HEADER_SECONDS</span><span class="o">=</span>          <span class="s2">&quot;# Start seconds = &quot;</span>
<span class="n">PCAL_HEADER_TELESCOPE</span><span class="o">=</span>        <span class="s2">&quot;# Telescope name = &quot;</span>
<span class="n">PCAL_HEADER_VERSION_VAL</span><span class="o">=</span>      <span class="mi">1</span>

<span class="c1">###############################################</span>
<span class="c1">#         DiFX/PCAL - record format</span>
<span class="c1">###############################################</span>
<span class="c1"># float point value format</span>
<span class="n">PCAL_SECONDS_FLOAT_FORMAT</span><span class="o">=</span>     <span class="s2">&quot;</span><span class="si">%.7f</span><span class="s2">&quot;</span>
<span class="n">PCAL_TONE_SCI_FORMAT</span><span class="o">=</span>          <span class="s2">&quot;</span><span class="si">%.5e</span><span class="s2">&quot;</span>
<span class="c1"># invalid record</span>
<span class="n">PCAL_INVALID_RECORD_STR</span><span class="o">=</span>       <span class="s2">&quot;-1 0 0 0&quot;</span>




<span class="c1">###################################################################################### DiFX/.im+input</span>

<span class="c1">###########################################</span>
<span class="c1">#  DiFX/.im+input - general</span>
<span class="c1">###########################################</span>
<span class="c1"># separator parameter: value</span>
<span class="n">C_DIFX_SEPARATOR</span><span class="o">=</span>             <span class="s2">&quot;:&quot;</span>                      

<span class="c1">###########################################</span>
<span class="c1">#   DiFX/.im - patterns to find lines</span>
<span class="c1">###########################################</span>
<span class="c1"># delay model info</span>
<span class="n">C_DIFX_IM_DELAY_US</span><span class="o">=</span>           <span class="s2">&quot;DELAY (us)&quot;</span>
<span class="n">C_DIFX_IM_DRY_US</span><span class="o">=</span>             <span class="s2">&quot;DRY (us)&quot;</span>
<span class="n">C_DIFX_IM_INTERVAL_SECS</span><span class="o">=</span>      <span class="s2">&quot;INTERVAL (SECS)&quot;</span>
<span class="n">C_DIFX_IM_MJD</span><span class="o">=</span>                <span class="s2">&quot;MJD&quot;</span>
<span class="n">C_DIFX_IM_POLY</span><span class="o">=</span>               <span class="s2">&quot;POLY&quot;</span>
<span class="n">C_DIFX_IM_SCAN</span><span class="o">=</span>               <span class="s2">&quot;SCAN&quot;</span>
<span class="n">C_DIFX_IM_SEC</span><span class="o">=</span>                <span class="s2">&quot;SEC&quot;</span>
<span class="n">C_DIFX_IM_WET_US</span><span class="o">=</span>             <span class="s2">&quot;WET (us)&quot;</span>
<span class="c1"># sources info</span>
<span class="n">C_DIFX_IM_POINTING_SRC</span><span class="o">=</span>       <span class="s2">&quot;POINTING SRC&quot;</span>

<span class="c1">###########################################</span>
<span class="c1">#  DiFX/.input - patterns to find lines</span>
<span class="c1">###########################################</span>
<span class="c1"># stations info</span>
<span class="n">C_DIFX_INPUT_CLOCK_COEFF</span><span class="o">=</span>     <span class="s2">&quot;CLOCK COEFF&quot;</span>
<span class="n">C_DIFX_INPUT_CLOCK_REF_MJD</span><span class="o">=</span>   <span class="s2">&quot;CLOCK REF MJD&quot;</span>
<span class="c1"># correlation info</span>
<span class="n">C_DIFX_INPUT_TELESCOPES</span><span class="o">=</span>      <span class="s2">&quot;TELESCOPE ENTRIES&quot;</span>
<span class="n">C_DIFX_INPUT_EXECUTE_TIME</span><span class="o">=</span>    <span class="s2">&quot;EXECUTE TIME (SEC)&quot;</span>
<span class="n">C_DIFX_INPUT_INT_TIME</span><span class="o">=</span>        <span class="s2">&quot;INT TIME (SEC)&quot;</span>
<span class="n">C_DIFX_INPUT_NUM_CHANNELS</span><span class="o">=</span>    <span class="s2">&quot;NUM CHANNELS 0&quot;</span>
<span class="n">C_DIFX_INPUT_PHASE_CALS</span><span class="o">=</span>      <span class="s2">&quot;PHASE CALS 0 OUT&quot;</span>
<span class="n">C_DIFX_INPUT_START_MJD</span><span class="o">=</span>       <span class="s2">&quot;START MJD&quot;</span>
<span class="n">C_DIFX_INPUT_START_SECONDS</span><span class="o">=</span>   <span class="s2">&quot;START SECONDS&quot;</span>
<span class="c1"># media info</span>
<span class="n">C_DIFX_INPUT_BW</span><span class="o">=</span>              <span class="s2">&quot;BW (MHZ)&quot;</span>
<span class="n">C_DIFX_INPUT_FREQ</span><span class="o">=</span>            <span class="s2">&quot;FREQ (MHZ)&quot;</span>
<span class="n">C_DIFX_INPUT_BASELINE_TABLE</span><span class="o">=</span>  <span class="s2">&quot;BASELINE TABLE&quot;</span>
<span class="n">C_DIFX_INPUT_COMPLEX</span><span class="o">=</span>         <span class="s2">&quot;COMPLEX&quot;</span>
<span class="n">C_DIFX_INPUT_DATA_SAMPLING</span><span class="o">=</span>   <span class="s2">&quot;DATA SAMPLING&quot;</span>
<span class="n">C_DIFX_INPUT_DATA_SOURCE</span><span class="o">=</span>     <span class="s2">&quot;DATA SOURCE&quot;</span>
<span class="n">C_DIFX_INPUT_FILE</span><span class="o">=</span>            <span class="s2">&quot;FILE &quot;</span>
<span class="n">C_DIFX_INPUT_FILES</span><span class="o">=</span>           <span class="s2">&quot;FILES&quot;</span>
<span class="n">C_DIFX_INPUT_INDEX</span><span class="o">=</span>           <span class="s2">&quot;INDEX&quot;</span>
<span class="n">C_DIFX_INPUT_PHASE_CAL_INT</span><span class="o">=</span>   <span class="s2">&quot;PHASE CAL INT (MHZ)&quot;</span>
<span class="n">C_DIFX_INPUT_POL</span><span class="o">=</span>             <span class="s2">&quot;POL&quot;</span>
<span class="n">C_DIFX_INPUT_REC_BAND</span><span class="o">=</span>        <span class="s2">&quot;REC BAND&quot;</span>
<span class="n">C_DIFX_INPUT_REC_FREQ</span><span class="o">=</span>        <span class="s2">&quot;REC FREQ&quot;</span>
<span class="n">C_DIFX_INPUT_SIDEBAND</span><span class="o">=</span>        <span class="s2">&quot;SIDEBAND&quot;</span>
<span class="n">C_DIFX_INPUT_TELESCOPE_INDEX</span><span class="o">=</span> <span class="s2">&quot;TELESCOPE INDEX&quot;</span>
<span class="n">C_DIFX_INPUT_TELESCOPE_NAME</span><span class="o">=</span>  <span class="s2">&quot;TELESCOPE NAME&quot;</span>
<span class="n">C_DIFX_INPUT_TELESCOPE_TABLE</span><span class="o">=</span> <span class="s2">&quot;TELESCOPE TABLE&quot;</span>



<span class="c1">###########################################</span>
<span class="c1">#          Import</span>
<span class="c1">###########################################</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="c1"># Constants for mapper and reducer</span>

<span class="k">if</span> <span class="n">CX_IMPORT_CONST_MAPRED</span><span class="o">==</span><span class="s2">&quot;latest&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">const_mapred</span>              <span class="c1"># CX output separators and field locations (!) Make sure it is the same as used in correlation.</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">const_mapred</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">const_mapred</span> <span class="k">import</span> <span class="o">*</span>

<span class="k">elif</span> <span class="n">CX_IMPORT_CONST_MAPRED</span><span class="o">==</span><span class="s2">&quot;2016.08.04&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">const_mapred_legacy_20160804</span>            
    <span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">const_mapred_legacy_20160804</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">const_mapred_legacy_20160804</span> <span class="k">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="n">CX_OVERRIDE_META_LEN</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
    <span class="n">META_LEN</span><span class="o">=</span><span class="n">CX_OVERRIDE_META_LEN</span>

<span class="c1">#print(&quot;CX header version: &quot;+CX_IMPORT_CONST_MAPRED)</span>
<span class="c1">#print(&quot;CX meta len: &quot;+str(META_LEN))</span>

<span class="kn">import</span> <span class="nn">lib_ini_files</span>                 <span class="c1"># CX ini files</span>
<span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">lib_ini_files</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">lib_ini_files</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">lib_acc_comp</span>                  <span class="c1"># CX accumulation periods</span>
<span class="n">imp</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">lib_acc_comp</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">lib_acc_comp</span> <span class="k">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">operator</span>

                                     <span class="c1"># Plotting</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1">#print(&quot;Matplotlib not available, proceeding with no plots!&quot;)</span>
    <span class="n">ENABLE_PLOTTING</span><span class="o">=</span><span class="mi">0</span>

<span class="k">if</span> <span class="n">ENABLE_PLOTTING</span><span class="p">:</span>
    <span class="c1">#mpl.use(&#39;PS&#39;)</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;Agg&#39;</span><span class="p">)</span>
    <span class="c1">#mpl.use(&quot;pgf&quot;)</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">matplotlib.font_manager</span> <span class="k">as</span> <span class="nn">font_manager</span>
    <span class="kn">from</span> <span class="nn">matplotlib.legend</span> <span class="k">import</span> <span class="n">Legend</span>


    
    
<span class="c1">###########################################</span>
<span class="c1">#          CX output (read)</span>
<span class="c1">###########################################    </span>
    
    
  
<div class="viewcode-block" id="split_line_correct_tab"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.split_line_correct_tab">[docs]</a><span class="k">def</span> <span class="nf">split_line_correct_tab</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Separate key and value in CX line.</span>
<span class="sd">    </span>
<span class="sd">    Update if changes to msvf.get_pair_str are done (key separator FIELD_SEP+KEY_SEP).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line_split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">KEY_SEP</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_split</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">line_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="p">(</span><span class="n">FIELD_SEP</span><span class="o">+</span><span class="n">line_split</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="c1">#print(line_split)</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IndexError splitting line&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">line_split</span><span class="p">)</span>
    <span class="k">return</span><span class="p">([</span><span class="n">meta</span><span class="p">,</span><span class="n">data</span><span class="p">])</span>  </div>
    
  


<div class="viewcode-block" id="read_line_cx"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.read_line_cx">[docs]</a><span class="k">def</span> <span class="nf">read_line_cx</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">fft_size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a line from a CX file (and check number of visibilities if required).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     line : str</span>
<span class="sd">          line from CX file.</span>
<span class="sd">     fft_size : int,optional</span>
<span class="sd">          number of coefficients in the visibilities (or pcal bins).</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     meta : str</span>
<span class="sd">         line header.</span>
<span class="sd">     st0 : int</span>
<span class="sd">         first station of the baseline.</span>
<span class="sd">     st1 : int</span>
<span class="sd">         second station of the baseline.</span>
<span class="sd">     key : int</span>
<span class="sd">         absolute key (see msvf.get_pair_str().key_value).</span>
<span class="sd">     vis : int</span>
<span class="sd">         accumulation period.</span>
<span class="sd">     chan : int</span>
<span class="sd">         band id.</span>
<span class="sd">     pol0 : int</span>
<span class="sd">         polarization id for st0.</span>
<span class="sd">     pol1 : int</span>
<span class="sd">         polariation id for st1.</span>
<span class="sd">     predata : str</span>
<span class="sd">         metadata fields.</span>
<span class="sd">     datac : complex 1D np.array</span>
<span class="sd">         visibilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="p">[</span><span class="n">meta</span><span class="p">,</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_line_correct_tab</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>


    <span class="p">[</span><span class="n">pxs</span><span class="p">,</span><span class="n">st0pol0</span><span class="p">,</span><span class="n">st1pol1</span><span class="p">,</span><span class="n">chanvis</span><span class="p">,</span><span class="n">acctot</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">FIELD_SEP</span><span class="p">)</span>
    <span class="p">[</span><span class="n">st0s</span><span class="p">,</span><span class="n">pol0s</span><span class="p">]</span> <span class="o">=</span> <span class="n">st0pol0</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SF_SEP</span><span class="p">)</span>
    <span class="p">[</span><span class="n">st1s</span><span class="p">,</span><span class="n">pol1s</span><span class="p">]</span> <span class="o">=</span> <span class="n">st1pol1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SF_SEP</span><span class="p">)</span>
    <span class="p">[</span><span class="n">keys</span><span class="p">,</span><span class="n">viss</span><span class="p">,</span><span class="n">chans</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanvis</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SF_SEP</span><span class="p">)</span>
    <span class="n">accs</span> <span class="o">=</span> <span class="n">acctot</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
    
    <span class="n">st0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">st0s</span><span class="p">)</span>
    <span class="n">pol0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pol0s</span><span class="p">)</span>
    <span class="n">st1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">st1s</span><span class="p">)</span>
    <span class="n">pol1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pol1s</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="n">chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chans</span><span class="p">)</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">viss</span><span class="p">)</span>
    <span class="n">acc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">accs</span><span class="p">)</span>
    
    <span class="n">predata</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="n">META_LEN</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">fft_size</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="n">META_LEN</span><span class="p">:])</span><span class="o">&lt;</span><span class="n">fft_size</span><span class="p">:</span>
        <span class="n">datac</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">datac</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="n">META_LEN</span><span class="p">:])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">complex</span><span class="p">)</span>
    
    <span class="n">header_data_split</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[:</span><span class="n">META_LEN</span><span class="p">]</span>
    <span class="n">n_bins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_data_split</span><span class="p">[</span><span class="n">INDEX_NBINS_PCAL</span><span class="p">])</span>
    <span class="n">pcal_freq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">header_data_split</span><span class="p">[</span><span class="n">INDEX_PCAL_FREQ</span><span class="p">])</span><span class="o">//</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">chan_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_data_split</span><span class="p">[</span><span class="n">INDEX_CHANNEL_INDEX</span><span class="p">])</span>
    <span class="n">acc_period</span> <span class="o">=</span> <span class="n">vis</span>  
    
    <span class="n">fs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="n">INDEX_FS</span><span class="p">])</span>
    
    <span class="k">return</span><span class="p">([</span><span class="n">meta</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">n_bins</span><span class="p">,</span><span class="n">pcal_freq</span><span class="p">,</span><span class="n">chan_index</span><span class="p">,</span><span class="n">acc_period</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">predata</span><span class="p">,</span><span class="n">datac</span><span class="p">])</span></div>


<div class="viewcode-block" id="read_cxoutput"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.read_cxoutput">[docs]</a><span class="k">def</span> <span class="nf">read_cxoutput</span><span class="p">(</span><span class="n">cxoutput_file</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">back_compat</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read cx output file into list.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     cxoutput_file : str</span>
<span class="sd">         path to cx file.</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     back_compat : int,optional</span>
<span class="sd">         [default 0][remove]</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     list_output : list</span>
<span class="sd">                             list of [st0,st1,vis,chan,pol0,pol1,diff_st] elements where:</span>
<span class="sd">                                 | st0:      first station in the baseline.</span>
<span class="sd">                                 | st1:      second station in the baseline.</span>
<span class="sd">                                 | vis:      accumulation period id.</span>
<span class="sd">                                 | chan:     channel id.</span>
<span class="sd">                                 | pol0:     polarization id for st0.</span>
<span class="sd">                                 | pol1:     polarization id for st1.</span>
<span class="sd">                                 | datac:    complex 1D np.array with visibilities.</span>
<span class="sd">                                 | diff_st:  field used for sorting.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO**</span>
<span class="sd">    |</span>
<span class="sd">    |    Sorting convention based on sorting based on actual SWIN files. Check method and find proper reference.</span>
<span class="sd">    |    Remove back_compat in libraries calling this function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">list_output</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">reduced_list</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cxoutput_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;px&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="mi">80</span><span class="p">])</span> 
                <span class="p">[</span><span class="n">meta</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">n_bins</span><span class="p">,</span>\
                      <span class="n">pcal_freq</span><span class="p">,</span><span class="n">chan_index</span><span class="p">,</span><span class="n">acc_period</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">predata</span><span class="p">,</span><span class="n">datac</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_line_cx</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        
               
                <span class="c1"># for sorting</span>
                <span class="n">diff_st</span><span class="o">=</span><span class="mi">1000000</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">st0</span><span class="o">-</span><span class="n">st1</span><span class="p">)</span>
                <span class="n">list_output</span><span class="o">+=</span><span class="p">[[</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">datac</span><span class="p">,</span><span class="n">diff_st</span><span class="p">]]</span>
                
                <span class="c1"># for display</span>
                <span class="n">reduced_list</span><span class="o">+=</span><span class="p">[[</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">diff_st</span><span class="p">]]</span>
                
                <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Sts.:  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st1</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Vis.: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vis</span><span class="p">))</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Chan.: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Pols.: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pol0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pol1</span><span class="p">))</span>
              

    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">reduced_list</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="mi">7</span><span class="p">])))</span>
    
    <span class="c1">#sorted_list=list_output</span>
    

    <span class="k">return</span><span class="p">(</span><span class="n">list_output</span><span class="p">)</span>    </div>
    

<span class="c1">###########################################</span>
<span class="c1">#          CX output (debug)</span>
<span class="c1">###########################################    </span>


<div class="viewcode-block" id="get_list_meta"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_list_meta">[docs]</a><span class="k">def</span> <span class="nf">get_list_meta</span><span class="p">(</span><span class="n">const_file</span><span class="o">=</span><span class="s2">&quot;const_mapred.py&quot;</span><span class="p">,</span><span class="n">path_src</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get list with metadata fields from source file const_mapred.py.</span>
<span class="sd">    </span>
<span class="sd">    Use for debugging.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     const_file : str</span>
<span class="sd">         path to const_mapred file.</span>
<span class="sd">     path_src : str</span>
<span class="sd">         path to location of source file const_mapred.py.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     line_st_v : list of str</span>
<span class="sd">         all metadata fields (without INDEX_).</span>
<span class="sd">     </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">     Hardcoded values based on const_mapred.py, use only for debugging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">const_file</span> <span class="o">=</span> <span class="n">path_src</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">const_file</span>
    <span class="n">mode_read</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">line_st_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">filter_str</span><span class="o">=</span><span class="s2">&quot;INDEX_&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">const_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">line_counter</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line_st</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">filter_str</span> <span class="ow">in</span> <span class="n">line_st</span> <span class="ow">and</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">mode_read</span><span class="o">=</span><span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">filter_str</span> <span class="ow">in</span> <span class="n">line_st</span> <span class="ow">and</span> <span class="n">mode_read</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;[&quot;</span> <span class="ow">in</span> <span class="n">line_st</span><span class="p">:</span>
                    <span class="n">line_st</span><span class="o">=</span><span class="n">line_st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">line_st</span><span class="p">:</span>
                    <span class="n">line_st</span><span class="o">=</span><span class="n">line_st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;]&quot;</span> <span class="ow">in</span> <span class="n">line_st</span><span class="p">:</span>
                    <span class="n">line_st</span><span class="o">=</span><span class="n">line_st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">line_st</span><span class="o">=</span><span class="n">line_st</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;INDEX_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">line_st_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line_st</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">filter_str</span> <span class="ow">in</span> <span class="n">line_st</span> <span class="ow">and</span> <span class="s2">&quot;]&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">mode_read</span><span class="o">=</span><span class="mi">0</span>
                
    <span class="k">return</span><span class="p">(</span><span class="n">line_st_v</span><span class="p">)</span></div>
      
    
    
<div class="viewcode-block" id="show_line_cx"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.show_line_cx">[docs]</a><span class="k">def</span> <span class="nf">show_line_cx</span><span class="p">(</span><span class="n">file_in</span><span class="p">,</span><span class="n">line_start</span><span class="p">,</span><span class="n">line_count</span><span class="p">,</span><span class="n">filter_line</span><span class="o">=</span><span class="s2">&quot;px&quot;</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">path_src</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display metadata fields and number of coefficients in the visibilities. </span>
<span class="sd">    </span>
<span class="sd">    Use for debugging.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     file_in : str</span>
<span class="sd">         path to CX file.</span>
<span class="sd">     line_start : int</span>
<span class="sd">         first line to read.</span>
<span class="sd">     line_count : int</span>
<span class="sd">         number of lines to read (-1 for no limit).</span>
<span class="sd">     filter_line : str</span>
<span class="sd">         pattern to filter lines (exact match at line start) to be displayed.</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     path_src : str</span>
<span class="sd">         path to location of source file const_mapred.py.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     results : list of [str,list of float]</span>
<span class="sd">         keys and the associated visibilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">const_file</span><span class="o">=</span><span class="s2">&quot;const_mapred.py&quot;</span>
    <span class="n">ljust_len</span><span class="o">=</span><span class="mi">25</span>
    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cx2d configuration:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">19</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CX_IMPORT_CONST_MAPRED: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljust_len</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">CX_IMPORT_CONST_MAPRED</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CX_OVERRIDE_META_LEN: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljust_len</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">CX_OVERRIDE_META_LEN</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;META_LEN:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljust_len</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">META_LEN</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metadata fields from: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljust_len</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">const_file</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lines:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">list_meta</span><span class="o">=</span><span class="n">get_list_meta</span><span class="p">(</span><span class="n">const_file</span><span class="o">=</span><span class="s2">&quot;const_mapred.py&quot;</span><span class="p">,</span><span class="n">path_src</span><span class="o">=</span><span class="n">path_src</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">len_filter_line</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">filter_line</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_in</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">line_counter</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_line</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[:</span><span class="n">len_filter_line</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">line_counter</span><span class="o">&gt;=</span><span class="n">line_start</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">line_counter</span><span class="o">&lt;=</span><span class="n">line_start</span><span class="o">+</span><span class="n">line_count</span> <span class="ow">or</span> <span class="n">line_count</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="c1">#print(line.strip())</span>
                        <span class="p">[</span><span class="n">meta</span><span class="p">,</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_line_correct_tab</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">data_split</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Line id &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljust_len</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">line_counter</span><span class="p">))</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Key: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljust_len</span><span class="p">)</span><span class="o">+</span><span class="n">meta</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list_meta</span><span class="p">)):</span>
                                <span class="nb">print</span><span class="p">((</span><span class="n">list_meta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;: &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljust_len</span><span class="p">)</span><span class="o">+</span><span class="n">data_split</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Num. visibilities: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljust_len</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_split</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">list_meta</span><span class="p">):])))</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">meta</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">complex</span><span class="p">,</span><span class="n">data_split</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">list_meta</span><span class="p">):])))])</span>
                        <span class="n">line_count</span><span class="o">-=</span><span class="mi">1</span>
                <span class="n">line_counter</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">line_count</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
    <span class="k">return</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_error_indicator"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_error_indicator">[docs]</a><span class="k">def</span> <span class="nf">get_error_indicator</span><span class="p">(</span><span class="n">file_vis_1</span><span class="p">,</span><span class="n">file_vis_2</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">path_src</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides the sum of the L2-norm between all pairs of visibilities.</span>
<span class="sd">    Use only for debugging comparing two CorrelX output files (e.g. testing changes).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     file_vis_1 : str</span>
<span class="sd">         path to the reference file with visibilities.</span>
<span class="sd">     file_vis_2 : str</span>
<span class="sd">         path to the test file with visibilities.</span>
<span class="sd">     force : int</span>
<span class="sd">         continue execution even if metadata differ.</span>
<span class="sd">     path_src : str</span>
<span class="sd">         path to location of source file const_mapred.py.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     None</span>
<span class="sd">     </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Assumptions / TO DO**</span>
<span class="sd">    |</span>
<span class="sd">    |    Currently assuming that then number of coefficients does not change for lines in the same file.</span>
<span class="sd">    |    Currently no error checking if forcing execution (e.g. different number lines).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">error_diff</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">acc_res</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">i</span><span class="o">=-</span><span class="mi">1</span>
    <span class="n">jv</span><span class="o">=</span><span class="mi">30</span>
    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; WARNING! Forcing execution even if headers differ!&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; File 1:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span><span class="o">+</span><span class="n">file_vis_1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; File 2:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span><span class="o">+</span><span class="n">file_vis_2</span><span class="p">)</span>

    <span class="n">vis1</span> <span class="o">=</span> <span class="n">show_line_cx</span><span class="p">(</span><span class="n">file_vis_1</span><span class="p">,</span><span class="n">line_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_count</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">path_src</span><span class="o">=</span><span class="n">path_src</span><span class="p">)</span>
    <span class="n">vis2</span> <span class="o">=</span> <span class="n">show_line_cx</span><span class="p">(</span><span class="n">file_vis_2</span><span class="p">,</span><span class="n">line_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">line_count</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">path_src</span><span class="o">=</span><span class="n">path_src</span><span class="p">)</span>
    <span class="n">len_vis1</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vis1</span><span class="p">)</span>
    <span class="n">len_vis2</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vis2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">len_vis1</span><span class="o">!=</span><span class="n">len_vis2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Different number of lines: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">len_vis1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">len_vis2</span><span class="p">))</span>
        <span class="n">error_diff</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vis1</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">error_diff</span><span class="p">):</span>
            <span class="n">meta1</span><span class="o">=</span><span class="n">vis1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">meta2</span><span class="o">=</span><span class="n">vis2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">meta1</span><span class="o">!=</span><span class="n">meta2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; DIFF: Different headers. (Line &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;): &quot;</span><span class="o">+</span><span class="n">meta1</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">meta2</span><span class="p">)</span>
                <span class="n">error_diff</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">len1</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vis1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">len2</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vis2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">len1</span><span class="o">!=</span><span class="n">len2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; DIFF: Different number of coefficients. (Line &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;): &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">len1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">len2</span><span class="p">))</span>
                <span class="n">error_diff</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
                    <span class="k">break</span>
            
            <span class="n">sub</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vis1</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vis2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">acc_res</span><span class="o">+=</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">sub</span><span class="p">)))</span> <span class="c1"># Imaginary part will be zero, do not show warning</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Visibilities compared:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">error_diff</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Num. coefficients per vis.:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">len1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Total error:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">acc_res</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Num. coefficients per vis.:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Total error:&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">jv</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;N/A&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_vis_cx"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.plot_vis_cx">[docs]</a><span class="k">def</span> <span class="nf">plot_vis_cx</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span><span class="n">title_figure</span><span class="p">,</span><span class="n">mode_in</span><span class="o">=</span><span class="s2">&quot;px&quot;</span><span class="p">,</span><span class="n">max_lines</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span><span class="n">interval_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
             <span class="n">interval_end</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">filter_str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic function for plotting output, one plot per band.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     file_input : str</span>
<span class="sd">         path to the visibilities file.</span>
<span class="sd">     title_figure : str</span>
<span class="sd">         prefix for the title of the figures</span>
<span class="sd">     mode_in : str</span>
<span class="sd">         prefix of cx file lines.</span>
<span class="sd">     max_lines : int,optional</span>
<span class="sd">         maximum number of lines to read.</span>
<span class="sd">     interval_start: int,optional</span>
<span class="sd">         first coefficient to plot.</span>
<span class="sd">     interval_end : int,optional</span>
<span class="sd">         last coefficient to plot.</span>
<span class="sd">     filter_str : str,optional</span>
<span class="sd">         filter lines with this string (for example only a certain baseline).</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     N/A</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="c1">#Prepare files</span>
    <span class="n">f_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">)</span>
    
    <span class="c1">#Figure</span>
    
    <span class="n">index_plt</span><span class="o">=</span><span class="mi">3</span>
    <span class="n">it_lines</span><span class="o">=-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f_in</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filter_str</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filter_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">max_lines</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">it_lines</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">it_lines</span><span class="o">==</span><span class="n">max_lines</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">mode_in</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">mode_in</span><span class="p">)]:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">vector</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1">#[&#39;&#39;]</span>
                <span class="k">continue</span>
            
            
            <span class="n">index_plt</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">index_plt</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
            
            <span class="n">yf</span><span class="o">=</span><span class="p">[</span><span class="nb">complex</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vector</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="n">META_LEN</span><span class="p">:]]</span>
            
            <span class="n">freq_sample</span><span class="o">=</span><span class="p">(</span><span class="nb">complex</span><span class="p">(</span><span class="n">vector</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">real</span>
            
            <span class="n">N</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">yf</span><span class="p">)</span>
            
            <span class="n">interval_end_mod</span><span class="o">=</span><span class="n">interval_end</span>
            <span class="k">if</span> <span class="n">interval_end_mod</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">interval_end_mod</span><span class="o">=</span><span class="n">N</span>
            
            <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">interval_start</span><span class="p">,</span><span class="n">interval_end_mod</span><span class="p">))</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">yf</span><span class="p">[</span><span class="n">interval_start</span><span class="p">:</span><span class="n">interval_end_mod</span><span class="p">]),</span><span class="s1">&#39;o-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Magnitude&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">yf</span><span class="p">[</span><span class="n">interval_start</span><span class="p">:</span><span class="n">interval_end_mod</span><span class="p">]),</span><span class="s1">&#39;o-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Phase&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
    
    
            <span class="c1">#Show results</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title_figure</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">key</span><span class="o">+</span><span class="s2">&quot; [&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">interval_start</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span>\
                         <span class="nb">str</span><span class="p">(</span><span class="n">interval_end_mod</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">f_in</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">###########################################</span>
<span class="c1">#          DiFX/SWIN (write)</span>
<span class="c1">###########################################</span>

<div class="viewcode-block" id="compute_baseline_num_swin"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.compute_baseline_num_swin">[docs]</a><span class="k">def</span> <span class="nf">compute_baseline_num_swin</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes two integers with IDs for stations are computes baselines number as 256*([st0]+1)+([st1]+1).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     st0,st1 : int</span>
<span class="sd">         values for station 0 and station 1 starting at zero.</span>
<span class="sd">         </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     baseline_num : int</span>
<span class="sd">         baseline number</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">baseline_num</span> <span class="o">=</span> <span class="mi">256</span><span class="o">*</span><span class="p">(</span><span class="n">st0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">st1</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">baseline_num</span><span class="p">)</span></div>



<div class="viewcode-block" id="sort_swin_records"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.sort_swin_records">[docs]</a><span class="k">def</span> <span class="nf">sort_swin_records</span><span class="p">(</span><span class="n">output_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort SWIN output records.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     output_list :  list of [st0,st1,vis,chan,pol0,pol1,header,values_bytes,diff_st]</span>
<span class="sd">         see convert_cx2d.output_list.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Sorting is as follows:**</span>
<span class="sd">    |</span>
<span class="sd">    |    1. accumulation period</span>
<span class="sd">    |    2. term based on stations ids (see read_cxoutput())</span>
<span class="sd">    |    3. first station of the baseline</span>
<span class="sd">    |    4. second station of the baseline</span>
<span class="sd">    |    5. band</span>
<span class="sd">    |    6. polarization for first station</span>
<span class="sd">    |    7. polarization for second station</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    x[2] duplicated, remove second one </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#  0   1   2   3     4    5    6         7          8</span>
    <span class="c1">#[st0,st1,vis,chan,pol0,pol1,header,values_bytes,diff_st]</span>
    
    <span class="c1">#                                           vis diff_st st0   st1  vis chan pol0 pol1</span>
    <span class="c1">#return(sorted(output_list, key = lambda x: (x[2], x[8], x[0],x[1],x[2],x[3],x[4],x[5])))</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span></div>



<div class="viewcode-block" id="create_header_swin"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.create_header_swin">[docs]</a><span class="k">def</span> <span class="nf">create_header_swin</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">mjd</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span><span class="n">accumulation_period</span><span class="p">,</span><span class="n">polarization_chars_list</span><span class="p">,</span>\
                       <span class="n">source_index</span><span class="o">=</span><span class="n">FORCED_SOURCE_INDEX</span><span class="p">,</span><span class="n">config_index</span><span class="o">=</span><span class="n">FORCED_CONFIG_INDEX</span><span class="p">,</span><span class="n">pulsar_bin</span><span class="o">=</span><span class="n">FORCED_PULSAR_BIN</span><span class="p">,</span>\
                       <span class="n">header_version</span><span class="o">=</span><span class="n">FORCED_HEADER_VERSION</span><span class="p">,</span><span class="n">forced_weight</span><span class="o">=</span><span class="n">FORCED_WEIGHT</span><span class="p">,</span><span class="n">forced_u</span><span class="o">=</span><span class="n">FORCED_U</span><span class="p">,</span><span class="n">forced_v</span><span class="o">=</span><span class="n">FORCED_V</span><span class="p">,</span>\
                       <span class="n">forced_w</span><span class="o">=</span><span class="n">FORCED_W</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Byte representation for one header.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     st0 : int</span>
<span class="sd">         first station in the baseline.</span>
<span class="sd">     st1 : int</span>
<span class="sd">         second station in the baseline.</span>
<span class="sd">     vis : int</span>
<span class="sd">         accumulation period id.</span>
<span class="sd">     chan : int</span>
<span class="sd">         channel id.</span>
<span class="sd">     pol0 : char</span>
<span class="sd">         polarization id for st0.</span>
<span class="sd">     pol1 : char</span>
<span class="sd">         polarization id for st1.</span>
<span class="sd">     mjd : int</span>
<span class="sd">         MJD for this accumulation period.</span>
<span class="sd">     seconds_start : float</span>
<span class="sd">         seconds corresponding to the middle of the first accumulation period.</span>
<span class="sd">     accumulation_period : float</span>
<span class="sd">         duration of the accumulation period in seconds.</span>
<span class="sd">     polarization_chars_list : list of str</span>
<span class="sd">         polarization characters to accessed by id (pol0 and pol1).</span>
<span class="sd">     </span>
<span class="sd">     source_index : int,optional</span>
<span class="sd">         See constants on top of this file.</span>
<span class="sd">     config_index : int,optional</span>
<span class="sd">     pulsar_bin : int,optional</span>
<span class="sd">     header_version : int,optional</span>
<span class="sd">     forced_weight : float,optional</span>
<span class="sd">     forced_u : float,optional</span>
<span class="sd">     forced_v : float,optional</span>
<span class="sd">     forced_w : float,optional</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     header_list : byte array </span>
<span class="sd">         header ready to be written to a file.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    | Optional arguments are replaced by forced values.</span>
<span class="sd">    | Note that secnods start is not at the start of the first accumulation period but at the middle!</span>
<span class="sd">    | Values for st0,st1,vis,chan,pol0,pol1 starting at 0.</span>
<span class="sd">    | </span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Change input floats by double as applicable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Computations</span>
    <span class="n">baseline_num</span> <span class="o">=</span> <span class="n">compute_baseline_num_swin</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">)</span>
    <span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds_start</span><span class="o">+</span><span class="n">accumulation_period</span><span class="o">*</span><span class="n">vis</span>
    
    <span class="c1"># Display tabulated info</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">vis</span>                          <span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">seconds</span>                      <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">accumulation_period</span>          <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">chan</span>                         <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;    &quot;</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">polarization_chars_list</span><span class="p">[</span><span class="n">pol0</span><span class="p">])</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">polarization_chars_list</span><span class="p">[</span><span class="n">pol1</span><span class="p">]))</span>
    

    <span class="n">header_bytes</span> <span class="o">=</span>                  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">FORCED_HEADER_VERSION</span><span class="p">)</span>
    <span class="n">baseline_bytes</span> <span class="o">=</span>                <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">baseline_num</span><span class="p">)</span>
    <span class="n">version_bytes</span> <span class="o">=</span>                 <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">header_version</span><span class="p">)</span>
    <span class="n">mjd_bytes</span> <span class="o">=</span>                     <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">mjd</span><span class="p">)</span>
    <span class="n">seconds_bytes</span> <span class="o">=</span>                 <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_DOUBLE</span><span class="p">,</span><span class="n">seconds</span><span class="p">)</span>
    <span class="n">config_index_bytes</span> <span class="o">=</span>            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">config_index</span><span class="p">)</span>
    <span class="n">source_index_bytes</span> <span class="o">=</span>            <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">source_index</span><span class="p">)</span>
    <span class="n">freq_index_bytes</span> <span class="o">=</span>              <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">chan</span><span class="p">)</span>
    

    <span class="c1">#if ENABLE_PLOTTING:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Python3</span>
        <span class="n">polarization_pair_bytes</span> <span class="o">=</span>   <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_CHAR</span><span class="p">,</span>  <span class="nb">bytes</span><span class="p">(</span><span class="n">polarization_chars_list</span><span class="p">[</span><span class="n">pol0</span><span class="p">],</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="n">polarization_pair_bytes</span> <span class="o">+=</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_CHAR</span><span class="p">,</span>  <span class="nb">bytes</span><span class="p">(</span><span class="n">polarization_chars_list</span><span class="p">[</span><span class="n">pol1</span><span class="p">],</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Python2</span>
        <span class="n">polarization_pair_bytes</span> <span class="o">=</span>   <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_CHAR</span><span class="p">,</span>  <span class="n">polarization_chars_list</span><span class="p">[</span><span class="n">pol0</span><span class="p">])</span>
        <span class="n">polarization_pair_bytes</span> <span class="o">+=</span>  <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_CHAR</span><span class="p">,</span>  <span class="n">polarization_chars_list</span><span class="p">[</span><span class="n">pol1</span><span class="p">])</span>

    
    <span class="n">pulsar_bin_bytes</span> <span class="o">=</span>              <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">pulsar_bin</span><span class="p">)</span>
    <span class="n">forced_weight_bytes</span> <span class="o">=</span>           <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_DOUBLE</span><span class="p">,</span><span class="n">forced_weight</span><span class="p">)</span>
    <span class="n">forced_u_bytes</span> <span class="o">=</span>                <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_DOUBLE</span><span class="p">,</span><span class="n">forced_u</span><span class="p">)</span>
    <span class="n">forced_v_bytes</span> <span class="o">=</span>                <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_DOUBLE</span><span class="p">,</span><span class="n">forced_v</span><span class="p">)</span>
    <span class="n">forced_w_bytes</span> <span class="o">=</span>                <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_DOUBLE</span><span class="p">,</span><span class="n">forced_w</span><span class="p">)</span>
    
    
    <span class="c1"># Header elements</span>
    <span class="n">header_list</span> <span class="o">=</span>  <span class="sa">b</span><span class="s1">&#39;&#39;</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">SYNC_WORD</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">version_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">baseline_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">mjd_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">seconds_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">config_index_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">source_index_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">freq_index_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">polarization_pair_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">pulsar_bin_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">forced_weight_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">forced_u_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">forced_v_bytes</span>
    <span class="n">header_list</span> <span class="o">+=</span> <span class="n">forced_w_bytes</span>
    

    <span class="k">return</span><span class="p">(</span><span class="n">header_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_bytes_list_visibilities_swin"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.create_bytes_list_visibilities_swin">[docs]</a><span class="k">def</span> <span class="nf">create_bytes_list_visibilities_swin</span><span class="p">(</span><span class="n">data_complex_list</span><span class="p">,</span><span class="n">only_half</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">duplicate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">divide_vis_by</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">conjugate_vis_values</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate binary representation for one set of visibilities.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     data_complex_list : 1D numpy arrayof complex</span>
<span class="sd">         visibilities (components from 0 to N-1).</span>
<span class="sd">     </span>
<span class="sd">     only_half : optional,testing</span>
<span class="sd">         if 1 takes components [0,N/2-1], if 2 it takes [N/2,N-1].</span>
<span class="sd">     duplicate : optional,testing</span>
<span class="sd">         duplicate components [consider removing].</span>
<span class="sd">     divide_vis_by : optional,testing</span>
<span class="sd">         divide all coefficients by this value.</span>
<span class="sd">     conjugate_vis_values : optional,testing</span>
<span class="sd">         conjugate all visibilities.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     header_list : byte array</span>
<span class="sd">         visibilities ready to be written to a file.</span>
<span class="sd">     </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Consider removing duplicate.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    
    <span class="n">N</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data_complex_list</span><span class="p">)</span>
    <span class="n">values_list</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;&#39;</span>
    
    <span class="c1"># For old files with FFT not double of FFT in configuration...</span>
    <span class="c1"># Will duplicate first half of the samples to extend up to the FFT size</span>
    <span class="k">if</span> <span class="n">only_half</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">data_complex_list</span><span class="o">=</span><span class="n">data_complex_list</span><span class="p">[:(</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">only_half</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">data_complex_list</span><span class="o">=</span><span class="n">data_complex_list</span><span class="p">[(</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">):]</span>
        
    <span class="c1">#plt.plot([i.real for i in data_complex_list])</span>
    <span class="n">data_complex_list</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">data_complex_list</span><span class="p">,</span><span class="n">divide_vis_by</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">conjugate_vis_values</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">data_complex_list</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">data_complex_list</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data_complex_list</span><span class="p">:</span>
        <span class="n">values_list</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_FLOAT</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        <span class="n">values_list</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_FLOAT</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">duplicate</span><span class="p">:</span>
            <span class="n">values_list</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_FLOAT</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
            <span class="n">values_list</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">END_SWIN_FLOAT</span><span class="p">,</span><span class="n">i</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">values_list</span><span class="p">)</span></div>


<span class="c1">###########################################</span>
<span class="c1">#          DiFX/SWIN (read)</span>
<span class="c1">###########################################</span>

<div class="viewcode-block" id="compute_stations_num_swin"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.compute_stations_num_swin">[docs]</a><span class="k">def</span> <span class="nf">compute_stations_num_swin</span><span class="p">(</span><span class="n">baseline_num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns two integers with IDs for station based on SWIN header baseline number.</span>
<span class="sd">    See compute_baseline_num_swin().</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">     Values for st0 and st1 starting at zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">st0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">baseline_num</span><span class="o">//</span><span class="mi">256</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">st1</span> <span class="o">=</span> <span class="n">baseline_num</span> <span class="o">-</span> <span class="p">(</span><span class="n">st0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">256</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span><span class="p">([</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">])</span></div>


<div class="viewcode-block" id="read_bytes_from_file"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.read_bytes_from_file">[docs]</a><span class="k">def</span> <span class="nf">read_bytes_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">n_values</span><span class="p">,</span><span class="n">read_type</span><span class="o">=</span><span class="s2">&quot;bytes&quot;</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read groups of one or four bytes from a binary file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     f : handlder to binary file (&#39;rb&#39;)</span>
<span class="sd">         binary file to read from.</span>
<span class="sd">     n_values : int</span>
<span class="sd">         number of groups to read.</span>
<span class="sd">     read_type : { &quot;bytes&quot; , &quot;floats&quot; }</span>
<span class="sd">         &quot;bytes&quot; to read unsigned integer 8 bits, &quot;floats&quot; to read unsigned integer 32 bits.</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     words_array : numpy array of unsigned int of 8 or 32 bits (as configured in read_type).</span>
<span class="sd">         read bytes.</span>
<span class="sd">     </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Change notation for floats.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">words_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#words_array.fromfile(f,n_words)</span>
        <span class="k">if</span> <span class="n">read_type</span><span class="o">==</span><span class="s2">&quot;floats&quot;</span><span class="p">:</span>
            <span class="n">words_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">n_values</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">words_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">n_values</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
        <span class="k">return</span><span class="p">([])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">words_array</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_int_from_header"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_int_from_header">[docs]</a><span class="k">def</span> <span class="nf">get_int_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read integer from a np.uint8 array (header) starting at position i. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>       <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">END_SWIN_INT</span><span class="p">,</span>   <span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">NUM_BYTES_SWIN_INT</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]))</span></div>

<div class="viewcode-block" id="get_double_from_header"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_double_from_header">[docs]</a><span class="k">def</span> <span class="nf">get_double_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read double from a np.uint8 array (header) starting at position i.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">END_SWIN_DOUBLE</span><span class="p">,</span><span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">NUM_BYTES_SWIN_DOUBLE</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]))</span></div>

<div class="viewcode-block" id="get_char_from_header"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_char_from_header">[docs]</a><span class="k">def</span> <span class="nf">get_char_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read char from a np.uint8 array (header) starting at position i.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>       <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">END_SWIN_CHAR</span><span class="p">,</span>  <span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="get_float_from_header"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_float_from_header">[docs]</a><span class="k">def</span> <span class="nf">get_float_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read float from a np.uint8 array (header) starting at position i.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>     <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">END_SWIN_FLOAT</span><span class="p">,</span>  <span class="n">header</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">NUM_BYTES_SWIN_FLOAT</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]))</span></div>


<div class="viewcode-block" id="read_doutput"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.read_doutput">[docs]</a><span class="k">def</span> <span class="nf">read_doutput</span><span class="p">(</span><span class="n">doutput_file</span><span class="p">,</span><span class="n">complex_vector_length</span><span class="p">,</span><span class="n">vis_limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">filter_bands</span><span class="o">=</span><span class="p">[],</span><span class="n">filter_pols</span><span class="o">=</span><span class="p">[],</span><span class="n">filter_seconds</span><span class="o">=</span><span class="p">[],</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                 <span class="n">interval_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">interval_end</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot visibilities from a SWIN file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     doutput_file : str</span>
<span class="sd">         path to SWIN file.</span>
<span class="sd">     complex_vector_length : int</span>
<span class="sd">         number of coefficients in the visibilities.</span>
<span class="sd">     </span>
<span class="sd">     vis_limit : int, optional</span>
<span class="sd">         number of visibilities to read (-1 for no limit).</span>
<span class="sd">     filter_bands : list of int, optional</span>
<span class="sd">         band ids to include ([] to include all). E.g.: [0,1]</span>
<span class="sd">     filter_pols : list of str, optional</span>
<span class="sd">         band ids to include ([] to include all). E.g.: [&quot;LR&quot;,&quot;RL&quot;]</span>
<span class="sd">     filter_seconds : list of ints, optional</span>
<span class="sd">         band ids to include ([] to include all). E.g.: [&quot;0.16&quot;,&quot;0.48&quot;]</span>
<span class="sd">     v : int, optional</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     N/A</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Configuration:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Constant ENABLE_PLOTTING=1 to display plots.</span>
<span class="sd">    |</span>
<span class="sd">    |</span>
<span class="sd">    | **Notes:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Visbilities are displayed into two figures: magnitude and phase.</span>
<span class="sd">    |</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Add checks for header.</span>
<span class="sd">    |    Consider automating the computation of complex_vector_length.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">doutput_file</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        
        <span class="n">continue_reading</span> <span class="o">=</span><span class="mi">1</span>
        <span class="n">visibilities_v</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">while</span> <span class="n">continue_reading</span><span class="p">:</span>
            
            <span class="n">header</span> <span class="o">=</span>             <span class="n">read_bytes_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span>       <span class="n">NUM_BYTES_SWIN_HEADER</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">header</span> <span class="o">!=</span> <span class="p">[])</span><span class="ow">and</span><span class="p">(</span><span class="n">vis_limit</span><span class="o">!=</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">sync_word</span> <span class="o">=</span>                           <span class="n">header</span><span class="p">[</span><span class="n">POS_SWIN_SYNC</span><span class="p">:</span><span class="n">NUM_BYTES_SWIN_SYNC</span><span class="p">]</span>
                <span class="n">header_version</span> <span class="o">=</span> <span class="n">get_int_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>   <span class="n">POS_SWIN_VERSION</span><span class="p">)</span>
                <span class="n">baseline_num</span> <span class="o">=</span>   <span class="n">get_int_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>   <span class="n">POS_SWIN_BASELINE</span><span class="p">)</span>
                <span class="n">mjd</span> <span class="o">=</span>            <span class="n">get_int_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>   <span class="n">POS_SWIN_MJD</span><span class="p">)</span>
                <span class="n">seconds</span> <span class="o">=</span>        <span class="n">get_double_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">POS_SWIN_SECONDS</span><span class="p">)</span>
                <span class="n">config_index</span> <span class="o">=</span>   <span class="n">get_int_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>   <span class="n">POS_SWIN_CONFIG</span><span class="p">)</span>
                <span class="n">source_index</span> <span class="o">=</span>   <span class="n">get_int_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>   <span class="n">POS_SWIN_SOURCE</span><span class="p">)</span>
                <span class="n">freq_index</span> <span class="o">=</span>     <span class="n">get_int_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>   <span class="n">POS_SWIN_FREQ</span><span class="p">)</span>
                <span class="n">pol0</span> <span class="o">=</span>           <span class="n">get_char_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>  <span class="n">POS_SWIN_POL0</span><span class="p">)</span>
                <span class="n">pol1</span> <span class="o">=</span>           <span class="n">get_char_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>  <span class="n">POS_SWIN_POL1</span><span class="p">)</span>
                <span class="n">pulsar_bin</span> <span class="o">=</span>     <span class="n">get_int_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span>   <span class="n">POS_SWIN_PULSAR</span><span class="p">)</span>
                <span class="n">data_weight</span> <span class="o">=</span>    <span class="n">get_double_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">POS_SWIN_WEIGHT</span><span class="p">)</span>
                <span class="n">u_meters</span> <span class="o">=</span>       <span class="n">get_double_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">POS_SWIN_U</span><span class="p">)</span>
                <span class="n">v_meters</span> <span class="o">=</span>       <span class="n">get_double_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">POS_SWIN_V</span><span class="p">)</span>
                <span class="n">w_meters</span> <span class="o">=</span>       <span class="n">get_double_from_header</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">POS_SWIN_W</span><span class="p">)</span>
                
                <span class="p">[</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_stations_num_swin</span><span class="p">(</span><span class="n">baseline_num</span><span class="p">)</span>
                <span class="n">identifier</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">source_index</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; dx-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">pol0</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="n">pol1</span><span class="o">+</span><span class="s2">&quot;-a&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span><span class="o">+</span>\
                                 <span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">freq_index</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">header_version</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">baseline_num</span>  <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">mjd</span>           <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">seconds</span>       <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">config_index</span>  <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">freq_index</span>    <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">pol0</span>          <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">pol1</span>          <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">pulsar_bin</span>    <span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span>\
                          <span class="nb">str</span><span class="p">(</span><span class="n">sync_word</span>     <span class="p">))</span>
                          
                    
                <span class="n">visibilities</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">data_vis</span> <span class="o">=</span> <span class="n">read_bytes_from_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">complex_vector_length</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">complex_vector_length</span><span class="p">):</span>
                    <span class="n">re_part</span> <span class="o">=</span> <span class="n">get_float_from_header</span><span class="p">(</span><span class="n">data_vis</span><span class="p">,</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
                    <span class="n">im_part</span> <span class="o">=</span> <span class="n">get_float_from_header</span><span class="p">(</span><span class="n">data_vis</span><span class="p">,</span><span class="mi">4</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
                    <span class="n">visibilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re_part</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">im_part</span><span class="p">)</span>
                
                <span class="c1">#print(visibilities)</span>
                <span class="n">visibilities_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">visibilities</span><span class="p">)</span>
                
                <span class="n">id_explain</span><span class="o">=</span><span class="s2">&quot;src&lt;src&gt; dx-&lt;st0&gt;.&lt;pol0&gt;-&lt;st1&gt;.&lt;pol1&gt;-a&lt;seconds&gt;.&lt;freq_index&gt;&quot;</span>
                <span class="n">float_seconds</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">filter_bands</span><span class="o">!=</span><span class="p">[])</span><span class="ow">and</span><span class="p">(</span><span class="n">freq_index</span> <span class="ow">in</span> <span class="n">filter_bands</span><span class="p">))</span><span class="ow">or</span><span class="p">(</span><span class="n">filter_bands</span><span class="o">==</span><span class="p">[]):</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">pol0</span><span class="o">+</span><span class="n">pol1</span><span class="p">)</span> <span class="ow">in</span> <span class="n">filter_pols</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filter_pols</span><span class="o">==</span><span class="p">[]:</span>
                        <span class="k">if</span> <span class="p">((</span><span class="n">filter_seconds</span><span class="o">!=</span><span class="p">[])</span><span class="ow">and</span><span class="p">(</span><span class="n">seconds</span> <span class="ow">in</span> <span class="n">filter_seconds</span><span class="p">))</span><span class="ow">or</span><span class="p">(</span><span class="n">filter_seconds</span><span class="o">==</span><span class="p">[]):</span>
                            <span class="k">if</span> <span class="n">vis_limit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">vis_limit</span><span class="o">-=</span><span class="mi">1</span>
                            <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">ENABLE_PLOTTING</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>   <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visibilities</span><span class="p">[</span><span class="n">interval_start</span><span class="p">:</span><span class="n">interval_end</span><span class="p">]],</span><span class="n">label</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visibilities</span><span class="p">[</span><span class="n">interval_start</span><span class="p">:</span><span class="n">interval_end</span><span class="p">]],</span><span class="n">label</span><span class="o">=</span><span class="n">identifier</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: plotting disabled in cx2d_lib&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ENABLE_PLOTTING</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Magnitude&quot;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Phase&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vis_limit</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reached requested limit&quot;</span><span class="p">)</span>
                <span class="n">continue_reading</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">ENABLE_PLOTTING</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">legendfig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">id_explain</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span></div>
            
<span class="c1">###########################################</span>
<span class="c1">#   Processing zoombands: CX -&gt; CX_zoomed</span>
<span class="c1">###########################################  </span>


<div class="viewcode-block" id="get_pos_in_fft"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_pos_in_fft">[docs]</a><span class="k">def</span> <span class="nf">get_pos_in_fft</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">fz</span><span class="p">,</span><span class="n">fft_size</span><span class="p">,</span><span class="n">bw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the coefficient corresponding to a certain frequency in the visibilities.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     f : float</span>
<span class="sd">         lower edge frequency of the band.</span>
<span class="sd">     fz : float</span>
<span class="sd">         frequency between f and f+bw (which associated coefficient is to be found).</span>
<span class="sd">     fft_size : int</span>
<span class="sd">         number of coefficients of the visibilities.</span>
<span class="sd">     bw : float</span>
<span class="sd">         bandwidth of the full band.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     output : int</span>
<span class="sd">         position of the first coefficient.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    LSB/USB.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">int</span><span class="p">(((</span><span class="n">fft_size</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">fz</span><span class="o">-</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="n">bw</span><span class="p">)</span><span class="o">//</span><span class="mi">1</span><span class="p">))</span></div>
    <span class="c1">#return(int((fft_size//2)+((fft_size//2)*float(fz-f)/bw)//1))</span>


<div class="viewcode-block" id="get_zoom_list"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_zoom_list">[docs]</a><span class="k">def</span> <span class="nf">get_zoom_list</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">params_array_corr</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">average_channels</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the information required to process the zoom bands.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     params_array_media : list</span>
<span class="sd">         list with media configuration (see lib_ini_files.py).</span>
<span class="sd">     params_array_corr : list</span>
<span class="sd">         list with correlation configuration (see lib_ini_files.py).</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     average_channels : int</span>
<span class="sd">         number of coefficients that are average into one (here only used for reporting).</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     z_list : list</span>
<span class="sd">         list of elements [band_id, first_sample_fft, last_sample_fft, new_band_id] where:</span>
<span class="sd">                      |  band_id:           id of the processed band.</span>
<span class="sd">                      |  first_sample_fft:  position of the first element of the zoom in the full fft.</span>
<span class="sd">                      |  last_sample_fft:   position of the last element of the zoom in the full fft.</span>
<span class="sd">                      |  new_band_id:       id of the newly created band (zoom).</span>
<span class="sd">     </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Assumptions:**</span>
<span class="sd">    |</span>
<span class="sd">    |    It is assumed that a channel has only one associated sideband (this is checked when computing the</span>
<span class="sd">    |      limits of the band, if lower sideband the upper edge is given.</span>
<span class="sd">    |    It is assumed that zoom bands are always upper side band.</span>
<span class="sd">    |</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    LSB/USB for zoom band definitions...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">str_megahz</span><span class="o">=</span><span class="s2">&quot; MHz&quot;</span>
    <span class="n">ljustid</span><span class="o">=</span><span class="mi">7</span>
    <span class="n">ljustz</span><span class="o">=</span><span class="mi">15</span>
    
    <span class="c1"># Lower edges for zoom frequency windows</span>
    <span class="n">zoom_freq_v</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">//</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">get_param_eq_vector</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_ZOOM_POST</span><span class="p">,</span>\
                                                                   <span class="n">C_INI_MEDIA_ZP_FREQ</span><span class="p">,</span><span class="n">modein</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">)]</span>
    <span class="c1"># Bandwidths for zoom frequency windows</span>
    <span class="n">zoom_bw_v</span><span class="o">=</span>  <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">//</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">get_param_eq_vector</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_ZOOM_POST</span><span class="p">,</span>\
                                                                   <span class="n">C_INI_MEDIA_ZP_BW</span><span class="p">,</span><span class="n">modein</span><span class="o">=</span><span class="s2">&quot;str&quot;</span><span class="p">)]</span>
    <span class="c1"># Upper edges for zoom frequency windows</span>
    <span class="n">zoom_freq_v_e</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">zoom_freq_v</span><span class="p">,</span><span class="n">zoom_bw_v</span><span class="p">))</span>
    
    
    <span class="n">file_list</span><span class="o">=</span><span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_S_FILES</span><span class="p">,</span><span class="n">C_INI_MEDIA_LIST</span><span class="p">)</span>
    <span class="n">channels_asoc_vector</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sideband_asoc_vector</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="n">channels_asoc_vector</span><span class="o">+=</span><span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">fi</span><span class="p">,</span><span class="n">C_INI_MEDIA_CHANNELS</span><span class="p">)]</span>
        <span class="n">sideband_asoc_vector</span><span class="o">+=</span><span class="p">[</span><span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">fi</span><span class="p">,</span><span class="n">C_INI_MEDIA_SIDEBANDS</span><span class="p">)]</span>

    <span class="c1"># Set of channels</span>
    <span class="n">channels_set_v</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">channels_asoc_vector</span><span class="p">))</span>
    <span class="c1"># Sidebands associated to those channels</span>
    <span class="n">sideband_set_v</span><span class="o">=</span><span class="p">[</span><span class="n">sideband_asoc_vector</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> \
                      <span class="p">[</span><span class="n">channels_asoc_vector</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">channels_set_v</span><span class="p">]]</span>
    <span class="n">sideband_mult</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sideband_set_v</span><span class="p">]</span>
    
    <span class="c1"># Edges for full bands</span>
    <span class="n">freq_v</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">get_param_serial</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_FREQUENCIES</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">//</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">channels_set_v</span><span class="p">]</span>
    
    <span class="c1"># Bandwidths for full bands</span>
    <span class="n">bw_v</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">get_param_serial</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_BANDWIDTHS</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="o">//</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">channels_set_v</span><span class="p">]</span>
    
    <span class="c1"># Lower edges for full bands (subtract BW to edge if LSB)</span>
    <span class="n">freq_v</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">z</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">freq_v</span><span class="p">,</span><span class="n">bw_v</span><span class="p">,</span><span class="n">sideband_mult</span><span class="p">)]</span>
    

    <span class="c1"># Upper edges for full bands</span>
    <span class="n">freq_v_e</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">freq_v</span><span class="p">,</span><span class="n">bw_v</span><span class="p">))</span>
    
    

    <span class="c1"># Number of coefficients in full band</span>
    <span class="n">fft_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_param_serial</span><span class="p">(</span><span class="n">params_array_corr</span><span class="p">,</span><span class="n">C_INI_CR_S_COMP</span><span class="p">,</span><span class="n">C_INI_CR_FFT</span><span class="p">))</span>
    
    <span class="c1"># Number of bands</span>
    <span class="n">all_channels</span> <span class="o">=</span> <span class="n">get_all_params_serial</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_FREQUENCIES</span><span class="p">)</span>
    <span class="n">tot_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_channels</span><span class="p">)</span>
    <span class="n">first_index_zoom</span> <span class="o">=</span> <span class="n">tot_channels</span>
    
    <span class="c1"># For every zoom window, iterate on all bands, and if the zoom window corresponds to the band, store the required info</span>
    <span class="n">z_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">index_zoom</span> <span class="o">=</span> <span class="n">first_index_zoom</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">zoom_freq_v</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">zoom_freq_v_e</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">channels_asoc_vector</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">channels_set_v</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">freq_v</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">freq_v_e</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">bw_v</span><span class="p">)</span>
    
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Band&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustid</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;Zoom&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustid</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;Band BW&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;Zoom BW&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;Band fft&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;Zoom fft&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;Zoom avg fft&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;Band freq&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;Zoom freq&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i_z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">zoom_freq_v</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">i_f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freq_v</span><span class="p">)):</span>
            <span class="n">z_item</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">zoom_freq_v</span><span class="p">[</span><span class="n">i_z</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">freq_v</span><span class="p">[</span><span class="n">i_f</span><span class="p">]</span> <span class="ow">and</span> <span class="n">zoom_freq_v_e</span><span class="p">[</span><span class="n">i_z</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">freq_v_e</span><span class="p">[</span><span class="n">i_f</span><span class="p">]:</span>
                
                <span class="c1"># Zoom positions</span>
                <span class="n">zoom_start</span><span class="o">=</span><span class="n">get_pos_in_fft</span><span class="p">(</span><span class="n">freq_v</span><span class="p">[</span><span class="n">i_f</span><span class="p">],</span><span class="n">zoom_freq_v</span><span class="p">[</span><span class="n">i_z</span><span class="p">],</span>  <span class="n">fft_size</span><span class="p">,</span><span class="n">bw_v</span><span class="p">[</span><span class="n">i_f</span><span class="p">])</span>
                <span class="n">zoom_end</span><span class="o">=</span>  <span class="n">get_pos_in_fft</span><span class="p">(</span><span class="n">freq_v</span><span class="p">[</span><span class="n">i_f</span><span class="p">],</span><span class="n">zoom_freq_v_e</span><span class="p">[</span><span class="n">i_z</span><span class="p">],</span><span class="n">fft_size</span><span class="p">,</span><span class="n">bw_v</span><span class="p">[</span><span class="n">i_f</span><span class="p">])</span>
                
                <span class="c1"># Display zoom band info</span>
                <span class="n">zoom_bw_str</span><span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">zoom_freq_v_e</span><span class="p">[</span><span class="n">i_z</span><span class="p">]</span><span class="o">-</span><span class="n">zoom_freq_v</span><span class="p">[</span><span class="n">i_z</span><span class="p">])</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span><span class="o">+</span><span class="n">str_megahz</span>
                <span class="n">zoom_len_str</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">zoom_end</span><span class="o">-</span><span class="n">zoom_start</span><span class="p">)</span>
                <span class="n">zoom_avg_str</span><span class="o">=</span><span class="n">zoom_len_str</span>
                <span class="k">if</span> <span class="n">average_channels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">zoom_avg_str</span><span class="o">=</span><span class="nb">str</span><span class="p">((</span><span class="n">zoom_end</span><span class="o">-</span><span class="n">zoom_start</span><span class="p">)</span><span class="o">//</span><span class="n">average_channels</span><span class="p">)</span>
                <span class="n">bw_str</span><span class="o">=</span>      <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bw_v</span><span class="p">[</span><span class="n">i_f</span><span class="p">]</span>                          <span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span><span class="o">+</span><span class="n">str_megahz</span>
                <span class="n">freq_str</span><span class="o">=</span>    <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">freq_v</span><span class="p">[</span><span class="n">i_f</span><span class="p">]</span>                        <span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span><span class="o">+</span><span class="n">str_megahz</span>
                <span class="n">freq_z_str</span><span class="o">=</span>  <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">zoom_freq_v</span><span class="p">[</span><span class="n">i_z</span><span class="p">]</span>                   <span class="p">)</span><span class="o">/</span><span class="mf">1e6</span><span class="p">)</span><span class="o">+</span><span class="n">str_megahz</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i_f</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustid</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">index_zoom</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustid</span><span class="p">)</span><span class="o">+</span>\
                      <span class="n">bw_str</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
                      <span class="n">zoom_bw_str</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
                      <span class="nb">str</span><span class="p">(</span><span class="n">fft_size</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
                      <span class="n">zoom_len_str</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
                      <span class="n">zoom_avg_str</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
                      <span class="n">freq_str</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">)</span><span class="o">+</span>\
                      <span class="n">freq_z_str</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljustz</span><span class="p">))</span>

                <span class="c1"># Create output list element</span>
                <span class="n">z_item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_channels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">channels_set_v</span><span class="p">[</span><span class="n">i_f</span><span class="p">]))</span>
                <span class="n">z_item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zoom_start</span><span class="p">)</span>
                <span class="n">z_item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zoom_end</span><span class="p">)</span>
                <span class="n">z_item</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_zoom</span><span class="p">)</span>
                <span class="n">index_zoom</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">z_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z_item</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">z_list</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">z_list</span><span class="p">)</span></div>




<div class="viewcode-block" id="replace_channel_in_key"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.replace_channel_in_key">[docs]</a><span class="k">def</span> <span class="nf">replace_channel_in_key</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="n">new_band_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace the band id in the CX header key.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     meta : str</span>
<span class="sd">         CX line header.</span>
<span class="sd">     new_band_id : int</span>
<span class="sd">         id for the new (zoom) band.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     new_meta : str</span>
<span class="sd">         new CX line header.</span>
<span class="sd">     </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Configuration:**</span>
<span class="sd">    |</span>
<span class="sd">    |    INDEX_KEY_CHANNEL: const_mapred.py (location of the channel id in the key (SF_SEP), to be replaced by new channel id [zoom])</span>
<span class="sd">    |</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Create general funcionts to create and read key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">meta_split</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">SF_SEP</span><span class="p">)</span>
    <span class="n">new_meta</span> <span class="o">=</span> <span class="n">SF_SEP</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meta_split</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">INDEX_KEY_CHANNEL</span><span class="p">])</span><span class="o">+</span><span class="n">SF_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">new_band_id</span><span class="p">)</span><span class="o">+</span>\
                    <span class="n">FIELD_SEP</span><span class="o">+</span><span class="n">meta_split</span><span class="p">[</span><span class="n">INDEX_KEY_CHANNEL</span><span class="p">:][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">FIELD_SEP</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">new_meta</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_zoom_band"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.process_zoom_band">[docs]</a><span class="k">def</span> <span class="nf">process_zoom_band</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_in</span><span class="p">,</span><span class="n">file_out</span><span class="p">,</span><span class="n">correlation_ini_file</span><span class="o">=</span><span class="s2">&quot;correlation.ini&quot;</span><span class="p">,</span><span class="n">media_ini_file</span><span class="o">=</span><span class="s2">&quot;media.ini&quot;</span><span class="p">,</span>\
                      <span class="n">stations_ini_file</span><span class="o">=</span><span class="s2">&quot;stations.ini&quot;</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">average_channels</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">filter_acc_periods</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a new CX file with the zoom bands from an existing CX file with results for the full band.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     inout_folder : str</span>
<span class="sd">         path to folder containing CX file, and where newly created CX_zoom file will be placed.</span>
<span class="sd">     file_in : str</span>
<span class="sd">         CX filename.</span>
<span class="sd">     file_out : str</span>
<span class="sd">         filename for new CX file with zoom bands results.</span>
<span class="sd">     correlation_ini_file : str</span>
<span class="sd">         path to correlation.ini.</span>
<span class="sd">     media_ini_file : str</span>
<span class="sd">         path to media.ini.</span>
<span class="sd">     correlation_ini_file : str</span>
<span class="sd">         path to correlation.ini.</span>
<span class="sd">     stations_ini_file : str</span>
<span class="sd">         path to stations.ini.</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     average_channels : int</span>
<span class="sd">         number of coefficients to average (-1 for no averaging).</span>
<span class="sd">     filter_acc_periods : list of int</span>
<span class="sd">         ids (starting at 0) for accumulation periods to process. Will process all if [].</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     fft_read : int</span>
<span class="sd">         number of coefficients in the last visibilities read from the file.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Assumptions:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Assuming a regular configuration where all the stations have the same zoom bands (i.e.: missmatched bands not suppported).</span>
<span class="sd">    |</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Migrate this functionality into lib_fx_stack.py so that missmatched band support can be provided.</span>
<span class="sd">    |    &quot;px&quot; harcoded, move to const_mapred.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    
    
    <span class="n">file_in</span> <span class="o">=</span>            <span class="n">inout_folder</span><span class="o">+</span><span class="n">file_in</span>
    <span class="n">file_out</span> <span class="o">=</span>           <span class="n">inout_folder</span><span class="o">+</span><span class="n">file_out</span>
    
    <span class="n">media_ini_file</span><span class="o">=</span>      <span class="n">inout_folder</span><span class="o">+</span><span class="n">media_ini_file</span>
    <span class="n">correlation_ini_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="n">correlation_ini_file</span>
    <span class="n">stations_ini_file</span><span class="o">=</span>   <span class="n">inout_folder</span><span class="o">+</span><span class="n">stations_ini_file</span>
    
    <span class="n">serial_media</span><span class="o">=</span><span class="n">serialize_config</span><span class="p">(</span><span class="n">sources_file</span><span class="o">=</span><span class="n">media_ini_file</span><span class="p">)</span>
    <span class="n">serial_corr</span><span class="o">=</span><span class="n">serialize_config</span><span class="p">(</span><span class="n">sources_file</span><span class="o">=</span><span class="n">correlation_ini_file</span><span class="p">)</span>
    
    <span class="n">params_array_corr</span><span class="o">=</span><span class="n">serial_params_to_array</span><span class="p">(</span><span class="n">serial_corr</span><span class="p">)</span>
    <span class="n">params_array_media</span><span class="o">=</span><span class="n">serial_params_to_array</span><span class="p">(</span><span class="n">serial_media</span><span class="p">)</span>
    
    <span class="n">fft_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_param_serial</span><span class="p">(</span><span class="n">params_array_corr</span><span class="p">,</span><span class="n">C_INI_CR_S_COMP</span><span class="p">,</span><span class="n">C_INI_CR_FFT</span><span class="p">))</span>
    
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing metadata for zoom bands...&quot;</span><span class="p">)</span>
    <span class="n">zoom_list</span> <span class="o">=</span> <span class="n">get_zoom_list</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">params_array_corr</span><span class="p">,</span><span class="n">average_channels</span><span class="o">=</span><span class="n">average_channels</span><span class="p">)</span>
    
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing zoom bands...&quot;</span><span class="p">)</span>
    <span class="n">fft_read</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_in</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_out</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
                
            <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;read&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;fft&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;z_i&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;z_e&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;px&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="p">[</span><span class="n">meta</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">n_bins</span><span class="p">,</span>\
                      <span class="n">pcal_freq</span><span class="p">,</span><span class="n">chan_index</span><span class="p">,</span><span class="n">acc_period</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">predata</span><span class="p">,</span><span class="n">datac</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_line_cx</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">fft_size</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">datac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">filter_acc_periods</span><span class="o">==</span><span class="p">[]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vis</span> <span class="ow">in</span> <span class="n">filter_acc_periods</span><span class="p">)):</span>
    
                            
                            <span class="k">for</span> <span class="n">i_zoom</span> <span class="ow">in</span> <span class="n">zoom_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">i_zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">chan</span><span class="p">:</span>
                                    
                                    <span class="c1"># Update header metadata</span>
                                    <span class="n">new_meta</span> <span class="o">=</span> <span class="n">replace_channel_in_key</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
 
                                    <span class="c1"># Apply zoom for this channel</span>
                                    <span class="n">datazoom</span> <span class="o">=</span> <span class="n">datac</span><span class="p">[</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                                    
                                    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">ENABLE_PLOTTING</span><span class="p">:</span>
                                            <span class="n">zerodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">datac</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                                            <span class="n">zerodata</span><span class="p">[</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span><span class="o">=</span><span class="n">datac</span><span class="p">[</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zerodata</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">meta</span><span class="o">+</span><span class="s2">&quot; (&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
                                   
                                    <span class="k">if</span> <span class="n">average_channels</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                                        <span class="n">dzavg</span><span class="o">=</span><span class="n">datazoom</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">average_channels</span><span class="p">)</span>
                                        <span class="n">datazoom</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">dzavg</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                                    <span class="n">new_line</span> <span class="o">=</span> <span class="n">new_meta</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">predata</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">datazoom</span><span class="p">))</span>
                                    <span class="c1"># TO DO: add space after \t?</span>
                                    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">new_meta</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datac</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datazoom</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i_zoom</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
                    
                                    <span class="nb">print</span><span class="p">(</span><span class="n">new_line</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">f_out</span><span class="p">)</span>
                                    <span class="n">fft_read</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">datac</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping visibilities, not enough coefficients (st&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-st&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,a&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,b&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ENABLE_PLOTTING</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">fft_read</span><span class="p">)</span></div>



<span class="c1">###########################################</span>
<span class="c1">#    Conversion CorrelX/CX -&gt; DiFX/SWIN</span>
<span class="c1">###########################################</span>

<div class="viewcode-block" id="get_difx_filename"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_difx_filename">[docs]</a><span class="k">def</span> <span class="nf">get_difx_filename</span><span class="p">(</span><span class="n">mjd_start</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get filename for SWIN file.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Add missing funcionality for filling DIFX_FILENAME_SUFFIX.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">DIFX_FILENAME_PREFIX</span><span class="o">+</span><span class="n">DIFX_FILENAME_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span>    <span class="n">mjd_start</span><span class="p">)</span><span class="o">+</span>\
                                <span class="n">DIFX_FILENAME_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds_start</span><span class="p">))</span><span class="o">+</span>\
                                <span class="n">DIFX_FILENAME_SUFFIX</span><span class="p">)</span></div>




<div class="viewcode-block" id="convert_cx2d"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.convert_cx2d">[docs]</a><span class="k">def</span> <span class="nf">convert_cx2d</span><span class="p">(</span><span class="n">doutput_file</span><span class="p">,</span><span class="n">cxoutput_file</span><span class="p">,</span><span class="n">correlation_ini_file</span><span class="p">,</span><span class="n">media_ini_file</span><span class="p">,</span><span class="n">forced_pol_list</span><span class="o">=</span><span class="p">[],</span><span class="n">only_half</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                 <span class="n">duplicate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">freq_ids</span><span class="o">=</span><span class="p">[],</span><span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">back_compat</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">forced_accumulation_period</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">divide_vis_by</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
                 <span class="n">conjugate_vis_values</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert visibilities from an output file from CorrelX/CX to DiFX/SWIN format.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     doutput_file : str</span>
<span class="sd">         output file name (will append DIFX_...) for new SWIN file.</span>
<span class="sd">     cxoutput_file : str</span>
<span class="sd">         path to CX file to be converted</span>
<span class="sd">     correlation_ini_file : str</span>
<span class="sd">         path to correlation.ini.</span>
<span class="sd">     media_ini_file : str</span>
<span class="sd">         path to media.ini.</span>
<span class="sd">     </span>
<span class="sd">     forced_pol_list : list of str, optional</span>
<span class="sd">         used to override polarizations in ini file.</span>
<span class="sd">     only_half : optional</span>
<span class="sd">         see create_bytes_list_visibilities_swin().</span>
<span class="sd">     duplicate : optional</span>
<span class="sd">         see create_bytes_list_visibilities_swin().</span>
<span class="sd">     freq_ids : unused</span>
<span class="sd">         [remove]</span>
<span class="sd">     v : int, optional</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     back_compat : int</span>
<span class="sd">         [remove] see notes.</span>
<span class="sd">     forced_accumulation_period : int, optional </span>
<span class="sd">         see create_bytes_list_visibilities_swin().</span>
<span class="sd">     divide_vis_by : int</span>
<span class="sd">         see create_bytes_list_visibilities_swin().</span>
<span class="sd">     conjugate_vis_values : int</span>
<span class="sd">         see create_bytes_list_visibilities_swin().</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     doutput_file : str</span>
<span class="sd">         path to newly created SwIN output file.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    | CX accumulation periods referenced by start time, SWIN by middle time.</span>
<span class="sd">    | It is assumed that all the polarizations [0,1,2,...] (as many as used) are defined in the media.ini file.</span>
<span class="sd">    | </span>
<span class="sd">    | **(!) Limitations:**</span>
<span class="sd">    |</span>
<span class="sd">    |     See limitations on top of this file (forced values...).</span>
<span class="sd">    |</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Remove freq_ids.</span>
<span class="sd">    |    Remove back_compat and add version for CX file header instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Read ini files</span>
    <span class="n">serial_media</span><span class="o">=</span>       <span class="n">serialize_config</span><span class="p">(</span><span class="n">sources_file</span><span class="o">=</span><span class="n">media_ini_file</span><span class="p">)</span>
    <span class="n">serial_correlation</span><span class="o">=</span> <span class="n">serialize_config</span><span class="p">(</span><span class="n">sources_file</span><span class="o">=</span><span class="n">correlation_ini_file</span><span class="p">)</span>
    
    <span class="n">params_array_media</span><span class="o">=</span>       <span class="n">serial_params_to_array</span><span class="p">(</span><span class="n">serial_media</span><span class="p">)</span>
    <span class="n">params_array_correlation</span><span class="o">=</span> <span class="n">serial_params_to_array</span><span class="p">(</span><span class="n">serial_correlation</span><span class="p">)</span>
    
    
    <span class="c1"># Polarizations</span>
    <span class="n">pol_chars</span><span class="o">=</span>          <span class="n">get_all_params_serial</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_S_POLARIZATIONS</span><span class="p">)</span>
    <span class="n">values</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pol_chars</span><span class="p">:</span>
        <span class="n">values</span><span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span>  <span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_S_POLARIZATIONS</span><span class="p">,</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pol_chars</span><span class="p">)</span>
    <span class="n">values</span><span class="p">,</span> <span class="n">pol_chars</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">pol_chars</span><span class="p">)))</span>
    <span class="n">pol_chars</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">pol_chars</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">forced_pol_list</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="n">pol_chars</span><span class="o">=</span><span class="n">forced_pol_list</span>
    
    <span class="c1"># MJD and seconds</span>
    <span class="n">mjd_start</span> <span class="o">=</span>       <span class="nb">int</span><span class="p">(</span><span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_correlation</span><span class="p">,</span><span class="n">C_INI_CR_S_TIMES</span><span class="p">,</span><span class="n">C_INI_CR_MJD</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">seconds_start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_correlation</span><span class="p">,</span><span class="n">C_INI_CR_S_TIMES</span><span class="p">,</span><span class="n">C_INI_CR_START</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#fft_size =        int(get_val_vector(params_array_correlation,C_INI_CR_S_COMP,C_INI_CR_FFT)[0])</span>
    
    <span class="c1"># Accumulation period</span>
    <span class="k">if</span> <span class="n">forced_accumulation_period</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">accumulation_period_str</span> <span class="o">=</span> <span class="p">(</span><span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_correlation</span><span class="p">,</span><span class="n">C_INI_CR_S_COMP</span><span class="p">,</span><span class="n">C_INI_CR_ACC</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">accumulation_period_str</span><span class="p">:</span>
            <span class="n">accumulation_period_split</span> <span class="o">=</span> <span class="n">accumulation_period_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">accumulation_period</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">accumulation_period_split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">accumulation_period_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">accumulation_period</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">accumulation_period_str</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">accumulation_period</span><span class="o">=</span><span class="n">forced_accumulation_period</span>
    
    <span class="c1"># Start time offset (half accumulation period)</span>
    <span class="n">seconds_offset</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">accumulation_period</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">seconds_start</span> <span class="o">+=</span> <span class="nb">float</span><span class="p">(</span><span class="n">seconds_offset</span><span class="p">)</span>


    <span class="c1"># Output file name</span>
    <span class="n">doutput_file</span><span class="o">+=</span><span class="n">get_difx_filename</span><span class="p">(</span><span class="n">mjd_start</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">)</span>

    

    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MJD: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">mjd_start</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Seconds start [s]: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">seconds_start</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accumulation [s]: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">accumulation_period</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Opening &quot;</span> <span class="o">+</span> <span class="n">doutput_file</span> <span class="o">+</span> <span class="s2">&quot; for writing binary swin info&quot;</span><span class="p">)</span>

    <span class="c1"># Read CX file</span>
    <span class="n">list_output</span> <span class="o">=</span> <span class="n">read_cxoutput</span><span class="p">(</span><span class="n">cxoutput_file</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">back_compat</span><span class="p">)</span>
    <span class="n">output_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ac_id&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;ac_s&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;ap&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;chan&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;    &quot;</span><span class="o">+</span><span class="s2">&quot;pol&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create headers, pack data and sort results</span>
    <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">list_output</span><span class="p">:</span>

        
        <span class="p">[</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">datac</span><span class="p">,</span><span class="n">diff_st</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataset</span>
        
        <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Writing data for IDs:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">([</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">])</span>
        
        <span class="c1"># Create header</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">create_header_swin</span><span class="p">(</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">mjd_start</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span>\
                   <span class="n">accumulation_period</span><span class="p">,</span><span class="n">pol_chars</span><span class="p">)</span>

        <span class="c1"># Crate data</span>
        <span class="n">values_bytes</span> <span class="o">=</span> <span class="n">create_bytes_list_visibilities_swin</span><span class="p">(</span><span class="n">datac</span><span class="p">,</span><span class="n">only_half</span><span class="p">,</span><span class="n">duplicate</span><span class="p">,</span><span class="n">divide_vis_by</span><span class="p">,</span><span class="n">conjugate_vis_values</span><span class="p">)</span>
        
        <span class="c1"># Append output list</span>
        <span class="n">output_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">values_bytes</span><span class="p">,</span><span class="n">diff_st</span><span class="p">])</span>

    <span class="c1"># Sort SWIN records</span>
    <span class="n">output_list</span> <span class="o">=</span> <span class="n">sort_swin_records</span><span class="p">(</span><span class="n">output_list</span><span class="p">)</span>
    
    <span class="c1"># Write SWIN file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">doutput_file</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output_item</span> <span class="ow">in</span> <span class="n">output_list</span><span class="p">:</span>
            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_item</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>     <span class="c1"># Write header</span>
            <span class="n">f_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output_item</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>     <span class="c1"># Write visibilities</span>

    <span class="c1"># Display output file name</span>
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">doutput_file</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">doutput_file</span><span class="p">)</span></div>
    




<span class="c1">###########################################</span>
<span class="c1">#    Conversion CorrelX/CX -&gt; DiFX/PCAL</span>
<span class="c1">###########################################</span>


<div class="viewcode-block" id="get_pcal_filename"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_pcal_filename">[docs]</a><span class="k">def</span> <span class="nf">get_pcal_filename</span><span class="p">(</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span><span class="n">station_name_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get filename for PCAL file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seconds_start_fill</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds_start</span><span class="o">//</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">PCAL_FILENAME_SECONDS_ZFILL</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">PCAL_FILENAME_PREFIX</span><span class="o">+</span><span class="n">PCAL_FILENAME_SEP</span><span class="o">+</span><span class="n">mjd_start_str</span><span class="o">+</span>\
                                <span class="n">PCAL_FILENAME_SEP</span><span class="o">+</span><span class="n">seconds_start_fill</span><span class="o">+</span>\
                                <span class="n">PCAL_FILENAME_SEP</span><span class="o">+</span><span class="n">station_name_str</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="get_lines_pcal_header"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_lines_pcal_header">[docs]</a><span class="k">def</span> <span class="nf">get_lines_pcal_header</span><span class="p">(</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start_str</span><span class="p">,</span><span class="n">stations_name_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get header lines for PCAL file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     mjd_start_str : str</span>
<span class="sd">         start MJD for this accumulation period.</span>
<span class="sd">     seconds_start_str: str</span>
<span class="sd">         start seconds for this accumulation period.</span>
<span class="sd">     station_name_str : str</span>
<span class="sd">         name of the station.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     header_pcal_v : list of str</span>
<span class="sd">         lines for the PCAL file header.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header_pcal_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">header_pcal_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PCAL_HEADER_TITLE</span><span class="p">)</span>
    <span class="n">header_pcal_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PCAL_HEADER_VERSION</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">PCAL_HEADER_VERSION_VAL</span><span class="p">))</span>
    <span class="n">header_pcal_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PCAL_HEADER_MJD</span><span class="o">+</span>        <span class="n">mjd_start_str</span><span class="p">)</span>
    <span class="n">header_pcal_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PCAL_HEADER_SECONDS</span><span class="o">+</span>    <span class="n">seconds_start_str</span><span class="p">)</span>
    <span class="n">header_pcal_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">PCAL_HEADER_TELESCOPE</span><span class="o">+</span>  <span class="n">stations_name_str</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">header_pcal_v</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_pcal_meta"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_pcal_meta">[docs]</a><span class="k">def</span> <span class="nf">get_pcal_meta</span><span class="p">(</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span><span class="n">acc_period</span><span class="p">,</span><span class="n">seconds_duration</span><span class="p">,</span><span class="n">station_name</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">tot_channels</span><span class="p">,</span><span class="n">num_tones_pcal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create metadata for PCAL record.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     mjd_start_str : str</span>
<span class="sd">         start MJD for the scan.</span>
<span class="sd">     seconds_start : float</span>
<span class="sd">         start seconds for the scan.</span>
<span class="sd">     acc_period : int</span>
<span class="sd">         accumulation period id.</span>
<span class="sd">     seconds_duration : float</span>
<span class="sd">         accumulation period duration</span>
<span class="sd">     station_name : two char</span>
<span class="sd">         station name.</span>
<span class="sd">     st0 : int</span>
<span class="sd">         station id.</span>
<span class="sd">     tot_channels : int</span>
<span class="sd">         number of channels or bands.</span>
<span class="sd">     num_tones_pcal : int</span>
<span class="sd">         number of phase calibration tones per band.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     meta_pcal : str</span>
<span class="sd">         metadata preceding the records for one accumulation period.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Check offset +seconds_duration/2.</span>
<span class="sd">    |    st0 should be datastream id?</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">seconds_duration_frac</span> <span class="o">=</span> <span class="n">seconds_duration</span><span class="o">/</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">seconds_duration_str</span> <span class="o">=</span> <span class="n">PCAL_SECONDS_FLOAT_FORMAT</span> <span class="o">%</span> <span class="n">seconds_duration_frac</span>

    <span class="n">seconds_start_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">seconds_start</span><span class="o">+</span><span class="n">acc_period</span><span class="o">*</span><span class="n">seconds_duration</span><span class="o">+</span><span class="n">seconds_duration</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">seconds_start_str</span>  <span class="o">=</span> <span class="n">PCAL_SECONDS_FLOAT_FORMAT</span> <span class="o">%</span> <span class="n">seconds_start_frac</span>
    
    <span class="n">timestamp_str</span>      <span class="o">=</span> <span class="n">mjd_start_str</span><span class="o">+</span><span class="n">seconds_start_str</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    
    <span class="n">meta_pcal</span> <span class="o">=</span>      <span class="n">station_name</span>         <span class="o">+</span><span class="s2">&quot; &quot;</span>          <span class="c1"># 1. andId</span>
    <span class="n">meta_pcal</span> <span class="o">+=</span>     <span class="n">timestamp_str</span>        <span class="o">+</span><span class="s2">&quot; &quot;</span>          <span class="c1"># 2. day</span>
    <span class="n">meta_pcal</span> <span class="o">+=</span>     <span class="n">seconds_duration_str</span> <span class="o">+</span><span class="s2">&quot; &quot;</span>          <span class="c1"># 3. dur</span>
    <span class="n">meta_pcal</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st0</span><span class="p">)</span>                 <span class="o">+</span><span class="s2">&quot; &quot;</span>          <span class="c1"># 4. datastreamId</span>
    <span class="n">meta_pcal</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tot_channels</span><span class="p">)</span>        <span class="o">+</span><span class="s2">&quot; &quot;</span>          <span class="c1"># 5. nRecBand</span>
    <span class="n">meta_pcal</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_tones_pcal</span><span class="p">)</span>      <span class="o">+</span><span class="s2">&quot; &quot;</span>          <span class="c1"># 6. nTone</span>

    <span class="k">return</span><span class="p">(</span><span class="n">meta_pcal</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_pcal_record_valid"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_pcal_record_valid">[docs]</a><span class="k">def</span> <span class="nf">get_pcal_record_valid</span><span class="p">(</span><span class="n">pcal_value</span><span class="p">,</span><span class="n">tone_freq_mega</span><span class="p">,</span><span class="n">pol_char</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get record with valid result for phase calibration tone.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     pcal_value : complex</span>
<span class="sd">         phase calibration tone.</span>
<span class="sd">     tone_freq_mega: int or float</span>
<span class="sd">         pcal tone freq [MHz].</span>
<span class="sd">     pol_char : char</span>
<span class="sd">         polarization.</span>
<span class="sd">     </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">add_space_0</span> <span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">pcal_value</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">add_space_0</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">add_space_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">pcal_value</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">add_space_1</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
    <span class="n">record</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tone_freq_mega</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">pol_char</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">add_space_0</span><span class="o">+</span>\
                <span class="nb">str</span><span class="p">(</span><span class="n">PCAL_TONE_SCI_FORMAT</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">pcal_value</span><span class="p">)))</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">add_space_1</span><span class="o">+</span>\
                <span class="nb">str</span><span class="p">(</span><span class="n">PCAL_TONE_SCI_FORMAT</span> <span class="o">%</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">pcal_value</span><span class="p">)))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">record</span><span class="p">)</span></div>



<div class="viewcode-block" id="append_pcal_records"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.append_pcal_records">[docs]</a><span class="k">def</span> <span class="nf">append_pcal_records</span><span class="p">(</span><span class="n">records</span><span class="p">,</span><span class="n">chan_freq_out_mega</span><span class="p">,</span><span class="n">pcal_freq_out_mega</span><span class="p">,</span><span class="n">pcal_ind</span><span class="p">,</span><span class="n">datac</span><span class="p">,</span><span class="n">n_bins</span><span class="p">,</span><span class="n">pol_char</span><span class="p">,</span>\
                                              <span class="n">conjugate_pcal_values</span><span class="p">,</span><span class="n">pcal_scaling</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append a set of new phase calibration tone records for this band.</span>
<span class="sd">    Record is the &quot;group of four numbers&quot; in [Br14].</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     records : list of str</span>
<span class="sd">         records (previously generated for other bands for the same accumulation period.</span>
<span class="sd">     chan_freq_out_mod_mega : int or float</span>
<span class="sd">         frequency of the first phase calibration tone in this band[Mhz].</span>
<span class="sd">     pcal_freq_out_mega : int or float</span>
<span class="sd">         phase calibration tone frequency separation [Mhz].</span>
<span class="sd">     pcal_ind : list of ints</span>
<span class="sd">         positions with phase calibration indices.</span>
<span class="sd">     datac : complex 1D numpy array</span>
<span class="sd">         phase calibration results (DFT).</span>
<span class="sd">     n_bins : int</span>
<span class="sd">         number of bins in the phase calibration DFT.</span>
<span class="sd">     pol_char : char</span>
<span class="sd">         polarization.</span>
<span class="sd">     conjugate_pcal_values : int</span>
<span class="sd">         conjugate all valid results if 1.</span>
<span class="sd">     pcal_scaling : float</span>
<span class="sd">         multiply all valid results by this value.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     records : list of str</span>
<span class="sd">         appended list of str including (the new elements are the records for this band).</span>
<span class="sd">         </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Check if N == n_bins and simplify code.</span>
<span class="sd">    |    Add offset from configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Iterate through indices for phase calibration tones</span>
    <span class="n">pcal_diff</span><span class="o">=</span><span class="n">pcal_freq_out_mega</span>
    <span class="k">for</span> <span class="n">pcal_index</span> <span class="ow">in</span> <span class="n">pcal_ind</span><span class="p">:</span>
        <span class="n">pcal_diff</span><span class="o">-=</span><span class="n">pcal_freq_out_mega</span>
        <span class="n">chan_freq_out_mod_mega</span> <span class="o">=</span> <span class="n">chan_freq_out_mega</span> <span class="o">+</span> <span class="n">pcal_diff</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pcal_index</span><span class="o">&lt;</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">n_bins</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">pcal_index</span><span class="o">&gt;</span><span class="n">n_bins</span><span class="p">):</span>
            <span class="c1"># Invalid tone</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">PCAL_INVALID_RECORD_STR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Valid tone</span>
            <span class="n">pcal_value</span> <span class="o">=</span> <span class="n">datac</span><span class="p">[</span><span class="n">pcal_index</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">conjugate_pcal_values</span><span class="p">:</span>
                <span class="n">pcal_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">pcal_value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pcal_scaling</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">pcal_value</span> <span class="o">*=</span> <span class="n">pcal_scaling</span>

            <span class="n">record</span> <span class="o">=</span> <span class="n">get_pcal_record_valid</span><span class="p">(</span><span class="n">pcal_value</span><span class="p">,</span><span class="n">chan_freq_out_mod_mega</span><span class="p">,</span><span class="n">pol_char</span><span class="p">)</span>
                    
        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">(</span><span class="n">records</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_pcal_line"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_pcal_line">[docs]</a><span class="k">def</span> <span class="nf">get_pcal_line</span><span class="p">(</span><span class="n">meta_pcal</span><span class="p">,</span><span class="n">records</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a line for the PCAL file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     meta_pcal : str</span>
<span class="sd">         metadata.</span>
<span class="sd">     records : list of str</span>
<span class="sd">         records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">meta_pcal</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">records</span><span class="p">))</span></div>

<div class="viewcode-block" id="write_pcal_file"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.write_pcal_file">[docs]</a><span class="k">def</span> <span class="nf">write_pcal_file</span><span class="p">(</span><span class="n">pcal_file</span><span class="p">,</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span><span class="n">station_name_str</span><span class="p">,</span><span class="n">records_v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write PCAL file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     pcal_file : str</span>
<span class="sd">         path to pcal file.</span>
<span class="sd">     mjd_start_str : str</span>
<span class="sd">         start MJD.</span>
<span class="sd">     seconds_start : str</span>
<span class="sd">         start seconds. </span>
<span class="sd">     station_name_str : two char.</span>
<span class="sd">         Two-character code for the station.</span>
<span class="sd">     records_v : list of str</span>
<span class="sd">         lines with pcal records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">seconds_start_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds_start</span><span class="p">))</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pcal_file</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
        
        <span class="c1"># Write PCAL header</span>
        <span class="n">header_pcal_v</span><span class="o">=</span><span class="n">get_lines_pcal_header</span><span class="p">(</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start_str</span><span class="p">,</span><span class="n">station_name_str</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">header_pcal_line</span> <span class="ow">in</span> <span class="n">header_pcal_v</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">header_pcal_line</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">f_out</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">record_line</span> <span class="ow">in</span> <span class="n">records_v</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">record_line</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">f_out</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_pcal_tone_positions"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_pcal_tone_positions">[docs]</a><span class="k">def</span> <span class="nf">get_pcal_tone_positions</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">bw</span><span class="p">,</span><span class="n">chan_freq</span><span class="p">,</span><span class="n">pcal_freq</span><span class="p">,</span><span class="n">num_tones_pcal</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get positions of the phase calibration tones in the results.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     N : int</span>
<span class="sd">         number of coefficients in the results (DFT of accumulated windows).</span>
<span class="sd">     bw : int or float</span>
<span class="sd">         bandwidth of the channel [Hz].</span>
<span class="sd">     chan_freq : int or float</span>
<span class="sd">         lower edge frequency of the channel [Hz].</span>
<span class="sd">     pcal_freq : int or float</span>
<span class="sd">         phase calibration tone frequency.</span>
<span class="sd">     num_tones_pcal: number of phase calibration tones expected for this band.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     pcal_ind_mod : list of int</span>
<span class="sd">         position for the coeffients containing the phase calibration tones.</span>
<span class="sd">     extreme_value : int</span>
<span class="sd">         value used to indicate invalid index.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    
    <span class="c1"># TO DO: spec_res. LSB hardcoded...</span>
    <span class="c1"># if LSB:</span>
    <span class="n">lsb_band</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">chan_freq_mod</span><span class="o">=</span><span class="n">chan_freq</span>
    <span class="k">if</span> <span class="n">lsb_band</span><span class="p">:</span>
        <span class="n">chan_freq_mod</span><span class="o">-=</span><span class="n">bw</span>
        <span class="n">spec_res</span><span class="o">=</span><span class="n">bw</span><span class="o">/</span><span class="n">N</span>

    <span class="n">freq_base</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">chan_freq_mod</span><span class="o">//</span><span class="n">pcal_freq</span><span class="p">)</span><span class="o">*</span><span class="n">pcal_freq</span><span class="p">)</span>
    <span class="n">first_tone</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">freq_base</span><span class="o">-</span><span class="n">chan_freq_mod</span><span class="p">)</span><span class="o">//</span><span class="n">spec_res</span><span class="p">)</span>
    <span class="n">total_tones</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bw</span><span class="o">//</span><span class="n">pcal_freq</span><span class="p">)</span>
    <span class="n">pcal_sep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pcal_freq</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="n">bw</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">first_tone</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">first_tone</span><span class="o">+=</span><span class="n">pcal_sep</span>

    <span class="n">pcal_ind_mod</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">first_tone</span><span class="p">,</span><span class="n">pcal_sep</span><span class="o">*</span><span class="p">(</span><span class="n">total_tones</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">pcal_sep</span><span class="p">))</span>

    <span class="c1">#in case index greater than fft size</span>
    <span class="n">extreme_value</span><span class="o">=-</span><span class="mi">100</span><span class="o">*</span><span class="n">N</span>
    <span class="k">for</span> <span class="n">i_extreme</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">pcal_ind_mod</span><span class="p">[</span><span class="n">i_extreme</span><span class="p">]</span><span class="o">&gt;</span><span class="n">N</span><span class="p">:</span>
            <span class="n">pcal_ind_mod</span><span class="p">[</span><span class="n">i_extreme</span><span class="p">]</span><span class="o">=</span><span class="n">extreme_value</span>

    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pcal_ind_mod</span><span class="p">)</span><span class="o">&lt;</span><span class="n">num_tones_pcal</span><span class="p">:</span>
        <span class="n">pcal_ind_mod</span> <span class="o">=</span> <span class="p">[</span><span class="n">extreme_value</span><span class="p">]</span><span class="o">+</span><span class="n">pcal_ind_mod</span>

    

    <span class="n">pcal_ind_mod</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">pcal_ind_mod</span><span class="p">)))</span> 
    
    <span class="k">return</span><span class="p">([</span><span class="n">pcal_ind_mod</span><span class="p">,</span><span class="n">extreme_value</span><span class="p">])</span></div>


<div class="viewcode-block" id="plot_pcal_tones"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.plot_pcal_tones">[docs]</a><span class="k">def</span> <span class="nf">plot_pcal_tones</span><span class="p">(</span><span class="n">datac</span><span class="p">,</span><span class="n">pcal_ind</span><span class="p">,</span><span class="n">extreme_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot phase calibration tones in red, overlaying the DFT with all results. Use for debugging.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     datac : numpy array of complex</span>
<span class="sd">         DFT with pcal results.</span>
<span class="sd">     pcal_ind : list of int</span>
<span class="sd">         positions of the phase calibration tones.</span>
<span class="sd">     extreme_value : int</span>
<span class="sd">         value used to indicate invalid index.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pcal_ind_plot</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">pcal_ind</span><span class="p">)</span>
    <span class="n">pcal_ind_plot</span><span class="p">[:]</span><span class="o">=</span><span class="n">pcal_ind</span>
    <span class="k">if</span> <span class="n">extreme_value</span> <span class="ow">in</span> <span class="n">pcal_ind_plot</span><span class="p">:</span>
        <span class="n">pcal_ind_plot</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">extreme_value</span><span class="p">)</span>
    <span class="n">zerodata</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">datac</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">zerodata</span><span class="p">[</span><span class="n">pcal_ind_plot</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">datac</span><span class="p">[</span><span class="n">pcal_ind_plot</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">datac</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">zerodata</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="cxpcal2d"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.cxpcal2d">[docs]</a><span class="k">def</span> <span class="nf">cxpcal2d</span><span class="p">(</span><span class="n">doutput_folder</span><span class="p">,</span><span class="n">cxoutput_file</span><span class="p">,</span><span class="n">correlation_ini_file</span><span class="p">,</span><span class="n">media_ini_file</span><span class="p">,</span><span class="n">stations_ini_file</span><span class="p">,</span>\
             <span class="n">forced_file_list</span><span class="o">=</span><span class="p">[],</span><span class="n">pcal_scaling</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">conjugate_pcal_values</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate phase calibration tone files (&quot;pulse cal data files&quot;) DiFX/SWIN from CorrelX/CX.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     doutput_folder : str</span>
<span class="sd">         path to place new PCAL files.</span>
<span class="sd">     cxoutput_file : str</span>
<span class="sd">         path to CX file to read.</span>
<span class="sd">     correlation_ini_file : str</span>
<span class="sd">         path to correlation.ini.</span>
<span class="sd">     media_ini_file : str</span>
<span class="sd">         path to media.ini.</span>
<span class="sd">     stations_ini_file : str</span>
<span class="sd">         path to stations.ini.</span>
<span class="sd">     forced_file_list : optional,[testing]</span>
<span class="sd">         consider only these media files (consider all if []).</span>
<span class="sd">     pcal_scaling : float, optional</span>
<span class="sd">         if not 0, multiply all phase calibration tones by this value.</span>
<span class="sd">     conjugate_pcal_values : optional,[testing]</span>
<span class="sd">         conjugate phase calibration tone values.</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     name_file_list : list of str</span>
<span class="sd">         names of the newly created PCAL files (no path).</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    (!) This function needs to be simplified.</span>
<span class="sd">    |    Assuming that number of channels and polarizations equals the max id plus one.</span>
<span class="sd">    |    Phase calibration line string currently hardcoded (pc).</span>
<span class="sd">    |    Untested for real data.</span>
<span class="sd">    |    fs=2fs, check this, consider reading one frame of the media to determine if complex/real data.</span>
<span class="sd">    |    LSB/USB.</span>
<span class="sd">    |    Offset for pcal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name_file_list</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">cxoutput_file_report</span> <span class="o">=</span> <span class="n">cxoutput_file</span><span class="o">+</span><span class="s2">&quot;_pcal_report.txt&quot;</span>   <span class="c1"># report filename</span>
    <span class="n">num_plots</span><span class="o">=</span><span class="mi">3</span>
    
    <span class="c1"># Read ini files</span>
    <span class="n">serial_correlation</span><span class="o">=</span> <span class="n">serialize_config</span><span class="p">(</span><span class="n">sources_file</span><span class="o">=</span><span class="n">correlation_ini_file</span><span class="p">)</span>
    <span class="n">serial_stations</span><span class="o">=</span>    <span class="n">serialize_config</span><span class="p">(</span><span class="n">sources_file</span><span class="o">=</span><span class="n">stations_ini_file</span><span class="p">)</span>
    <span class="n">serial_media</span><span class="o">=</span>       <span class="n">serialize_config</span><span class="p">(</span><span class="n">sources_file</span><span class="o">=</span><span class="n">media_ini_file</span><span class="p">)</span>
    
    <span class="n">params_array_correlation</span><span class="o">=</span>          <span class="n">serial_params_to_array</span><span class="p">(</span><span class="n">serial_correlation</span><span class="p">)</span>
    <span class="n">params_array_stations</span><span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">serial_params_to_array</span><span class="p">(</span><span class="n">serial_stations</span><span class="p">))</span>     <span class="c1"># TO DO: np.array?</span>
    <span class="n">params_array_media</span><span class="o">=</span>                <span class="n">serial_params_to_array</span><span class="p">(</span><span class="n">serial_media</span><span class="p">)</span>
    
    <span class="c1"># Process ini files -                                                                             correlation.ini</span>
    <span class="n">mjd_start_str</span> <span class="o">=</span>          <span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_correlation</span><span class="p">,</span><span class="n">C_INI_CR_S_TIMES</span><span class="p">,</span><span class="n">C_INI_CR_MJD</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">seconds_start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>   <span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_correlation</span><span class="p">,</span><span class="n">C_INI_CR_S_TIMES</span><span class="p">,</span><span class="n">C_INI_CR_START</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">seconds_duration</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_val_vector</span><span class="p">(</span><span class="n">params_array_correlation</span><span class="p">,</span><span class="n">C_INI_CR_S_COMP</span><span class="p">,</span> <span class="n">C_INI_CR_ACC</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Process ini files -                                                                             stations.ini</span>
    <span class="n">stations_v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">params_array_stations</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">stations_v</span><span class="p">)</span>
    
    <span class="c1"># Process ini files -                                                                             media.ini</span>
    <span class="n">pol_chars</span><span class="o">=</span>                  <span class="n">get_all_params_serial</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_S_POLARIZATIONS</span><span class="p">)</span>
    <span class="n">channel_str_v</span> <span class="o">=</span>             <span class="n">get_all_params_serial</span><span class="p">(</span><span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_FREQUENCIES</span><span class="p">)</span>    
    <span class="n">file_list</span><span class="o">=</span>                  <span class="n">get_val_vector</span><span class="p">(</span>       <span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_S_FILES</span><span class="p">,</span><span class="n">C_INI_MEDIA_LIST</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">forced_file_list</span><span class="o">==</span><span class="p">[]:</span>
        <span class="n">forced_file_list</span><span class="o">=</span><span class="n">file_list</span>
    <span class="n">eq_channels</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">eq_polarizations</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">forced_file_list</span><span class="p">:</span>
        <span class="n">eq_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>     <span class="n">get_param_eq_vector</span><span class="p">(</span>  <span class="n">params_array_media</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">C_INI_MEDIA_S_CHANNELS</span><span class="p">))</span>
        <span class="n">eq_polarizations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_param_eq_vector</span><span class="p">(</span>  <span class="n">params_array_media</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">C_INI_MEDIA_S_POLARIZATIONS</span><span class="p">))</span>
    
    <span class="c1"># TO DO: simplify this?</span>
    <span class="c1"># Get list of channels and sort by id</span>
    <span class="n">f_id_v</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f_val_v</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">channel_str</span> <span class="ow">in</span> <span class="n">channel_str_v</span><span class="p">:</span>
        <span class="n">f_id_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>      <span class="nb">int</span><span class="p">(</span><span class="n">get_param_serial</span><span class="p">(</span>     <span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_S_CHANNELS</span><span class="p">,</span><span class="n">channel_str</span><span class="p">)))</span>
        <span class="n">f_val_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>   <span class="nb">float</span><span class="p">(</span><span class="n">get_param_serial</span><span class="p">(</span>     <span class="n">params_array_media</span><span class="p">,</span><span class="n">C_INI_MEDIA_FREQUENCIES</span><span class="p">,</span><span class="n">channel_str</span><span class="p">)))</span>
    
    <span class="n">f_id_v</span><span class="p">,</span> <span class="n">f_val_v</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">f_id_v</span><span class="p">,</span> <span class="n">f_val_v</span><span class="p">)))</span>
    <span class="n">f_id_v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f_id_v</span><span class="p">)</span>     <span class="c1"># List of frequency ids</span>
    <span class="n">f_val_v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">f_val_v</span><span class="p">)</span>   <span class="c1"># List of frequency values</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f_val_v</span><span class="p">)</span>        <span class="c1"># f_val_v has list of frequencies that can be accessed by channel id</span>
    
    

    <span class="n">list_output</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">max_chan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">max_pol</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    
    
    <span class="c1"># Read pcal results from CX file</span>
    <span class="n">check_pc</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cxoutput_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;pc&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">[:</span><span class="mi">2</span><span class="p">]:</span> 
                <span class="c1"># Process only lines for phase calibration </span>
                <span class="c1"># One line per station and accumulation period</span>
                <span class="c1"># TO DO: str pc HARDCODED, create constant in const_mapred.py</span>
                <span class="n">check_pc</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">[</span><span class="n">meta</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">pol1</span><span class="p">,</span><span class="n">n_bins</span><span class="p">,</span>\
                      <span class="n">pcal_freq</span><span class="p">,</span><span class="n">chan_index</span><span class="p">,</span><span class="n">acc_period</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">predata</span><span class="p">,</span><span class="n">datac</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_line_cx</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
                <span class="c1"># (!) chan_index has to follow the same order as defined in the media file! no re-sorting!</span>
                <span class="c1"># TO DO: hardcoded!</span>
                <span class="c1"># This is only for complex data!</span>
                <span class="n">fs</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">fs</span>
                
                <span class="c1"># Find proper ids for channel and polarization (from the metadata associated to the media file)</span>
                <span class="p">[</span><span class="n">search_chan</span><span class="p">,</span><span class="n">search_pol</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">]</span>
                <span class="n">global_index_chan</span><span class="o">=-</span><span class="mi">1</span>
                <span class="n">count_position</span><span class="o">=-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">eq_channels</span><span class="p">[</span><span class="n">st0</span><span class="p">],</span><span class="n">eq_polarizations</span><span class="p">[</span><span class="n">st0</span><span class="p">]):</span>
                    <span class="n">count_position</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="p">[</span><span class="n">search_chan</span><span class="p">,</span><span class="n">search_pol</span><span class="p">]</span><span class="o">==</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">global_index_chan</span><span class="o">=</span><span class="n">count_position</span>
                        <span class="k">break</span>

                <span class="n">list_output</span><span class="o">+=</span><span class="p">[[</span><span class="n">st0</span><span class="p">,</span><span class="n">acc_period</span><span class="p">,</span><span class="n">global_index_chan</span><span class="p">,</span><span class="n">chan_index</span><span class="p">,</span><span class="n">meta</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">n_bins</span><span class="p">,</span><span class="n">pcal_freq</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">datac</span><span class="p">]]</span>
                
                <span class="c1"># TO DO: for channels and polarization ids expecting total = max(id)+1</span>
                <span class="k">if</span> <span class="n">chan</span><span class="o">&gt;</span><span class="n">max_chan</span><span class="p">:</span>
                    <span class="n">max_chan</span><span class="o">=</span><span class="n">chan</span>
                <span class="k">if</span> <span class="n">pol0</span><span class="o">&gt;</span><span class="n">max_pol</span><span class="p">:</span>
                    <span class="n">max_pol</span><span class="o">=</span><span class="n">pol0</span>
    
    
    
    <span class="c1"># Process pcal results</span>
    <span class="k">if</span> <span class="n">check_pc</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No phase calibration results found.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
    
        <span class="n">tot_channels</span> <span class="o">=</span> <span class="n">max_chan</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">tot_pols</span> <span class="o">=</span> <span class="n">max_pol</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">tot_channels</span> <span class="o">=</span> <span class="n">tot_channels</span><span class="o">*</span><span class="n">tot_pols</span>
        
        <span class="c1"># Sort by station, accumulation period and band</span>
        <span class="n">list_output</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_output</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="c1">#(0,1,2)) #4,5))</span>
        

        <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">records_v</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">first_element</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">st0_pre</span><span class="o">=-</span><span class="mi">1</span>
        <span class="n">acc_period_pre</span><span class="o">=-</span><span class="mi">1</span>
          
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cxoutput_file_report</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_report_pcal</span><span class="p">:</span>   <span class="c1"># phase calibration report used for debugging</span>
            <span class="k">for</span> <span class="n">list_item</span> <span class="ow">in</span> <span class="n">list_output</span><span class="p">:</span>
                <span class="p">[</span><span class="n">st0</span><span class="p">,</span><span class="n">acc_period</span><span class="p">,</span><span class="n">global_index_chan</span><span class="p">,</span><span class="n">chan_index</span><span class="p">,</span><span class="n">meta</span><span class="p">,</span><span class="n">chan</span><span class="p">,</span><span class="n">pol0</span><span class="p">,</span><span class="n">n_bins</span><span class="p">,</span><span class="n">pcal_freq</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">datac</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_item</span>
                
                <span class="c1"># Number of pcal tones</span>
                <span class="n">num_tones_pcal</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">fs</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pcal_freq</span><span class="p">)))</span>
                
                <span class="k">if</span> <span class="p">((</span><span class="n">first_element</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="ow">and</span><span class="p">((</span><span class="n">st0_pre</span><span class="o">!=</span><span class="n">st0</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">acc_period_pre</span><span class="o">!=</span><span class="n">acc_period</span><span class="p">))):</span>
                    
                    <span class="c1"># If not first iteration and new station / acc period:</span>
                    <span class="c1">#  -prepare file headers for previous results</span>
                    <span class="c1">#  -write previous results</span>
                    <span class="c1">#  -reset structures for new results</span>
                    
                    <span class="n">records_v</span> <span class="o">+=</span> <span class="p">[</span><span class="n">get_pcal_line</span><span class="p">(</span><span class="n">meta_pcal</span><span class="p">,</span><span class="n">records</span><span class="p">)]</span>
                    
                    <span class="k">if</span> <span class="p">(</span><span class="n">st0_pre</span><span class="o">!=</span><span class="n">st0</span><span class="p">):</span>
                        <span class="c1"># If new station, print previous results to file</span>
                        <span class="n">name_file</span> <span class="o">=</span> <span class="n">get_pcal_filename</span><span class="p">(</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span><span class="n">stations_v</span><span class="p">[</span><span class="n">st0_pre</span><span class="p">])</span>
                        <span class="n">write_pcal_file</span><span class="p">(</span><span class="n">doutput_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">name_file</span><span class="p">,</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span>\
                                        <span class="n">stations_v</span><span class="p">[</span><span class="n">st0_pre</span><span class="p">],</span><span class="n">records_v</span><span class="p">)</span>
                        <span class="n">name_file_list</span><span class="o">+=</span><span class="p">[</span><span class="n">name_file</span><span class="p">]</span>
                        <span class="n">records_v</span><span class="o">=</span><span class="p">[]</span>
                            
                    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
       
                <span class="k">if</span> <span class="p">((</span><span class="n">st0_pre</span><span class="o">!=</span><span class="n">st0</span><span class="p">)</span><span class="ow">or</span><span class="p">(</span><span class="n">acc_period_pre</span><span class="o">!=</span><span class="n">acc_period</span><span class="p">)):</span>
                    
                    <span class="c1"># If new station / acc period, prepare metadata for records</span>
                    <span class="n">meta_pcal</span> <span class="o">=</span> <span class="n">get_pcal_meta</span><span class="p">(</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span><span class="n">acc_period</span><span class="p">,</span><span class="n">seconds_duration</span><span class="p">,</span>\
                                              <span class="n">stations_v</span><span class="p">[</span><span class="n">st0</span><span class="p">],</span><span class="n">st0</span><span class="p">,</span><span class="n">tot_channels</span><span class="p">,</span><span class="n">num_tones_pcal</span><span class="p">)</span>
                
                <span class="n">first_element</span><span class="o">=</span><span class="mi">0</span>
                
                <span class="n">st0_pre</span> <span class="o">=</span> <span class="n">st0</span>
                <span class="n">acc_period_pre</span> <span class="o">=</span> <span class="n">acc_period</span>
                
                
                <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Sts.:  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st1</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Vis.: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">vis</span><span class="p">))</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Chan.: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Pols.: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pol0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pol1</span><span class="p">))</span>
                
                <span class="n">chan_freq</span> <span class="o">=</span> <span class="n">f_val_v</span><span class="p">[</span><span class="n">chan</span><span class="p">]</span>
                <span class="n">chan_freq_out_mega</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chan_freq</span><span class="o">//</span><span class="mf">1e6</span><span class="p">)</span>
                <span class="n">pcal_freq_out_mega</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pcal_freq</span><span class="o">//</span><span class="mf">1e6</span><span class="p">)</span>
                
                <span class="n">chan_freq_out_mega</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan_freq_out_mega</span><span class="o">//</span><span class="n">pcal_freq_out_mega</span><span class="p">)</span><span class="o">*</span><span class="n">pcal_freq_out_mega</span>
                
                <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">chan_freq</span><span class="p">)</span>
                
            
                <span class="c1"># Compute locations of pcal tones</span>
                <span class="n">N</span> <span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">datac</span><span class="p">)</span>
                <span class="n">bw</span> <span class="o">=</span> <span class="n">fs</span><span class="o">/</span><span class="mi">2</span>
                <span class="p">[</span><span class="n">pcal_ind_mod</span><span class="p">,</span><span class="n">extreme_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_pcal_tone_positions</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">bw</span><span class="p">,</span><span class="n">chan_freq</span><span class="p">,</span><span class="n">pcal_freq</span><span class="p">,</span><span class="n">num_tones_pcal</span><span class="p">)</span>
                <span class="n">pcal_ind</span> <span class="o">=</span> <span class="n">pcal_ind_mod</span>
                    
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">st0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">acc_period</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chan_freq</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chan_freq_out_mega</span><span class="p">)</span><span class="o">+</span>\
                      <span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">pol_chars</span><span class="p">[</span><span class="n">pol0</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pcal_ind_mod</span><span class="p">),</span><span class="n">file</span> <span class="o">=</span> <span class="n">f_report_pcal</span> <span class="p">)</span>   
                
               


                <span class="k">if</span> <span class="n">ENABLE_PLOTTING</span> <span class="ow">and</span> <span class="n">num_plots</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">plot_pcal_tones</span><span class="p">(</span><span class="n">datac</span><span class="p">,</span><span class="n">pcal_ind</span><span class="p">,</span><span class="n">extreme_value</span><span class="p">)</span>
                    <span class="n">num_plots</span><span class="o">-=</span><span class="mi">1</span>

                <span class="n">records</span> <span class="o">=</span> <span class="n">append_pcal_records</span><span class="p">(</span><span class="n">records</span><span class="p">,</span><span class="n">chan_freq_out_mega</span><span class="p">,</span><span class="n">pcal_freq_out_mega</span><span class="p">,</span><span class="n">pcal_ind</span><span class="p">,</span><span class="n">datac</span><span class="p">,</span>\
                                              <span class="n">n_bins</span><span class="p">,</span><span class="n">pol_chars</span><span class="p">[</span><span class="n">pol0</span><span class="p">],</span><span class="n">conjugate_pcal_values</span><span class="p">,</span><span class="n">pcal_scaling</span><span class="p">)</span>
    
             
             
            <span class="c1"># Last write</span>
            <span class="n">records_v</span> <span class="o">+=</span> <span class="p">[</span><span class="n">get_pcal_line</span><span class="p">(</span><span class="n">meta_pcal</span><span class="p">,</span><span class="n">records</span><span class="p">)]</span>
                
            <span class="c1"># Print to file</span>
            <span class="n">name_file</span> <span class="o">=</span> <span class="n">get_pcal_filename</span><span class="p">(</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span><span class="n">stations_v</span><span class="p">[</span><span class="n">st0_pre</span><span class="p">])</span>
            <span class="n">write_pcal_file</span><span class="p">(</span><span class="n">doutput_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">name_file</span><span class="p">,</span><span class="n">mjd_start_str</span><span class="p">,</span><span class="n">seconds_start</span><span class="p">,</span><span class="n">stations_v</span><span class="p">[</span><span class="n">st0_pre</span><span class="p">],</span><span class="n">records_v</span><span class="p">)</span>
            <span class="n">name_file_list</span><span class="o">+=</span><span class="p">[</span><span class="n">name_file</span><span class="p">]</span>
            
    <span class="k">return</span><span class="p">(</span><span class="n">name_file_list</span><span class="p">)</span></div>




<span class="c1">###########################################</span>
<span class="c1"># Conversion CorrelX/CX -&gt; DiFX/SWIN+PCAL</span>
<span class="c1">###########################################</span>


<div class="viewcode-block" id="convert_cx2dpc"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.convert_cx2dpc">[docs]</a><span class="k">def</span> <span class="nf">convert_cx2dpc</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_in</span><span class="p">,</span><span class="n">file_out</span><span class="p">,</span><span class="n">correlation_ini_file</span><span class="p">,</span><span class="n">media_ini_file</span><span class="p">,</span><span class="n">stations_ini_file</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                   <span class="n">only_half</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">duplicate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">freq_ids</span><span class="o">=</span><span class="p">[],</span><span class="n">back_compat</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">forced_accumulation_period</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">divide_vis_by</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
                   <span class="n">forced_file_list</span><span class="o">=</span><span class="p">[],</span><span class="n">pcal_scaling</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">conjugate_pcal_values</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">conjugate_vis_values</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main routine to convert CorrelX/CX into DiFX/SWIN+PCAL.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     inout_folder : str</span>
<span class="sd">         path to folder containing CX file, and where newly created SWIN+PCAL files will be placed.</span>
<span class="sd">     file_in : str</span>
<span class="sd">         CX filename.</span>
<span class="sd">     file_out : str</span>
<span class="sd">         filename for new SwIN file.</span>
<span class="sd">     correlation_ini_file : str</span>
<span class="sd">         path to correlation.ini associated with CX file.</span>
<span class="sd">     media_ini_file : str</span>
<span class="sd">         path to media.ini associated with CX file.</span>
<span class="sd">     stations_ini_file:    path to stations.ini associated with CX file.</span>
<span class="sd">     </span>
<span class="sd">     See convert_cx2d() for the rest of the arguments.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     pcal_file_list : list of str</span>
<span class="sd">         filenames for new PCAL files (None if error).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Check errors in .ini files</span>
    <span class="n">fp_v</span><span class="o">=</span><span class="p">[</span><span class="n">media_ini_file</span><span class="p">,</span><span class="n">correlation_ini_file</span><span class="p">]</span>
    <span class="n">fn_v</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Media&quot;</span><span class="p">,</span><span class="s2">&quot;Correlation&quot;</span><span class="p">]</span>
    <span class="n">error_files</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fp_v</span><span class="p">,</span><span class="n">fn_v</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">media_ini_file</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: &quot;</span><span class="o">+</span><span class="n">fn</span><span class="o">+</span><span class="s2">&quot; file &quot;</span><span class="o">+</span><span class="n">fp</span><span class="o">+</span><span class="s2">&quot; does not exist!&quot;</span><span class="p">)</span>
            <span class="n">error_files</span><span class="o">=</span><span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">error_files</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Convert cx output to dx</span>
        <span class="n">convert_cx2d</span><span class="p">(</span><span class="n">inout_folder</span><span class="o">+</span><span class="n">file_out</span><span class="p">,</span><span class="n">inout_folder</span><span class="o">+</span><span class="n">file_in</span><span class="p">,</span><span class="n">correlation_ini_file</span><span class="p">,</span><span class="n">media_ini_file</span><span class="p">,</span><span class="n">forced_pol_list</span><span class="o">=</span><span class="p">[],</span>\
                     <span class="n">only_half</span><span class="o">=</span><span class="n">only_half</span><span class="p">,</span><span class="n">duplicate</span><span class="o">=</span><span class="n">duplicate</span><span class="p">,</span><span class="n">freq_ids</span><span class="o">=</span><span class="n">freq_ids</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">back_compat</span><span class="o">=</span><span class="n">back_compat</span><span class="p">,</span>\
                     <span class="n">forced_accumulation_period</span><span class="o">=</span><span class="n">forced_accumulation_period</span><span class="p">,</span><span class="n">divide_vis_by</span><span class="o">=</span><span class="n">divide_vis_by</span><span class="p">,</span>\
                     <span class="n">conjugate_vis_values</span><span class="o">=</span><span class="n">conjugate_vis_values</span><span class="p">)</span>
        
        <span class="c1"># Convert cx output phase cal</span>
        <span class="n">pcal_file_list</span><span class="o">=</span><span class="n">cxpcal2d</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">inout_folder</span><span class="o">+</span><span class="n">file_in</span><span class="p">,</span><span class="n">correlation_ini_file</span><span class="p">,</span><span class="n">media_ini_file</span><span class="p">,</span><span class="n">stations_ini_file</span><span class="p">,</span>\
                                <span class="n">forced_file_list</span><span class="p">,</span><span class="n">pcal_scaling</span><span class="p">,</span><span class="n">conjugate_pcal_values</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pcal_file_list</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">return</span><span class="p">(</span><span class="n">pcal_file_list</span><span class="p">)</span></div>






<span class="c1">#################################################################</span>
<span class="c1">#               DiFX/.im,.input parser tools</span>
<span class="c1">################################################################# </span>

<div class="viewcode-block" id="get_field_im"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_field_im">[docs]</a><span class="k">def</span> <span class="nf">get_field_im</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the value+units from a line of DiFX configuration file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C_DIFX_SEPARATOR</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="get_value_im"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_value_im">[docs]</a><span class="k">def</span> <span class="nf">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the value (no units) from a line of DiFX configuration file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">get_field_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></div>

<div class="viewcode-block" id="get_vector_im"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_vector_im">[docs]</a><span class="k">def</span> <span class="nf">get_vector_im</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of str with polynomial coefficients from line in .im file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">([</span><span class="n">ii</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">get_field_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()])</span></div>

<div class="viewcode-block" id="get_src_ant_im"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_src_ant_im">[docs]</a><span class="k">def</span> <span class="nf">get_src_ant_im</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get two str, one with source id and another with station id from the line in .im file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">param_im_v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C_DIFX_SEPARATOR</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">src</span><span class="o">=</span><span class="n">param_im_v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ant</span><span class="o">=</span><span class="n">param_im_v</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">return</span><span class="p">([</span><span class="n">src</span><span class="p">,</span><span class="n">ant</span><span class="p">])</span></div>

<div class="viewcode-block" id="get_header_dm"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_header_dm">[docs]</a><span class="k">def</span> <span class="nf">get_header_dm</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span><span class="n">seconds</span><span class="p">,</span><span class="n">interval</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">ant</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create header for delay_model.ini.</span>
<span class="sd">    </span>
<span class="sd">    TO DO: consider moving into lib_ini_files.py.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">end_seconds</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">mjd</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">seconds</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="n">end_seconds</span><span class="o">+</span><span class="n">INI_SUB</span><span class="o">+</span><span class="s2">&quot;so&quot;</span><span class="o">+</span><span class="n">src</span><span class="o">+</span><span class="n">INI_SUB</span><span class="o">+</span><span class="s2">&quot;st&quot;</span><span class="o">+</span><span class="n">ant</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span></div>

<div class="viewcode-block" id="sort_str_list"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.sort_str_list">[docs]</a><span class="k">def</span> <span class="nf">sort_str_list</span><span class="p">(</span><span class="n">list_in</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return sorted set of elements of a list.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list_in</span><span class="p">))))))))</span></div>

<div class="viewcode-block" id="get_id_param"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_id_param">[docs]</a><span class="k">def</span> <span class="nf">get_id_param</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">num</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the id that is in the parameter, in the position num.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C_DIFX_SEPARATOR</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="n">num</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_coeff"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_coeff">[docs]</a><span class="k">def</span> <span class="nf">get_coeff</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process station clock information from .input file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">st</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C_DIFX_SEPARATOR</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C_DIFX_SEPARATOR</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span><span class="p">([</span><span class="n">st</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">value</span><span class="p">])</span></div>

<div class="viewcode-block" id="get_last_num"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.get_last_num">[docs]</a><span class="k">def</span> <span class="nf">get_last_num</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the id that is in the parameter, in the last position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">last_num</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">C_DIFX_SEPARATOR</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">last_num</span><span class="p">)</span></div>

<div class="viewcode-block" id="write_lines_to_f"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.write_lines_to_f">[docs]</a><span class="k">def</span> <span class="nf">write_lines_to_f</span><span class="p">(</span><span class="n">lines_out</span><span class="p">,</span><span class="n">full_output_file</span><span class="p">,</span><span class="n">str_info</span><span class="o">=</span><span class="s2">&quot;results&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a list of strings into a file, one per line, and report.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Writing &quot;</span><span class="o">+</span><span class="n">str_info</span><span class="o">+</span><span class="s2">&quot; to &quot;</span><span class="o">+</span><span class="n">full_output_file</span><span class="o">+</span><span class="s2">&quot; ...&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_out</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">file</span><span class="o">=</span><span class="n">f_out</span><span class="p">)</span></div>



<span class="c1">#################################################################</span>
<span class="c1">#      Conversion DiFX/.im -&gt; CorrelX/delay_model+sources</span>
<span class="c1">################################################################# </span>

<div class="viewcode-block" id="im_to_delay_model"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.im_to_delay_model">[docs]</a><span class="k">def</span> <span class="nf">im_to_delay_model</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_in</span><span class="p">,</span><span class="n">file_out</span><span class="p">,</span><span class="n">filter_sources</span><span class="o">=</span><span class="p">[],</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert DiFX/.im into CorrelX/delay_model.ini.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     inout_folder : str</span>
<span class="sd">         path to folder containing .im file, and where newly created delay_model.ini file will be placed.</span>
<span class="sd">     file_in : str</span>
<span class="sd">         .im filename.</span>
<span class="sd">     file_out: str</span>
<span class="sd">         delay_model.ini filename.</span>
<span class="sd">     filter_sources: list of str</span>
<span class="sd">         source names. If not [], information for sources that are not in this list will be dismissed.</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">DELAY_FIRST</span> <span class="o">=</span> <span class="n">C_INI_MODEL_DELAY</span><span class="o">+</span><span class="n">INI_SEP</span>
    <span class="n">DRY_FIRST</span>   <span class="o">=</span> <span class="n">C_INI_MODEL_DRY</span><span class="o">+</span><span class="n">INI_SEP</span>
    <span class="n">WET_FIRST</span>   <span class="o">=</span> <span class="n">C_INI_MODEL_WET</span><span class="o">+</span><span class="n">INI_SEP</span>
    
    
    <span class="n">lines_out</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">header_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">skip_data</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">not_first</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="n">list_mjd</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">list_seconds</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">list_so</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">list_st</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">full_input_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_in</span>
    <span class="n">full_output_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span>
    <span class="n">summary_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span><span class="o">+</span><span class="s2">&quot;_report&quot;</span>
    
    <span class="k">if</span> <span class="n">filter_sources</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Filtering sources: &quot;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">set</span><span class="p">(</span><span class="n">filter_sources</span><span class="p">)))))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Processing &quot;</span><span class="o">+</span><span class="n">full_input_file</span><span class="o">+</span><span class="s2">&quot; ...&quot;</span><span class="p">)</span>
        <span class="c1">#                                                                     ### --- Process .im and prepare delay_model.ini ---</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">C_DIFX_IM_INTERVAL_SECS</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                               <span class="c1"># Interval for the polynomial</span>
                <span class="n">interval</span><span class="o">=</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_IM_SCAN</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span>\
                 <span class="n">C_DIFX_IM_POLY</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span>\
                 <span class="n">C_DIFX_IM_MJD</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">mjd</span><span class="o">=</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>                                        <span class="c1"># Start MJD for the polynomial</span>
                <span class="n">list_mjd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_IM_SCAN</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span>\
                 <span class="n">C_DIFX_IM_POLY</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span>\
                 <span class="n">C_DIFX_IM_SEC</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">seconds</span><span class="o">=</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>                                    <span class="c1"># Start seconds for the polynomial</span>
                <span class="n">list_seconds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_IM_DELAY_US</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                  <span class="c1"># Total delay polynomial</span>
                <span class="n">poly_read</span> <span class="o">=</span> <span class="n">get_vector_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">poly_str</span><span class="o">=</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">poly_read</span><span class="p">)</span> <span class="c1">#:</span>
                <span class="p">[</span><span class="n">src</span><span class="p">,</span><span class="n">ant</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_src_ant_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">filter_sources</span><span class="o">==</span><span class="p">[]</span> <span class="ow">or</span> <span class="p">(</span><span class="n">filter_sources</span><span class="o">!=</span><span class="p">[]</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="ow">in</span> <span class="n">filter_sources</span><span class="p">):</span>
                    <span class="n">skip_data</span><span class="o">=</span><span class="mi">0</span>
                    <span class="n">list_so</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                    <span class="n">list_st</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span>
                    <span class="n">header_dm</span> <span class="o">=</span> <span class="n">get_header_dm</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span><span class="n">seconds</span><span class="p">,</span><span class="n">interval</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">ant</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">header_dm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">not_first</span><span class="p">:</span>
                            <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">not_first</span><span class="o">=</span><span class="mi">1</span>
                        <span class="n">header_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header_dm</span><span class="p">)</span>               
                        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header_dm</span><span class="p">)</span>
                    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DELAY_FIRST</span><span class="o">+</span><span class="n">poly_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">poly_read</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">poly_str</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">header_dm</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skip_data</span><span class="o">=</span><span class="mi">1</span>
                    
            <span class="k">elif</span> <span class="n">C_DIFX_IM_DRY_US</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                   <span class="c1"># Dry component delay polynomial</span>
                <span class="k">if</span> <span class="n">skip_data</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">poly_read</span> <span class="o">=</span> <span class="n">get_vector_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">poly_str</span><span class="o">=</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">poly_read</span><span class="p">)</span> <span class="c1">#:</span>
                    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DRY_FIRST</span><span class="o">+</span><span class="n">poly_str</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="n">C_DIFX_IM_WET_US</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                   <span class="c1"># Wet component delay polynomial</span>
                <span class="k">if</span> <span class="n">skip_data</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">poly_read</span> <span class="o">=</span> <span class="n">get_vector_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">poly_str</span><span class="o">=</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">poly_read</span><span class="p">)</span> <span class="c1">#:</span>
                    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WET_FIRST</span><span class="o">+</span><span class="n">poly_str</span><span class="p">)</span>
            
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    
    <span class="n">summary_lines</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Summary:&quot;</span><span class="p">)</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Input:    &quot;</span><span class="o">+</span><span class="n">full_input_file</span><span class="p">)</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Sources:  &quot;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list_so</span><span class="p">))))</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Stations: &quot;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list_st</span><span class="p">))))</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Interval: &quot;</span><span class="o">+</span><span class="n">interval</span><span class="p">)</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; MJDs:     &quot;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list_mjd</span><span class="p">))))</span>
    <span class="n">summary_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; seconds:  &quot;</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sort_str_list</span><span class="p">(</span><span class="n">list_seconds</span><span class="p">)))</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">summary_lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> 
    
    <span class="n">write_lines_to_f</span><span class="p">(</span><span class="n">lines_out</span><span class="p">,</span><span class="n">full_output_file</span><span class="p">)</span>
    <span class="n">write_lines_to_f</span><span class="p">(</span><span class="n">summary_lines</span><span class="p">,</span><span class="n">summary_file</span><span class="p">,</span><span class="s2">&quot;summary&quot;</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span>   </div>
    
    


    
    
<div class="viewcode-block" id="im_to_sources"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.im_to_sources">[docs]</a><span class="k">def</span> <span class="nf">im_to_sources</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_in</span><span class="p">,</span><span class="n">file_out</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert DiFX/.im into CorrelX/sources.ini.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     inout_folder : str</span>
<span class="sd">         path to folder containing .im file, and where newly created sources.ini file will be placed.</span>
<span class="sd">     file_in : str</span>
<span class="sd">         .im filename.</span>
<span class="sd">     file_out : str</span>
<span class="sd">         sources.ini filename.</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">SRC_ID_PARAM</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">full_input_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_in</span>
    <span class="n">full_output_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span>
    <span class="n">summary_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span><span class="o">+</span><span class="s2">&quot;_report&quot;</span>
    
    <span class="n">lines_out</span><span class="o">=</span><span class="p">[]</span>
   
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Processing &quot;</span><span class="o">+</span><span class="n">full_input_file</span><span class="o">+</span><span class="s2">&quot; ...&quot;</span><span class="p">)</span>
    <span class="c1">#                                                                            ### --- Process .im and prepare sources.ini ---    </span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">C_DIFX_IM_POINTING_SRC</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                   <span class="c1"># Source</span>
                <span class="n">src_id</span> <span class="o">=</span> <span class="n">get_id_param</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">SRC_ID_PARAM</span><span class="p">)</span>
                <span class="n">src_name</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">src_name</span><span class="p">)</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>
                <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_SRC_ID</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">src_id</span><span class="p">)</span>
    
    <span class="n">write_lines_to_f</span><span class="p">(</span><span class="n">lines_out</span><span class="p">,</span><span class="n">full_output_file</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File contents:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">ii</span><span class="p">)</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span> </div>



<span class="c1">#################################################################</span>
<span class="c1">#  Conversion DiFX/.input -&gt; CorrelX/stations+correlation+media</span>
<span class="c1">#################################################################</span>


<div class="viewcode-block" id="input_to_stations"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.input_to_stations">[docs]</a><span class="k">def</span> <span class="nf">input_to_stations</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_in</span><span class="p">,</span><span class="n">file_out</span><span class="p">,</span><span class="n">forced_stations</span><span class="o">=</span><span class="p">[],</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert DiFX/.input into CorrelX/stations.ini.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     inout_folder : str</span>
<span class="sd">         path to folder containing .input file, and where newly created stations.ini file will be placed.</span>
<span class="sd">     file_in : str</span>
<span class="sd">         .input filename.</span>
<span class="sd">     file_out : str</span>
<span class="sd">         stations.ini filename.</span>
<span class="sd">     forced_files : list of str,optional</span>
<span class="sd">         list of str with station names (for overriding values from .input).</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">clock_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">lines_out</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">not_first</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="n">full_input_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_in</span>
    <span class="n">full_output_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span>
    <span class="n">summary_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span><span class="o">+</span><span class="s2">&quot;_report&quot;</span>
    
    <span class="k">if</span> <span class="n">forced_stations</span><span class="o">!=</span><span class="p">[]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Forcing station names: &quot;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">set</span><span class="p">(</span><span class="n">forced_stations</span><span class="p">)))))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Processing &quot;</span><span class="o">+</span><span class="n">full_input_file</span><span class="o">+</span><span class="s2">&quot; ...&quot;</span><span class="p">)</span>
    <span class="c1">#                                                                              ### --- Process .input and prepare stations.ini ---</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">C_DIFX_INPUT_TELESCOPE_NAME</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                <span class="c1"># Station name</span>
                <span class="n">st_id</span> <span class="o">=</span> <span class="n">get_last_num</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">st_name</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">forced_stations</span><span class="o">!=</span><span class="p">[]:</span>
                    <span class="n">st_name</span><span class="o">=</span><span class="n">forced_stations</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">st_id</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">not_first</span><span class="p">:</span>
                    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">st_name</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>
                <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_ST_ID</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">st_id</span><span class="p">)</span>
                <span class="n">not_first</span><span class="o">=</span><span class="mi">1</span>

            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_CLOCK_REF_MJD</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                              <span class="c1"># Station clock epoch</span>
                <span class="n">clock_ref</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_ST_CLOCK_REF</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">clock_ref</span><span class="p">)</span>


            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_CLOCK_COEFF</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                <span class="c1"># Station clock polynomial</span>
                <span class="p">[</span><span class="n">st</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">value</span><span class="p">]</span><span class="o">=</span><span class="n">get_coeff</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">order</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">:</span>
                    <span class="n">value0</span><span class="o">=</span><span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clock_line</span> <span class="o">=</span> <span class="n">C_INI_ST_CLOCK_POLY</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">value0</span><span class="o">+</span><span class="n">INI_VEC</span><span class="o">+</span><span class="n">value</span>
                    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clock_line</span><span class="p">)</span>
    
    <span class="n">write_lines_to_f</span><span class="p">(</span><span class="n">lines_out</span><span class="p">,</span><span class="n">full_output_file</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File contents:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">ii</span><span class="p">)</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span> </div>
        


<div class="viewcode-block" id="input_to_correlation"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.input_to_correlation">[docs]</a><span class="k">def</span> <span class="nf">input_to_correlation</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_in</span><span class="p">,</span><span class="n">file_out</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert DiFX/.input into CorrelX/correlation.ini.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     inout_folder : str</span>
<span class="sd">         path to folder containing .input file, and where newly created correlation.ini file will be placed.</span>
<span class="sd">     file_in : str</span>
<span class="sd">         .input filename.</span>
<span class="sd">     file_out : str</span>
<span class="sd">         correlation.ini filename.</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     None</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Assumptions:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Assuming one data stream per station for computing the number of stations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">full_input_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_in</span>
    <span class="n">full_output_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span>
    <span class="n">summary_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span><span class="o">+</span><span class="s2">&quot;_report&quot;</span>
    
    <span class="n">lines_out</span><span class="o">=</span><span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Processing &quot;</span><span class="o">+</span><span class="n">full_input_file</span><span class="o">+</span><span class="s2">&quot; ...&quot;</span><span class="p">)</span>
    <span class="c1">#                                                                              ### ---- Process .input ----   </span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">C_DIFX_INPUT_INT_TIME</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                      <span class="c1"># Accumulation period</span>
                <span class="n">int_time</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_EXECUTE_TIME</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                <span class="c1"># Scan duration</span>
                <span class="n">duration</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_START_MJD</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                   <span class="c1"># Start MJD</span>
                <span class="n">mjd</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_START_SECONDS</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                               <span class="c1"># Start seconds</span>
                <span class="n">start_s</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_TELESCOPES</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                 <span class="c1"># Number of stations</span>
                <span class="n">stations</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_NUM_CHANNELS</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                <span class="c1"># Number of coefficients in visibilities</span>
                <span class="n">fft_size</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_PHASE_CALS</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                  <span class="c1"># Phase calibration</span>
                <span class="n">pcal_val</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pcal_val</span><span class="o">==</span><span class="s2">&quot;0&quot;</span><span class="p">:</span>
                    <span class="n">pcal</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pcal</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
    
    <span class="c1">#                                                                             ### ---- Prepare lines correlation.ini ----</span>
    
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_CR_S_ELEMENTS</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>                           <span class="c1"># Elements</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_STATIONS</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">stations</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_AUTO_ST</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="s2">&quot;yes&quot;</span><span class="p">)</span>                                             <span class="c1"># (!)forced</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_CROSS_POL</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="s2">&quot;yes&quot;</span><span class="p">)</span>                                           <span class="c1"># (!)forced</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_CR_S_COMP</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>                               <span class="c1"># Computation</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_FFT</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">fft_size</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_ACC</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">int_time</span><span class="p">)))</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_WINDOW</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">C_INI_CR_WINDOW_SQUARE</span><span class="p">)</span>                             <span class="c1"># (!)forced</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_PC</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">pcal</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_CR_S_TIMES</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>                              <span class="c1"># Times</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_MJD</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">mjd</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_START</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">start_s</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_CR_DURATION</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">duration</span><span class="p">)</span>
    
    <span class="n">write_lines_to_f</span><span class="p">(</span><span class="n">lines_out</span><span class="p">,</span><span class="n">full_output_file</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File contents:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">ii</span><span class="p">)</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="create_symb_media"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.create_symb_media">[docs]</a><span class="k">def</span> <span class="nf">create_symb_media</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_input_v</span><span class="p">,</span><span class="n">forced_files</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">symb_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create symbolic links for media. This links are also part of the configuration.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     inout_folder : str</span>
<span class="sd">         path to folder containing newly created ini files.</span>
<span class="sd">     file_input_v : list of str</span>
<span class="sd">         paths to media files.</span>
<span class="sd">     forced_files :  str</span>
<span class="sd">         comma separated list of paths to media files to override file paths from .input file.</span>
<span class="sd">         If &quot;&quot;, then the pahts from the .input file are used.</span>
<span class="sd">     symb_dir : str,optional</span>
<span class="sd">         path relative to inout_folder where links will be created.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     file_list : list of str</span>
<span class="sd">         filenames to be used in media.ini.</span>
<span class="sd">     files_str : str</span>
<span class="sd">         comma separated list of filenames.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    

    <span class="k">if</span> <span class="n">forced_files</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(!) Forcing file names: &quot;</span><span class="o">+</span><span class="n">forced_files</span><span class="p">)</span>
        <span class="n">file_list_paths</span> <span class="o">=</span> <span class="n">forced_files</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_input_v</span><span class="p">)</span><span class="o">!=</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list_paths</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(!) WARNING: number of forced file paths and found paths in .input differ!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_input_v</span><span class="p">)</span><span class="o">&gt;</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list_paths</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(!) WARNING: missing information for the following files:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">file_input_v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">file_input_v</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">file_list_paths</span><span class="p">)):]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(!)  &quot;</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file_list_paths</span><span class="o">=</span><span class="n">file_input_v</span>
    
    <span class="c1"># only filename, no path</span>
    <span class="n">file_list</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">file_list_paths</span><span class="p">]</span>  
    <span class="n">files_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_list</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">symb_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">symb_dir</span> <span class="o">=</span> <span class="n">CX_DEFAULT_MEDIA_DIR</span>
    <span class="n">dir_link</span> <span class="o">=</span> <span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">symb_dir</span>
    
    <span class="c1"># Display info and prepare commands</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating symbolic links for media in &quot;</span><span class="o">+</span><span class="n">dir_link</span><span class="p">)</span>
    <span class="n">cmd_unlink_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">cmd_link_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="s2">&quot;Link&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;Source&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span><span class="n">file_list_paths</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">+</span><span class="n">j</span><span class="p">)</span>
        <span class="n">new_link</span> <span class="o">=</span> <span class="n">dir_link</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">i</span>
        <span class="n">cmd_unlink</span> <span class="o">=</span> <span class="s2">&quot;unlink &quot;</span><span class="o">+</span><span class="n">new_link</span>
        <span class="n">cmd_unlink_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd_unlink</span><span class="p">)</span>
        <span class="n">cmd_link</span> <span class="o">=</span>   <span class="s2">&quot;ln -s &quot;</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">dir_link</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">i</span>
        <span class="n">cmd_link_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd_link</span><span class="p">)</span>
    
    <span class="c1"># Launch commands</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;mkdir &quot;</span><span class="o">+</span><span class="n">dir_link</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">cmd_unlink</span><span class="p">,</span><span class="n">cmd_link</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cmd_unlink_v</span><span class="p">,</span><span class="n">cmd_link_v</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd_unlink</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd_unlink</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cmd_link</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd_link</span><span class="p">)</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(!) If moving ini folder do: cp -r --preserve=links &quot;</span><span class="o">+</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot; dir_ini_destination&quot;</span><span class="p">)</span>
    <span class="k">return</span><span class="p">([</span><span class="n">file_list</span><span class="p">,</span><span class="n">files_str</span><span class="p">])</span></div>
        

<div class="viewcode-block" id="input_to_media"><a class="viewcode-back" href="../cx2d_lib.html#cx2d_lib.input_to_media">[docs]</a><span class="k">def</span> <span class="nf">input_to_media</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_in</span><span class="p">,</span><span class="n">file_out</span><span class="p">,</span><span class="n">forced_files</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert DiFX/.input into CorrelX/media.ini, create symbolic links for media files</span>
<span class="sd">      and generate report with summary (for reporting/debugging).</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     inout_folder : str</span>
<span class="sd">         path to folder containing .input file, and where newly created media.ini file will be placed.</span>
<span class="sd">     file_in : str</span>
<span class="sd">         .input filename.</span>
<span class="sd">     file_out : str</span>
<span class="sd">         media.ini filename.</span>
<span class="sd">     forced_files : str, required</span>
<span class="sd">         list of files to be used in the media files</span>
<span class="sd">     v : int</span>
<span class="sd">         verbose if 1.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     None</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Limitations:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Currently limited to sets of files with the same configuration (i.e. no missmatched bands).</span>
<span class="sd">    |</span>
<span class="sd">    |</span>
<span class="sd">    | **Assumptions:**</span>
<span class="sd">    |</span>
<span class="sd">    |    The function is strongly dependent on the current order of the fields in the .input file.</span>
<span class="sd">    |    The zoom bands are expected to appear after the normal bands.</span>
<span class="sd">    |    Assuming incremental id starting at 0 in input file.</span>
<span class="sd">    |</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |    Read forced files from the .input file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">pol_lr</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;R&#39;</span><span class="p">]</span>
    <span class="n">pol_xy</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
    
    <span class="n">full_input_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_in</span>
    <span class="n">full_output_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span>
    <span class="n">summary_file</span><span class="o">=</span><span class="n">inout_folder</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="o">+</span><span class="n">file_out</span><span class="o">+</span><span class="s2">&quot;_report&quot;</span>
    
    <span class="n">first_bw_set</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">first_bw</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">lines_out</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">channel_freq_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">channel_bw_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">sideband_v</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">st_names</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">st_names_ind</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">list_z</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">list_zb</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">zoom_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">zoom_flag</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="n">pol_v</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">lines_ch</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines_f</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines_bw</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines_z</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lines_zb</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">ch_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">bands_v</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">ch_v_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">pol_v_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">side_v_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">ch_v_v</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">f_v_v</span><span class="o">=</span><span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Processing &quot;</span><span class="o">+</span><span class="n">full_input_file</span><span class="o">+</span><span class="s2">&quot; ...&quot;</span><span class="p">)</span>
    
    <span class="n">file_input_v</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="c1">#                                                                                         ### ---- Process .input ----</span>
    
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">C_DIFX_INPUT_FREQ</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                                     <span class="c1"># Append group info: sampling freq</span>
                <span class="n">channel_freq_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span> <span class="c1">#*1e6)</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_BW</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                                     <span class="c1"># Append group info: bandwidth / zoom</span>
                <span class="n">channel_bw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="c1">#*1e6</span>
                <span class="n">channel_bw_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel_bw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">first_bw_set</span> <span class="ow">and</span> <span class="n">channel_bw</span><span class="o">&lt;</span><span class="n">first_bw</span><span class="p">:</span>
                    <span class="c1"># zoom band</span>
                    <span class="n">zoom_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">zoom_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">first_bw_set</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">first_bw</span><span class="o">+=</span><span class="n">channel_bw</span>
                    <span class="n">first_bw_set</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_SIDEBAND</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                               <span class="c1"># Append group info: sideband</span>
                <span class="n">sideband</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">sideband_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sideband</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_TELESCOPE_TABLE</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                        <span class="c1"># Prepare media lists (all group info)</span>
                <span class="c1"># close vectors</span>
                <span class="n">n_id</span><span class="o">=-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ch_f</span><span class="p">,</span><span class="n">ch_bw</span><span class="p">,</span><span class="n">ch_side</span><span class="p">,</span><span class="n">ch_z</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">channel_freq_v</span><span class="p">,</span><span class="n">channel_bw_v</span><span class="p">,</span><span class="n">sideband_v</span><span class="p">,</span><span class="n">zoom_v</span><span class="p">):</span> 
                    <span class="n">n_id</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">str_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ch_z</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">last_n_id</span><span class="o">=</span><span class="n">n_id</span>
                        <span class="n">lines_ch</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_CH</span><span class="o">+</span><span class="n">str_id</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">str_id</span><span class="p">)</span>
                        <span class="n">lines_f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_CH</span><span class="o">+</span><span class="n">str_id</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ch_f</span><span class="p">))</span>
                        <span class="n">lines_bw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_CH</span><span class="o">+</span><span class="n">str_id</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ch_bw</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">str_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">n_id</span><span class="o">-</span><span class="n">last_n_id</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">lines_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_ZF</span><span class="o">+</span><span class="n">str_id</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ch_f</span><span class="p">))</span>
                        <span class="n">lines_zb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_ZB</span><span class="o">+</span><span class="n">str_id</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ch_bw</span><span class="p">))</span>
                        <span class="n">list_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_ZF</span><span class="o">+</span><span class="n">str_id</span><span class="p">)</span>
                        <span class="n">list_zb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_ZB</span><span class="o">+</span><span class="n">str_id</span><span class="p">)</span>
                        <span class="n">zoom_flag</span><span class="o">=</span><span class="mi">1</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_TELESCOPE_NAME</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                          <span class="c1"># Station names</span>
                <span class="n">station_name</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">st_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">station_name</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_TELESCOPE_INDEX</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">C_DIFX_INPUT_BASELINE_TABLE</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span> <span class="c1"># Group of group info (one per station)</span>
                <span class="c1"># new station, prepare vectors with channels</span>
                
                <span class="k">if</span> <span class="n">C_DIFX_INPUT_TELESCOPE_INDEX</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                      <span class="c1"># Station id for this datastream</span>
                    <span class="n">st_names_ind</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
                
                <span class="k">if</span> <span class="n">ch_v</span><span class="o">!=</span><span class="p">[]:</span>
                    <span class="n">ch_v_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch_v</span><span class="p">)</span>
                    <span class="n">pol_v_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pol_v</span><span class="p">)</span>
                    <span class="n">side_v_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">side_v</span><span class="p">)</span>
                    <span class="n">f_v_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_samp</span><span class="p">)</span>
                <span class="n">ch_v</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">pol_v</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">side_v</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">bands_v</span><span class="o">=</span><span class="p">[]</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_DATA_SAMPLING</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                          <span class="c1"># Adjust sampling freq (complex)</span>
                <span class="n">data_type</span><span class="o">=</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="c1"># to be used later once first frequency is read</span>
                <span class="c1">#if data_type==C_DIFX_INPUT_COMPLEX:</span>
                <span class="c1">#    f_samp=first_bw</span>
                <span class="c1">#else:</span>
                <span class="c1">#   f_samp=2*first_bw</span>
                
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_REC_BAND</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">C_DIFX_INPUT_POL</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                  <span class="c1"># Append group info: polarization</span>
                <span class="n">pol</span> <span class="o">=</span> <span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">pol_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pol_lr</span><span class="p">:</span>
                    <span class="n">pol_list</span><span class="o">=</span><span class="n">pol_lr</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pol_list</span><span class="o">=</span><span class="n">pol_xy</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_REC_FREQ</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">C_DIFX_INPUT_INDEX</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>               <span class="c1"># Record freq index (accesed by channel)</span>
                <span class="n">bands_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_REC_BAND</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">C_DIFX_INPUT_INDEX</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>               <span class="c1"># Append group info: channel, sideband</span>
                <span class="n">id_ch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="c1">#ch = C_INI_MEDIA_CH+get_value_im(line)</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">C_INI_MEDIA_CH</span><span class="o">+</span><span class="n">bands_v</span><span class="p">[</span><span class="n">id_ch</span><span class="p">]</span>
                <span class="n">ch_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                <span class="n">side_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sideband_v</span><span class="p">[</span><span class="n">id_ch</span><span class="p">])</span>
                <span class="n">f_samp</span><span class="o">=</span><span class="n">channel_bw_v</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">bands_v</span><span class="p">[</span><span class="n">id_ch</span><span class="p">])]</span>
                <span class="k">if</span> <span class="n">data_type</span><span class="o">!=</span><span class="n">C_DIFX_INPUT_COMPLEX</span><span class="p">:</span>
                    <span class="n">f_samp</span><span class="o">*=</span><span class="mi">2</span>
            
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_PHASE_CAL_INT</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                         <span class="c1"># Phase calibration</span>
                <span class="n">pcal_val</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span> <span class="c1">#*1e6)</span>
    
            <span class="k">elif</span> <span class="n">C_DIFX_INPUT_FILE</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> \
                 <span class="n">C_DIFX_INPUT_FILES</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span>\
                 <span class="n">C_DIFX_INPUT_DATA_SOURCE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>                                       <span class="c1"># Files paths</span>
                <span class="n">file_input_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_value_im</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    
    
    
    <span class="c1">#                                                                                        ### ---- Create symbolic links ---</span>
    <span class="p">[</span><span class="n">file_list</span><span class="p">,</span><span class="n">files_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">create_symb_media</span><span class="p">(</span><span class="n">inout_folder</span><span class="p">,</span><span class="n">file_input_v</span><span class="p">,</span><span class="n">forced_files</span><span class="p">)</span>
        

    <span class="c1">#                                                                                         ### ---- Prepare lines media.ini ----</span>
    
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_MEDIA_S_CHANNELS</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>                                    <span class="c1"># List of channels</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_ch</span><span class="p">:</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_MEDIA_FREQUENCIES</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>                                   <span class="c1"># List of frequencies</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_f</span><span class="p">:</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="s2">&quot;e6&quot;</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zoom_flag</span><span class="p">:</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_MEDIA_BANDWIDTHS</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>                                <span class="c1"># List of bandwidths</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_bw</span><span class="p">:</span>
            <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="s2">&quot;e6&quot;</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_MEDIA_S_POLARIZATIONS</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>                               <span class="c1"># List of polarizations</span>
    <span class="n">jj</span><span class="o">=-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pol_list</span><span class="p">:</span>
        <span class="n">jj</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">jj</span><span class="p">))</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">zoom_flag</span><span class="p">:</span>                                                                             <span class="c1"># List of zoom bands (if applicable)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_MEDIA_ZP_FREQ</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_z</span><span class="p">:</span>
            <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="s2">&quot;e6&quot;</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_MEDIA_ZP_BW</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_zb</span><span class="p">:</span>
            <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="s2">&quot;e6&quot;</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_MEDIA_ZOOM_POST</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_ZP_FREQ</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_z</span><span class="p">))</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_ZP_BW</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_zb</span><span class="p">))</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">C_INI_MEDIA_S_FILES</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>                                       <span class="c1"># List of files</span>
    <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_LIST</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">files_str</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i_file</span><span class="p">,</span><span class="n">st_name_ind</span><span class="p">,</span><span class="n">ch_v</span><span class="p">,</span><span class="n">pol_v</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">side_v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span><span class="n">st_names_ind</span><span class="p">,</span><span class="n">ch_v_v</span><span class="p">,</span><span class="n">pol_v_v</span><span class="p">,</span><span class="n">f_v_v</span><span class="p">,</span><span class="n">side_v_v</span><span class="p">):</span> 
        <span class="n">st_name</span><span class="o">=</span><span class="n">st_names</span><span class="p">[</span><span class="n">st_name_ind</span><span class="p">]</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>                                                                  <span class="c1"># Information for all files</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">INI_HF</span><span class="o">+</span><span class="n">i_file</span><span class="o">+</span><span class="n">INI_HL</span><span class="p">)</span>  
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_STATION</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">st_name</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_CHANNELS</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ch_v</span><span class="p">))</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_S_POLARIZATIONS</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pol_v</span><span class="p">))</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_FRAMEBYTES</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="s2">&quot;0&quot;</span><span class="p">)</span>                                       <span class="c1"># (!) forced</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_FREQ_SAMPLE</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;e6&quot;</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_FORMAT</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">C_INI_MEDIA_F_VDIF</span><span class="p">)</span>                            <span class="c1"># (!) forced</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_VERSION</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">C_INI_MEDIA_V_CUSTOM</span><span class="p">)</span>                         <span class="c1"># (!) forced</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_F_PCAL</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">pcal_val</span><span class="o">+</span><span class="s2">&quot;e6&quot;</span><span class="p">)</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_O_PCAL</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="s2">&quot;0&quot;</span><span class="o">+</span><span class="s2">&quot;e6&quot;</span><span class="p">)</span>                                      <span class="c1"># (!) forced</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_FREQUENCIES</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ch_v</span><span class="p">))</span>
        <span class="n">lines_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C_INI_MEDIA_SIDEBANDS</span><span class="o">+</span><span class="n">INI_SEP</span><span class="o">+</span><span class="n">INI_VEC</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">side_v</span><span class="p">))</span>
    
    
    <span class="n">write_lines_to_f</span><span class="p">(</span><span class="n">lines_out</span><span class="p">,</span><span class="n">full_output_file</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File contents:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">lines_out</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="n">ii</span><span class="p">)</span>    
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span></div>
        
        

<span class="c1"># &lt;codecell&gt;</span>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Antonio Vazquez Alvarez, Victor Pankratius, and Pedro Elosegui.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>