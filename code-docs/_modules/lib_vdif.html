<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>lib_vdif &#8212; CorrelX 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for lib_vdif</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># &lt;nbformat&gt;3.0&lt;/nbformat&gt;</span>

<span class="c1"># &lt;codecell&gt;</span>

<span class="c1">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1">#The MIT CorrelX Correlator</span>
<span class="c1">#</span>
<span class="c1">#https://github.com/MITHaystack/CorrelX</span>
<span class="c1">#Contact: correlX@haystack.mit.edu</span>
<span class="c1">#Project leads: Victor Pankratius, Pedro Elosegui Project developer: A.J. Vazquez Alvarez</span>
<span class="c1">#</span>
<span class="c1">#Copyright 2017 MIT Haystack Observatory</span>
<span class="c1">#</span>
<span class="c1">#Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</span>
<span class="c1">#</span>
<span class="c1">#The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1">#THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#------------------------------</span>
<span class="c1">#------------------------------</span>
<span class="c1">#Project: CorrelX.</span>
<span class="c1">#File: lib_vdif.py.</span>
<span class="c1">#Author: A.J. Vazquez Alvarez (ajvazquez@haystack.mit.edu)</span>
<span class="c1">#Description: </span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module with basic functions to read and write VDIF headers and data.</span>

<span class="sd">| -- VDIF Specification version [VD01]--</span>
<span class="sd">|  VLBI Data Interchange Format (VDIF) Specification</span>
<span class="sd">|    Release 1.0 (w/24 August 2009 corrections/clarifications highlighted)</span>
<span class="sd">|    Ratified 26 June 2009</span>
<span class="sd">|</span>

<span class="sd">Notes</span>
<span class="sd">------</span>
<span class="sd">| -bitarray library still used for VDIF file generation.</span>
<span class="sd">|  Updated 2015.10.15:</span>
<span class="sd">|  -frame length (//8 when writing header, *8 when reading header)</span>
<span class="sd">|  -changed endiannes to be correct</span>
<span class="sd">|  2015.12.03: changed bits2int(bitsin)</span>
<span class="sd">|  2015.12.03: read_samples is now more efficient, but may not work with numbers of bits per sample that do not divide 32.</span>
<span class="sd">|  TO DO: implement in &quot;read_samples&quot; the functionality to read bits per sample that do not divide 32.</span>
<span class="sd">|  TO DO: testing on epoch and seconds conversions.</span>
<span class="sd">|  2016.09.21: bitarray reader implementation removed in favor of raw which is faster.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1">#History:</span>
<span class="c1">#initial version: 2015.12 ajva</span>
<span class="c1">#MIT Haystack Observatory</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">array</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">USE_BITARRAY</span><span class="o">=</span><span class="mi">0</span>
<span class="k">if</span> <span class="n">USE_BITARRAY</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">bitarray</span> <span class="k">import</span> <span class="n">bitarray</span>                   <span class="c1"># Enable for VDIF creation functions (testing)</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span><span class="p">,</span><span class="n">datetime</span><span class="p">,</span><span class="n">timedelta</span>

<span class="c1"># Constants for VDIF reader</span>
<span class="n">TYPE_WORD</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span>                              <span class="c1"># Data type for binary file reader.</span>
<span class="n">WORD_SIZE</span><span class="o">=</span><span class="mi">32</span>                                     <span class="c1"># 32 bits per word. This is tied to TYPE_WORD.</span>
<span class="n">WORD_SIZE_BYTES</span><span class="o">=</span><span class="n">WORD_SIZE</span><span class="o">//</span><span class="mi">8</span>                     <span class="c1"># 4 bytes per word.</span>
<span class="n">HEADER_VDIF_WORDS</span><span class="o">=</span><span class="mi">8</span>                              <span class="c1"># 8 words (VDIF header).</span>
<span class="n">HEADER_BYTES</span><span class="o">=</span><span class="n">WORD_SIZE_BYTES</span><span class="o">*</span><span class="n">HEADER_VDIF_WORDS</span>   <span class="c1"># 32 bytes (VDIF header).</span>

<span class="c1"># Constants for bitarray implementation (used in frame writer)</span>
<span class="n">ENDIAN_STRUCT_READING</span> <span class="o">=</span> <span class="s2">&quot;&gt;I&quot;</span>                     <span class="c1"># Struct endian.</span>
<span class="n">ENDIAN_STRUCT</span> <span class="o">=</span> <span class="s2">&quot;&gt;I&quot;</span>                             <span class="c1"># &lt; for little endian, &gt; for big endian, I for unsigned int (4 bytes).</span>
<span class="n">ENDIAN_BITARRAY</span> <span class="o">=</span> <span class="s1">&#39;big&#39;</span>                          <span class="c1"># Bitarray endian.</span>

<span class="c1"># Low level configuration for bitarray implementation (used in frame writer)</span>
<span class="c1">#  Use &#39;L&#39; (min size 4 bytes) or &#39;I&#39; (min size 2 bytes) for integer</span>
<span class="c1">#  https://docs.python.org/2/library/array.html</span>
<span class="c1">#  With &#39;L&#39; it works in Python3, but in Python2 the words seem to be extended to 64 bytes, padded with zeros.</span>
<span class="c1">#  &#39;I&#39; seems to works well in both Python2 and Python3</span>
<span class="c1">#LOW_LEVEL_WORD=&#39;L&#39;</span>
<span class="n">LOW_LEVEL_WORD</span><span class="o">=</span><span class="s1">&#39;I&#39;</span>

<span class="n">REF_YEAR</span><span class="o">=</span><span class="mi">2000</span>
<span class="c1">#REF_J2000=51544.5</span>
<span class="n">REF_J2000</span><span class="o">=</span><span class="mi">51544</span>
<span class="n">SIX_MONTH_DAYS</span><span class="o">=</span><span class="mi">365</span><span class="o">/</span><span class="mi">2</span>
<span class="n">SECONDS_DAY</span><span class="o">=</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>

<span class="c1"># Masks for read_header_vdif_from_raw</span>
<span class="n">MASK_1</span>  <span class="o">=</span> <span class="mi">1</span>
<span class="n">MASK_3</span>  <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">MASK_5</span>  <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">MASK_6</span>  <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">MASK_10</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">MASK_16</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">MASK_24</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">MASK_30</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>






<span class="c1"># Reading routines  --------------------------</span>


<div class="viewcode-block" id="print_header_vdif"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.print_header_vdif">[docs]</a><span class="k">def</span> <span class="nf">print_header_vdif</span><span class="p">(</span><span class="n">seconds_fr</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
               <span class="n">ref_epoch</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">frame_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
               <span class="n">vdif_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">log_2_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_length</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">5000</span><span class="p">,</span> 
               <span class="n">data_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bits_per_sample</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">thread_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">station_id</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show header of vdif frame, for logging.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     See read_header_vdif_from_raw() output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Seconds frame: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">seconds_fr</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">invalid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Legacy: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">legacy</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ref. epoch: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ref_epoch</span><span class="p">)</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Frame number: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">frame_num</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VDIF version: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vdif_version</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Log 2 num channels: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_2_channels</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Frame Length: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">frame_length</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">frame_length</span> <span class="o">//</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&quot;kB&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data type: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bits per sample: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bits_per_sample</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Thread ID: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Station ID: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span></div>
    

<div class="viewcode-block" id="print_header_vdif_info"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.print_header_vdif_info">[docs]</a><span class="k">def</span> <span class="nf">print_header_vdif_info</span><span class="p">(</span><span class="n">brief</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show stats results header.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;VDIF file stats:&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">brief</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;count:     Counter (based on skip and limit)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;st:        Station ID numeric str&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I:         Invalid&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;leg:       Legacy&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vv:        VDIF version&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;epoch:     Ref. epoch: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[s]:       Seconds frame&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;num:       Frame number&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;thread:    Thread ID&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;log2C:     Log2 of the number of channels per frame&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len[B]:    Frame Length in bytes&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len[kB]:   Frame Length in kilobytes&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R/C:       Data type&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;bpsamp:    Bits per sample&quot;</span><span class="p">)</span>

    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;st&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;I&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;leg&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;vv&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;epoch&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;[s]&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;num&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;thread&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;log2C&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;len[B]&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;len[kB]&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;R/C&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span>\
          <span class="s2">&quot;bpsamp&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span></div>
          

<div class="viewcode-block" id="print_header_vdif_row"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.print_header_vdif_row">[docs]</a><span class="k">def</span> <span class="nf">print_header_vdif_row</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">seconds_fr</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
               <span class="n">ref_epoch</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">frame_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
               <span class="n">vdif_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">log_2_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_length</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">5000</span><span class="p">,</span> 
               <span class="n">data_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bits_per_sample</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">thread_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">station_id</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">dt</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;R&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">invalid</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">legacy</span><span class="p">))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">vdif_version</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">ref_epoch</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">seconds_fr</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">frame_num</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">thread_id</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">log_2_channels</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">frame_length</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">frame_length</span><span class="o">//</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span>\
          <span class="n">dt</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span>\
          <span class="nb">str</span><span class="p">(</span><span class="n">bits_per_sample</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span></div>


<div class="viewcode-block" id="vdif_epoch_seconds_to_epoch_seconds_datetime"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.vdif_epoch_seconds_to_epoch_seconds_datetime">[docs]</a><span class="k">def</span> <span class="nf">vdif_epoch_seconds_to_epoch_seconds_datetime</span><span class="p">(</span><span class="n">epoch_six</span><span class="p">,</span><span class="n">tot_seconds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute reference epoch and seconds from VDIF standard to MJD and seconds.</span>
<span class="sd">    Using datetime.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     epoch_six : int</span>
<span class="sd">         epoch directly from VDIF header.</span>
<span class="sd">     tot_seconds : int</span>
<span class="sd">         seconds directly from VDIF header.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     epoch</span>
<span class="sd">         epoch MJD.</span>
<span class="sd">     seconds</span>
<span class="sd">         epoch seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Seconds -&gt; number of days, seconds</span>
    <span class="n">seconds</span><span class="o">=</span><span class="n">tot_seconds</span><span class="o">%</span><span class="n">SECONDS_DAY</span>
    <span class="n">days_from_six</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tot_seconds</span><span class="o">//</span><span class="n">SECONDS_DAY</span><span class="p">)</span>
    
    <span class="c1"># Six-month period -&gt; years, six-month period</span>
    <span class="n">years_num</span><span class="o">=</span><span class="n">epoch_six</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">part_num</span><span class="o">=</span><span class="n">epoch_six</span><span class="o">%</span><span class="mi">2</span>

    <span class="c1"># Get days from ref epoch</span>
    <span class="n">year_mod</span><span class="o">=</span><span class="n">REF_YEAR</span><span class="o">+</span><span class="n">years_num</span>
    <span class="n">base_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">REF_YEAR</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">part_num</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">compare_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year_mod</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compare_date</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="n">year_mod</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">diff_date</span> <span class="o">=</span> <span class="p">(</span><span class="n">compare_date</span><span class="o">-</span><span class="n">base_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

    <span class="n">epoch</span><span class="o">=</span><span class="n">REF_J2000</span><span class="o">+</span><span class="n">diff_date</span><span class="o">+</span><span class="n">days_from_six</span>

    <span class="k">return</span><span class="p">([</span><span class="n">epoch</span><span class="p">,</span><span class="n">seconds</span><span class="p">])</span></div>



<div class="viewcode-block" id="date_to_vdif"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.date_to_vdif">[docs]</a><span class="k">def</span> <span class="nf">date_to_vdif</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">minute</span><span class="p">,</span><span class="n">second</span><span class="p">,</span><span class="n">offset_seconds</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute VDIF fields for epoch and seconds from date.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">REF_YEAR</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">base_date_current</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">compare_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">minute</span><span class="p">,</span><span class="n">second</span><span class="p">)</span>
    <span class="n">compare_date</span> <span class="o">+=</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">offset_seconds</span><span class="p">)</span>
    <span class="n">second_part</span> <span class="o">=</span> <span class="n">compare_date</span><span class="o">&gt;</span><span class="n">base_date_current</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">second_part</span><span class="p">:</span>
        <span class="n">base_date_current</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">diff_seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">compare_date</span><span class="o">-</span><span class="n">base_date_current</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span>
    <span class="n">diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">compare_date</span><span class="o">-</span><span class="n">base_date_current</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
    <span class="n">vdif_seconds</span><span class="o">=</span><span class="n">diff_seconds</span><span class="o">+</span><span class="n">diff_days</span><span class="o">*</span><span class="n">SECONDS_DAY</span>
    
    <span class="n">diff_years</span> <span class="o">=</span> <span class="n">year</span><span class="o">-</span><span class="n">REF_YEAR</span>
    <span class="n">vdif_epoch</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">diff_years</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">second_part</span><span class="p">)</span>

    <span class="k">return</span><span class="p">([</span><span class="n">vdif_epoch</span><span class="p">,</span><span class="n">vdif_seconds</span><span class="p">])</span></div>




<div class="viewcode-block" id="read_header_vdif_from_raw"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.read_header_vdif_from_raw">[docs]</a><span class="k">def</span> <span class="nf">read_header_vdif_from_raw</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reader vdif header.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     header : numpy array with four np.unit32 words.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     [seconds_fr,invalid,legacy,ref_epoch,frame_num,vdif_version,log_2_channels,</span>
<span class="sd">            frame_length,data_type,bits_per_sample,thread_id,station_id]:</span>
<span class="sd">            where:</span>
<span class="sd">             |   seconds_fr:        VDIF frame seconds (integer).</span>
<span class="sd">             |   invalid:           VDIF invalid bit.</span>
<span class="sd">             |   legacy:            VDIF legacy bit.</span>
<span class="sd">             |   ref_epoch:         VDIF frame epoch (float with MJD (TBC)).</span>
<span class="sd">             |   frame_num:         VDIF frame number (integer).</span>
<span class="sd">             |   vdif_version:      VDIF frame version (integer).</span>
<span class="sd">             |   log_2_channels:    VDIF logarithm in base 2 of the number of channels in the frame.</span>
<span class="sd">             |   frame_length:      VDIF frame length (integer with number of bytes).</span>
<span class="sd">             |   data_type:         VDIF frame data type bit.</span>
<span class="sd">             |   bits_per_sample:   number of bits per sample.</span>
<span class="sd">             |   thread_id:         VDIF thread identifier field (integer).</span>
<span class="sd">             |   station_id:        VDIF station id field (integer).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="c1"># Word 0</span>
    <span class="n">invalid</span> <span class="o">=</span>            <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span>
    <span class="n">legacy</span> <span class="o">=</span>            <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_1</span>
    <span class="n">seconds_fr</span> <span class="o">=</span>         <span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>        <span class="o">&amp;</span> <span class="n">MASK_30</span>
    <span class="c1"># Word 1</span>
    <span class="n">ref_epoch</span> <span class="o">=</span>         <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_6</span> 
    <span class="n">frame_num</span> <span class="o">=</span>          <span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>        <span class="o">&amp;</span> <span class="n">MASK_24</span>
    <span class="c1"># Word 2</span>
    <span class="n">vdif_version</span> <span class="o">=</span>      <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_3</span> 
    <span class="n">log_2_channels</span> <span class="o">=</span>    <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_5</span> 
    <span class="n">frame_length</span> <span class="o">=</span>       <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>        <span class="o">&amp;</span> <span class="n">MASK_24</span> 
    <span class="n">frame_length</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">frame_length</span>  <span class="c1">#Stored and read as a multiple of 8, see [VD01].</span>
    <span class="c1"># Word 3</span>
    <span class="n">data_type</span> <span class="o">=</span>          <span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span>
    <span class="n">bits_per_sample</span> <span class="o">=</span>   <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_5</span> 
    <span class="n">bits_per_sample</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="n">thread_id</span> <span class="o">=</span>         <span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MASK_10</span> 
    <span class="n">station_id</span> <span class="o">=</span>         <span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>        <span class="o">&amp;</span> <span class="n">MASK_16</span> 
    
    <span class="c1"># Adjust epoch and seconds according to VDIF standard (6 month periods...)</span>
    <span class="p">[</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">seconds_fr</span><span class="p">]</span><span class="o">=</span><span class="n">vdif_epoch_seconds_to_epoch_seconds_datetime</span><span class="p">(</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">seconds_fr</span><span class="p">)</span>
    
    <span class="k">return</span><span class="p">([</span><span class="n">seconds_fr</span><span class="p">,</span><span class="n">invalid</span><span class="p">,</span><span class="n">legacy</span><span class="p">,</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">frame_num</span><span class="p">,</span><span class="n">vdif_version</span><span class="p">,</span><span class="n">log_2_channels</span><span class="p">,</span>
            <span class="n">frame_length</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">thread_id</span><span class="p">,</span><span class="n">station_id</span><span class="p">])</span></div>



<div class="viewcode-block" id="compute_range"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.compute_range">[docs]</a><span class="k">def</span> <span class="nf">compute_range</span><span class="p">(</span><span class="n">word_size</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get starting positions in word for groups of bits_per_sample bits.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Example:**</span>
<span class="sd">    |</span>
<span class="sd">    |  word_size=32</span>
<span class="sd">    |  bits_per_sample=4</span>
<span class="sd">    |  list(compute_range(word_size,bits_per_sample))</span>
<span class="sd">    |  &gt;&gt;&gt; [0, 4, 8, 12, 16, 20, 24, 28]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">word_size</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">))</span></div>

<div class="viewcode-block" id="read_samples_from_raw"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.read_samples_from_raw">[docs]</a><span class="k">def</span> <span class="nf">read_samples_from_raw</span><span class="p">(</span><span class="n">words</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">word_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract samples from unit32 words into numpy array of integers.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     words : numpy array of np.unit32.</span>
<span class="sd">     bits_per_sample : int</span>
<span class="sd">     word_size : int</span>
<span class="sd">     </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Limitations:**</span>
<span class="sd">    |  bits per sample should be a divisor of word_size.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">range_offsets</span> <span class="o">=</span> <span class="n">compute_range</span><span class="p">(</span><span class="n">word_size</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">)</span>
    <span class="n">mask_bits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">bits_per_sample</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">words_extended</span> <span class="o">=</span> <span class="p">[((</span><span class="n">words</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">mask_bits</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_offsets</span><span class="p">]</span>
    <span class="n">words_extended2</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">words_extended</span><span class="p">)</span>
    <span class="n">words_nostack</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">words_extended2</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)))</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">words_nostack</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_bytes_offset_file"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.read_bytes_offset_file">[docs]</a><span class="k">def</span> <span class="nf">read_bytes_offset_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">n_bytes</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used to skip some offset when reading a binary file.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     f : file handler</span>
<span class="sd">         (sys.stdin).</span>
<span class="sd">     n_words : int</span>
<span class="sd">         number of words of type TYPE_WORD.</span>
<span class="sd">     v : int</span>
<span class="sd">         [0 by default] verbose mode if 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">words_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">words_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">n_bytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vdif - Read &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_bytes</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vdif - Tried to read &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_bytes</span><span class="p">))</span>
        <span class="k">return</span><span class="p">([])</span>
    <span class="k">return</span><span class="p">([])</span></div>


<div class="viewcode-block" id="read_words_from_file_to_raw"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.read_words_from_file_to_raw">[docs]</a><span class="k">def</span> <span class="nf">read_words_from_file_to_raw</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">n_words</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read binary file directly into numpy array.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     f : file handler</span>
<span class="sd">         (sys.stdin).</span>
<span class="sd">     n_words : int</span>
<span class="sd">         number of words of type TYPE_WORD.</span>
<span class="sd">     v : int</span>
<span class="sd">         [0 by default] verbose mode if 1.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     words_array :  numpy array with number-&gt;n_words type-&gt;TYPE_WORD words.</span>
<span class="sd">     </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Configuration:**</span>
<span class="sd">    |</span>
<span class="sd">    |  TYPE_WORD:   [np.uint32 by default] type of words to read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">words_array</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">words_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">file</span> <span class="o">=</span> <span class="n">f</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">TYPE_WORD</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">n_words</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vdif - Read &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_words</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vdif - Tried to read &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n_words</span><span class="p">))</span>
        <span class="k">return</span><span class="p">([])</span>   
    <span class="k">return</span><span class="p">(</span><span class="n">words_array</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_vdif_frame"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.read_vdif_frame">[docs]</a><span class="k">def</span> <span class="nf">read_vdif_frame</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">show_errors</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">forced_frame_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">offset_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">return_raw_header</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main routine for reading one VDIF frame.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     f : file handler</span>
<span class="sd">         input file handler (typically sys.stdin).</span>
<span class="sd">     show_errors : int</span>
<span class="sd">         [0 by default] display information on errors if 1.</span>
<span class="sd">     forced_frame_length : int</span>
<span class="sd">         [0 by default] number of bytes to read including header, if 0 will take value from header (recommended).</span>
<span class="sd">     offset_bytes : int</span>
<span class="sd">         [0 by default] number of bytes to skip before reading header.</span>
<span class="sd">     v : int</span>
<span class="sd">         [0 by default] verbosed mode if 1.</span>
<span class="sd">     return_raw_header : int</span>
<span class="sd">         [0 by default] if 0 returns a list of integers with the header fields, if 1 returns bytes.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     header : list of int</span>
<span class="sd">         list of integers with the fields in the VDIF header:</span>
<span class="sd">            |                   [seconds_fr,invalid,legacy,ref_epoch,frame_num,vdif_version,log_2_channels,\</span>
<span class="sd">            |                     frame_length,data_type,bits_per_sample,thread_id,station_id]. </span>
<span class="sd">            |              See read_header_vdif_from_raw() for details.</span>
<span class="sd">            |             If errors, header is None.</span>
<span class="sd">     samples : 1D numpy array of int </span>
<span class="sd">         sample components. E.g. for VDIF complex frame, [I0, Q0, I1, Q1, ...]</span>
<span class="sd">            |              if errors, samples is None.</span>
<span class="sd">     check_size_samples : int</span>
<span class="sd">         1 if read as many samples as expected from the frame length (and rest of metadata), 0 otherwise.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Configuration:**</span>
<span class="sd">    |</span>
<span class="sd">    |  HEADER_VDIF_WORDS</span>
<span class="sd">    |  HEADER_BYTES</span>
<span class="sd">    |  WORD_SIZE_BYTES</span>
<span class="sd">    | </span>
<span class="sd">    | **Procedure:**</span>
<span class="sd">    |</span>
<span class="sd">    |  1. Read VDIF header.</span>
<span class="sd">    |  2. Read rest of the frame based on frame length information in header.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">words_samples</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">failed_read</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">get_raw</span><span class="o">=</span><span class="mi">1</span>

    <span class="c1"># 0 if less samples than reported in header</span>
    <span class="n">check_size_samples</span><span class="o">=</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">offset_bytes</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">read_bytes_offset_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">offset_bytes</span><span class="p">)</span>


    <span class="n">words_header</span> <span class="o">=</span> <span class="n">read_words_from_file_to_raw</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">HEADER_VDIF_WORDS</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">words_header</span> <span class="o">==</span> <span class="p">[])</span><span class="ow">or</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">words_header</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">failed_read</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">show_errors</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;z-&quot;</span>  <span class="o">+</span> <span class="s2">&quot;-Failed to read samples&quot;</span><span class="p">)</span>
        


    <span class="k">if</span> <span class="n">failed_read</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">read_header_vdif_from_raw</span><span class="p">(</span><span class="n">words_header</span><span class="p">)</span> <span class="c1">#[:HEADER_VDIF_WORDS])   </span>
        <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="p">[</span><span class="n">seconds_fr</span><span class="p">,</span><span class="n">invalid</span><span class="p">,</span><span class="n">legacy</span><span class="p">,</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">frame_num</span><span class="p">,</span><span class="n">vdif_version</span><span class="p">,</span><span class="n">log_2_channels</span><span class="p">,</span>\
                               <span class="n">frame_length</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">thread_id</span><span class="p">,</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
            <span class="n">print_header_vdif</span><span class="p">(</span><span class="n">seconds_fr</span><span class="p">,</span> <span class="n">invalid</span><span class="p">,</span> <span class="n">legacy</span><span class="p">,</span><span class="n">ref_epoch</span><span class="p">,</span> <span class="n">frame_num</span><span class="p">,</span><span class="n">vdif_version</span><span class="p">,</span> <span class="n">log_2_channels</span><span class="p">,</span>\
                               <span class="n">frame_length</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span> <span class="n">bits_per_sample</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">,</span> <span class="n">station_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_errors</span><span class="p">:</span>
            <span class="p">[</span><span class="n">seconds_fr</span><span class="p">,</span><span class="n">invalid</span><span class="p">,</span><span class="n">legacy</span><span class="p">,</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">frame_num</span><span class="p">,</span><span class="n">vdif_version</span><span class="p">,</span><span class="n">log_2_channels</span><span class="p">,</span>\
                             <span class="n">frame_length</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">thread_id</span><span class="p">,</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame_length</span><span class="o">=</span><span class="n">header</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">bits_per_sample</span><span class="o">=</span><span class="n">header</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        
        <span class="c1"># Force frame length</span>
        <span class="k">if</span> <span class="n">forced_frame_length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">frame_length</span><span class="o">=</span><span class="n">forced_frame_length</span>
                
        <span class="c1">#if show_errors:</span>
        <span class="c1">#    #print(&quot;z-&quot; + str(time.time()) + &quot;- bpsamp: &quot; + str(bits_per_sample)+ &quot;- length: &quot; + str(frame_length))</span>
        <span class="c1">#    print(&quot;z-&quot; + &quot;- bpsamp: &quot; + str(bits_per_sample)+ &quot;- length: &quot; + str(frame_length))</span>

        <span class="n">n_words_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_length</span><span class="o">-</span><span class="n">HEADER_BYTES</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="n">WORD_SIZE_BYTES</span><span class="p">)</span>
        
        <span class="n">words_samples</span> <span class="o">=</span> <span class="n">read_words_from_file_to_raw</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">n_words_samples</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="c1">#,ENDIAN_BITARRAY,ENDIAN_STRUCT_READING)</span>
        <span class="k">if</span> <span class="n">words_samples</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">failed_read</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">show_errors</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;z-&quot;</span>  <span class="o">+</span> <span class="s2">&quot;-Failed to read samples&quot;</span><span class="p">)</span>
    
        <span class="c1">#print_header_vdif(seconds_fr,invalid,legacy,ref_epoch,frame_num,vdif_version,log_2_channels,</span>
        <span class="c1">#      frame_length,data_type,bits_per_sample,thread_id,station_id)</span>
    
        <span class="k">if</span> <span class="n">failed_read</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bits_per_sample</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="n">read_samples_from_raw</span><span class="p">(</span><span class="n">words</span><span class="o">=</span><span class="n">words_samples</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="o">=</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">word_size</span><span class="o">=</span><span class="n">WORD_SIZE</span><span class="p">)</span>
                <span class="n">expected_frame_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span><span class="o">*</span><span class="n">bits_per_sample</span><span class="p">)</span><span class="o">//</span><span class="mi">8</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">expected_frame_size</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">frame_length</span><span class="o">-</span><span class="n">HEADER_BYTES</span><span class="p">):</span>
                    <span class="n">check_size_samples</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">header</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="kc">None</span>
    
    
    
    <span class="k">if</span> <span class="n">return_raw_header</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">words_header</span>

    <span class="k">return</span><span class="p">([</span><span class="n">header</span><span class="p">,</span><span class="n">samples</span><span class="p">,</span><span class="n">check_size_samples</span><span class="p">])</span></div>




<div class="viewcode-block" id="reshape_samples"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.reshape_samples">[docs]</a><span class="k">def</span> <span class="nf">reshape_samples</span><span class="p">(</span><span class="n">allsamples</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span><span class="n">samples_in_frame</span><span class="p">,</span><span class="n">num_channels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Corner-turning. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     allsamples : 1D array</span>
<span class="sd">         with all samples read from VDIF file.</span>
<span class="sd">     data_type : int</span>
<span class="sd">         0 for real, 1 for complex.</span>
<span class="sd">     samples_in_frame : int</span>
<span class="sd">         number of samples components per channel.</span>
<span class="sd">     num_channels : int</span>
<span class="sd">         number of channels.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     samples : 2D array with num_channels rows, with each row containing only its associated samples.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **Procedure:**</span>
<span class="sd">    |</span>
<span class="sd">    |    # example</span>
<span class="sd">    |    aa=list(range(0,20))</span>
<span class="sd">    |    bb=np.reshape(aa,(-1,5,2))</span>
<span class="sd">    |    cc=np.transpose(bb,(1,0,2))</span>
<span class="sd">    |    dd=np.reshape(cc,(5,-1))</span>
<span class="sd">    |    dd</span>
<span class="sd">          </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># If complex data need to group differently</span>
    <span class="k">if</span> <span class="n">data_type</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1"># real data</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">allsamples</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">samples_in_frame</span><span class="o">//</span><span class="n">num_channels</span><span class="p">,</span><span class="n">num_channels</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>   
        <span class="c1"># complex data</span>
        
        
        <span class="c1"># np.column_stack is less efficient</span>
        <span class="n">bb</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">allsamples</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">num_channels</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">cc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">bb</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">samples</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">cc</span><span class="p">,(</span><span class="n">num_channels</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span></div>








<span class="c1"># Untested  ---------------------</span>

<div class="viewcode-block" id="read_header_mark5"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.read_header_mark5">[docs]</a><span class="k">def</span> <span class="nf">read_header_mark5</span><span class="p">(</span><span class="n">header</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    [DELETE]</span>
<span class="sd">    </span>
<span class="sd">    Untested. Consider deleting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Note inverse ordering...</span>
    
    <span class="c1"># Word 0</span>
    <span class="n">sync_word</span> <span class="o">=</span> <span class="n">bits2int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">][:])</span>
    
    <span class="c1"># Word 1</span>
    <span class="n">years</span> <span class="o">=</span> <span class="n">bits2int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">32</span><span class="p">:</span><span class="o">-</span><span class="mi">28</span><span class="p">])</span>
    <span class="n">user_data</span> <span class="o">=</span> <span class="n">bits2int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">28</span><span class="p">:</span><span class="o">-</span><span class="mi">16</span><span class="p">])</span>
    <span class="n">bit_t</span> <span class="o">=</span> <span class="n">bits2int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">16</span><span class="p">:</span><span class="o">-</span><span class="mi">15</span><span class="p">])</span>    
    <span class="n">frame_num</span> <span class="o">=</span> <span class="n">bits2int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">15</span><span class="p">:])</span> 
    
    <span class="c1"># Word 2</span>
    <span class="n">time_code_w1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span>
        <span class="n">time_code_w1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bits2int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">32</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="mi">32</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span>
    
    <span class="c1"># Word 3</span>
    <span class="n">time_code_w2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">time_code_w2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bits2int</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="o">-</span><span class="mi">32</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="mi">32</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]))</span>
    <span class="n">crcc</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">crcc</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="o">-</span><span class="mi">17</span><span class="p">:]</span>
    
    
    <span class="k">return</span><span class="p">([</span><span class="n">sync_word</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">bit_t</span><span class="p">,</span> <span class="n">frame_num</span><span class="p">,</span> <span class="n">time_code_w1</span><span class="p">,</span> <span class="n">time_code_w2</span><span class="p">,</span> <span class="n">crcc</span><span class="p">])</span></div>
    
<div class="viewcode-block" id="print_header_mark5"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.print_header_mark5">[docs]</a><span class="k">def</span> <span class="nf">print_header_mark5</span><span class="p">(</span><span class="n">sync_word</span><span class="p">,</span> <span class="n">years</span><span class="p">,</span> <span class="n">user_data</span><span class="p">,</span> <span class="n">bit_t</span><span class="p">,</span> <span class="n">frame_num</span><span class="p">,</span> <span class="n">time_code_w1</span><span class="p">,</span> <span class="n">time_code_w2</span><span class="p">,</span> <span class="n">crcc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    [DELETE]</span>
<span class="sd">    </span>
<span class="sd">    Untested. Consider deleting.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Sync word: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sync_word</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Years: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">years</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;User Data: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">user_data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bit T: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bit_t</span><span class="p">)</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Frame number: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">frame_num</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time code word 1: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time_code_w1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Time code word 2: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">time_code_w2</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CRCC: </span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">crcc</span><span class="p">)</span></div>





<span class="c1">###########################################################</span>
<span class="c1">#                Writing libraries</span>
<span class="c1">###########################################################</span>
<span class="c1"># TO DO: needs further testing</span>

<div class="viewcode-block" id="int2bits"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.int2bits">[docs]</a><span class="k">def</span> <span class="nf">int2bits</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="n">value_B</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">ENDIAN_STRUCT</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">value_b</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">value_b</span><span class="o">.</span><span class="n">frombytes</span><span class="p">(</span><span class="n">value_B</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">value_b</span><span class="p">)</span></div>


<div class="viewcode-block" id="strbitarray2int"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.strbitarray2int">[docs]</a><span class="k">def</span> <span class="nf">strbitarray2int</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="bits2int"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.bits2int">[docs]</a><span class="k">def</span> <span class="nf">bits2int</span><span class="p">(</span><span class="n">bitsin</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bitsin</span><span class="o">.</span><span class="n">to01</span><span class="p">(),</span><span class="mi">2</span><span class="p">))</span></div>


    
<div class="viewcode-block" id="create_header_vdif"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.create_header_vdif">[docs]</a><span class="k">def</span> <span class="nf">create_header_vdif</span><span class="p">(</span><span class="n">seconds_fr</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">legacy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
               <span class="n">ref_epoch</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">frame_num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
               <span class="n">vdif_version</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">log_2_channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame_length</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">5000</span><span class="p">,</span> 
               <span class="n">data_type</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bits_per_sample</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">thread_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">station_id</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TO DO: check epoch...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#DATA TYPE 0 FOR REAL, 1 FOR COMPLEX</span>
    <span class="c1"># TO DO: issues with epoch...</span>

    <span class="c1"># Computation for ref_epoch and seconds</span>
    <span class="c1">#[ref_epoch,seconds_fr]=epoch_seconds_to_vdif_epoch_seconds(ref_epoch,seconds_fr)</span>
    <span class="c1"># TO DO: check this...</span>
    <span class="c1">#[ref_epoch,seconds_fr]=vdif_epoch_seconds_to_epoch_seconds_datetime(ref_epoch,seconds_fr)</span>
    <span class="c1">#[ref_epoch,seconds_fr]=date_to_vdif(ref_epoch,seconds_fr)</span>

    
    <span class="c1"># Word 0</span>
    <span class="n">sec_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">seconds_fr</span><span class="p">)</span>

    <span class="c1"># Word structure: invalid (31), legacy (30), seconds from reference (29-0) </span>
    <span class="n">word0</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">word0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">invalid</span><span class="p">)</span>
    <span class="n">word0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">legacy</span><span class="p">)</span>
    <span class="n">word0</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sec_b</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:])</span>


    <span class="c1"># Word 1</span>

    <span class="n">ref_epoch_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">ref_epoch</span><span class="p">)</span>
    <span class="c1">#print(ref_epoch_b)</span>
    <span class="n">frame_num_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">frame_num</span><span class="p">)</span>

    <span class="c1"># Word structure: unassigned (31-30), ref epoch (29-24), frame number (23-0)</span>
    <span class="n">word1</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">word1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">word1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">word1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ref_epoch_b</span><span class="p">[</span><span class="o">-</span><span class="mi">6</span><span class="p">:])</span>
    <span class="n">word1</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame_num_b</span><span class="p">[</span><span class="o">-</span><span class="mi">24</span><span class="p">:])</span>


    <span class="c1"># Word 2</span>

    <span class="n">vdif_version_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">vdif_version</span><span class="p">)</span>
    <span class="n">log_2_channels_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">log_2_channels</span><span class="p">)</span>
    <span class="n">frame_length_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">frame_length</span><span class="o">//</span><span class="mi">8</span><span class="p">)</span> <span class="c1">#Stored and read as a multiple of 8!!!!</span>

    <span class="c1"># Word structure: vdif version (31-29), log2 of num channels (28-24), data frame number within second (23-0)</span>
    <span class="n">word2</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">word2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vdif_version_b</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
    <span class="n">word2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">log_2_channels_b</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span>
    <span class="n">word2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frame_length_b</span><span class="p">[</span><span class="o">-</span><span class="mi">24</span><span class="p">:])</span>


    <span class="c1"># Word 3</span>
    <span class="n">d_type</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span> <span class="c1"># 0 for real, 1 for complex</span>
    <span class="n">bits_per_sample</span><span class="o">-=</span><span class="mi">1</span>
    <span class="n">bits_per_sample_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">bits_per_sample</span><span class="p">)</span>
    <span class="n">thread_id_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">thread_id</span><span class="p">)</span>
    <span class="n">station_id_b</span> <span class="o">=</span> <span class="n">int2bits</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>

    <span class="c1"># Word structure: data type (31), bits/sample (30-26), thread id (25-16), station id (15-0)</span>
    <span class="n">word3</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">word3</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d_type</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">word3</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">bits_per_sample_b</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span>
    <span class="n">word3</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">thread_id_b</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
    <span class="n">word3</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">station_id_b</span><span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:])</span>

    <span class="c1"># Word 4 --EMPTY--</span>
    <span class="n">word4</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">word4</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">int2bits</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Word 5 --EMPTY--</span>
    <span class="n">word5</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">word5</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">int2bits</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    
    <span class="c1"># Word 6 --EMPTY--</span>
    <span class="n">word6</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">word6</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">int2bits</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    
    <span class="c1"># Word 7 --EMPTY--</span>
    <span class="n">word7</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
    <span class="n">word7</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">int2bits</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

    <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="n">word0</span><span class="p">,</span><span class="n">word1</span><span class="p">,</span><span class="n">word2</span><span class="p">,</span><span class="n">word3</span><span class="p">,</span><span class="n">word4</span><span class="p">,</span><span class="n">word5</span><span class="p">,</span><span class="n">word6</span><span class="p">,</span><span class="n">word7</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">header</span><span class="p">)</span></div>




<div class="viewcode-block" id="write_samples"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.write_samples">[docs]</a><span class="k">def</span> <span class="nf">write_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">word_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write vdif samples. Used by vdif signal generator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">samples_word</span> <span class="o">=</span> <span class="n">word_size</span> <span class="o">//</span> <span class="n">bits_per_sample</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">word_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">samples_word</span> <span class="o">*</span> <span class="n">bits_per_sample</span><span class="p">)</span>
    
    <span class="c1"># Zero padding word size</span>
    <span class="n">excess_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">%</span> <span class="n">samples_word</span>
    <span class="k">if</span> <span class="n">excess_samples</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">samples</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">samples_word</span> <span class="o">-</span> <span class="n">excess_samples</span><span class="p">))</span>
    
    <span class="n">tot_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">//</span> <span class="n">samples_word</span>
    
    <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tot_words</span><span class="p">):</span>
        <span class="n">bitbase</span> <span class="o">=</span> <span class="n">bitarray</span><span class="p">(</span><span class="n">endian</span><span class="o">=</span><span class="n">ENDIAN_BITARRAY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">bitbase</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">int2bits</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="o">-</span><span class="n">offset</span><span class="p">:])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">samples_word</span><span class="p">)):</span>
            <span class="n">bitbase</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">int2bits</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">samples_word</span><span class="o">+</span><span class="n">j</span><span class="p">])[</span><span class="o">-</span><span class="n">bits_per_sample</span><span class="p">:])</span>
        <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bitbase</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">words</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_samples_raw"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.write_samples_raw">[docs]</a><span class="k">def</span> <span class="nf">write_samples_raw</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">word_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write vdif samples.</span>
<span class="sd">    </span>
<span class="sd">    TO DO:</span>
<span class="sd">    ------</span>
<span class="sd">    Untested.</span>
<span class="sd">    Limited to bits_per_samples that are divisor of 8.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">samples_word</span> <span class="o">=</span> <span class="n">word_size</span> <span class="o">//</span> <span class="n">bits_per_sample</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">word_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">samples_word</span> <span class="o">*</span> <span class="n">bits_per_sample</span><span class="p">)</span>

    <span class="c1"># Zero padding word size</span>
    <span class="n">excess_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">%</span> <span class="n">samples_word</span>
    <span class="k">if</span> <span class="n">excess_samples</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1">#samples.extend([0] * (samples_word - excess_samples))</span>
        <span class="n">words</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
    
        <span class="n">tot_words</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">//</span> <span class="n">samples_word</span>
        
        <span class="n">range_offsets</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">bits_per_sample</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
    
        <span class="c1"># !! Limited to bits_per_sample divisors of 8!</span>
        <span class="n">samples_reshape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">samples</span><span class="p">,(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="o">//</span><span class="n">bits_per_sample</span><span class="p">))</span>
    
        <span class="n">samples_reshape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fliplr</span><span class="p">(</span><span class="n">samples_reshape</span><span class="p">)</span>
    
        <span class="n">samples_reshape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">samples_reshape</span><span class="p">,(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="c1">#bits_offset = [((samples)&gt;&gt;i) &amp; (1) for i in range_offsets]</span>
        <span class="n">bits_offset</span> <span class="o">=</span> <span class="p">[((</span><span class="n">samples_reshape</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">range_offsets</span><span class="p">]</span>
        <span class="n">bits_extended</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">bits_offset</span><span class="p">)</span>
        <span class="n">bits_trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">bits_extended</span><span class="p">,(</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)),(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">packbits</span><span class="p">(</span><span class="n">bits_trans</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">words</span><span class="p">)</span></div>



<div class="viewcode-block" id="write_words_to_file"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.write_words_to_file">[docs]</a><span class="k">def</span> <span class="nf">write_words_to_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">words</span><span class="p">):</span>
    <span class="n">words_int</span><span class="o">=</span><span class="p">[</span><span class="n">bits2int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">words</span><span class="p">]</span>
    <span class="n">words_array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LOW_LEVEL_WORD</span><span class="p">,</span><span class="n">words_int</span><span class="p">)</span>
    <span class="n">words_array</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_words_to_file_raw"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.write_words_to_file_raw">[docs]</a><span class="k">def</span> <span class="nf">write_words_to_file_raw</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">words</span><span class="p">):</span>
    <span class="c1">#words_int=[bits2int(i) for i in words]</span>
    <span class="c1">#words_array = array.array(LOW_LEVEL_WORD,words)</span>
    <span class="n">words</span><span class="o">.</span><span class="n">tofile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


<span class="c1">###########################################################</span>
<span class="c1">#                      Utilities</span>
<span class="c1">###########################################################</span>



<div class="viewcode-block" id="disp_list"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.disp_list">[docs]</a><span class="k">def</span> <span class="nf">disp_list</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">a</span><span class="p">)))</span></div>


<div class="viewcode-block" id="get_vdif_stats"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.get_vdif_stats">[docs]</a><span class="k">def</span> <span class="nf">get_vdif_stats</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">packet_limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">forced_packet_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">offset_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">only_offset_once</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">short_output</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get information from vdif file by processing headers. As many headers as packet_limit are processed.</span>
<span class="sd">    Each of the output parameters are vectors with all the possible values found.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     filename : str</span>
<span class="sd">         path to VDIF file.</span>
<span class="sd">     packet_limit : int</span>
<span class="sd">         [default -1] maximum number of packets, if -1 no limit.</span>
<span class="sd">     forced_packet_size : int</span>
<span class="sd">         [default 0] if &gt;0 will read this number of bytes instead those in the VDIF header.</span>
<span class="sd">     offset_bytes : int</span>
<span class="sd">         [default 0] skip this number of bytes before reading the first VDIF header.</span>
<span class="sd">     only_offset_once : int</span>
<span class="sd">         [default 1] if ==0 will skip offset_bytes before every frame to be read.</span>
<span class="sd">     v : int</span>
<span class="sd">         [default 1] verbose mode if 1.</span>
<span class="sd">     short_output : int</span>
<span class="sd">         [default 0] group very long vector (frames) if 1.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     v_stations : list</span>
<span class="sd">         list with unique ids found for stations in all frames read.</span>
<span class="sd">     v_seconds : list</span>
<span class="sd">         list with unique seconds found for all frames read.</span>
<span class="sd">     v_frames : list</span>
<span class="sd">         list with unique frame numbers for all frames read.</span>
<span class="sd">     v_sizes : list</span>
<span class="sd">         list with unique frame sizes for all frames read.</span>
<span class="sd">     total_size : int          total size for all frames read.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_size</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">f_read</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">keep_reading</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">SHOW_ERRORS</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ljv</span><span class="o">=</span><span class="mi">20</span>
    
    <span class="n">packet_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">f_read</span> <span class="c1">#sys.stdin</span>

    <span class="n">v_epoch</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_seconds</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_frames</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_data_type</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_sizes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_stations</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_numchannels</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_bpsamp</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_threads</span><span class="o">=</span><span class="p">[]</span>

    <span class="n">total_file_size</span><span class="o">=</span><span class="mi">0</span> <span class="c1"># Including headers</span>
    <span class="n">total_size</span><span class="o">=</span><span class="mi">0</span>      <span class="c1"># Only data</span>

    <span class="n">v_file</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">file_size</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span><span class="n">file_size</span><span class="o">*</span><span class="mf">1.1</span><span class="p">,</span><span class="n">file_size</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># File size comparison thresholds</span>
    <span class="n">v_perc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>                                <span class="c1"># Percentages</span>

    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading VDIF file...   0%&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    
    <span class="k">while</span> <span class="n">keep_reading</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_file</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="nb">len</span><span class="p">(</span><span class="n">v_file</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">total_file_size</span><span class="o">&gt;=</span><span class="n">v_file</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;...&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">v_perc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;%&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="n">v_file</span><span class="o">=</span><span class="n">v_file</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="n">v_perc</span><span class="o">=</span><span class="n">v_perc</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="n">packet_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">packet_limit</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">packet_count</span> <span class="o">==</span> <span class="n">packet_limit</span><span class="p">:</span>
                <span class="n">keep_reading</span> <span class="o">=</span> <span class="mi">0</span>
       
        
        <span class="c1"># Get header and samples from VDIF packet</span>
        <span class="p">[</span><span class="n">header</span><span class="p">,</span><span class="n">samples</span><span class="p">,</span><span class="n">check_size_samples</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_vdif_frame</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span><span class="n">SHOW_ERRORS</span><span class="p">,</span><span class="n">forced_packet_size</span><span class="p">,</span><span class="n">offset_bytes</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">only_offset_once</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">offset_bytes</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">header</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>

            <span class="c1"># Decode header</span>
            <span class="p">[</span><span class="n">seconds_fr</span><span class="p">,</span><span class="n">invalid</span><span class="p">,</span><span class="n">legacy</span><span class="p">,</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">frame_num</span><span class="p">,</span><span class="n">vdif_version</span><span class="p">,</span><span class="n">log_2_channels</span><span class="p">,</span>
                <span class="n">frame_length</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">thread_id</span><span class="p">,</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
            
            <span class="k">if</span> <span class="n">ref_epoch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_epoch</span><span class="p">:</span>
                <span class="n">v_epoch</span><span class="o">+=</span><span class="p">[</span><span class="n">ref_epoch</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">seconds_fr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_seconds</span><span class="p">:</span>
                <span class="n">v_seconds</span><span class="o">+=</span><span class="p">[</span><span class="n">seconds_fr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">frame_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_frames</span><span class="p">:</span>
                <span class="n">v_frames</span><span class="o">+=</span><span class="p">[</span><span class="n">frame_num</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">frame_length</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_sizes</span><span class="p">:</span>
                <span class="n">v_sizes</span><span class="o">+=</span><span class="p">[</span><span class="n">frame_length</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_data_type</span><span class="p">:</span>
                <span class="n">v_data_type</span><span class="o">+=</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span>    
            <span class="k">if</span> <span class="n">station_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_stations</span><span class="p">:</span>
                <span class="n">v_stations</span><span class="o">+=</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span>
            <span class="n">num_channels</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">log_2_channels</span>
            <span class="k">if</span> <span class="n">num_channels</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_numchannels</span><span class="p">:</span>
                <span class="n">v_numchannels</span><span class="o">+=</span><span class="p">[</span><span class="n">num_channels</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bits_per_sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_bpsamp</span><span class="p">:</span>
                <span class="n">v_bpsamp</span><span class="o">+=</span><span class="p">[</span><span class="n">bits_per_sample</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thread_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_threads</span><span class="p">:</span>
                <span class="n">v_threads</span><span class="o">+=</span><span class="p">[</span><span class="n">thread_id</span><span class="p">]</span>
            <span class="n">total_size</span><span class="o">+=</span><span class="n">frame_length</span>
            <span class="n">total_file_size</span><span class="o">+=</span><span class="n">frame_length</span>
            <span class="n">total_file_size</span><span class="o">+=</span><span class="p">(</span><span class="n">HEADER_VDIF_WORDS</span><span class="o">*</span><span class="n">WORD_SIZE_BYTES</span><span class="p">)</span>


        <span class="k">else</span><span class="p">:</span>
            <span class="n">keep_reading</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">f_read</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">v</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;File information:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">packet_limit</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; (!) Packet limit: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">packet_limit</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; File name: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Data size: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; B&quot;</span> <span class="o">+</span> <span class="s2">&quot; (~&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">total_size</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; MB)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Stations: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">v_stations</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Epochs: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="n">disp_list</span><span class="p">(</span><span class="n">v_epoch</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Seconds: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="n">disp_list</span><span class="p">(</span><span class="n">v_seconds</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">short_output</span><span class="p">:</span>
            <span class="n">v</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">pre_i</span><span class="o">=-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">v_frames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pre_i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">pre_i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">pre_i</span><span class="o">=-</span><span class="mi">1</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pre_i</span><span class="o">=</span><span class="n">i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">i</span>
                    <span class="n">pre_i</span><span class="o">=</span><span class="n">i</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">v_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">v</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Frames: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span><span class="o">+</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Frames: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="n">disp_list</span><span class="p">(</span><span class="n">v_frames</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Sizes: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="n">disp_list</span><span class="p">(</span><span class="n">v_sizes</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Data type: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="n">disp_list</span><span class="p">(</span><span class="n">v_data_type</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Num.channels: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="n">disp_list</span><span class="p">(</span><span class="n">v_numchannels</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Num.threads: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="n">disp_list</span><span class="p">(</span><span class="n">v_threads</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Bits per sample: &quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">ljv</span><span class="p">)</span> <span class="o">+</span> <span class="n">disp_list</span><span class="p">(</span><span class="n">v_bpsamp</span><span class="p">))</span>
        
    <span class="k">return</span><span class="p">([</span><span class="n">v_stations</span><span class="p">,</span><span class="n">v_seconds</span><span class="p">,</span><span class="n">v_frames</span><span class="p">,</span><span class="n">v_sizes</span><span class="p">,</span><span class="n">total_size</span><span class="p">])</span></div>






<div class="viewcode-block" id="get_vdif_num_frames"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.get_vdif_num_frames">[docs]</a><span class="k">def</span> <span class="nf">get_vdif_num_frames</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">packet_limit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">forced_packet_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">offset_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                        <span class="n">only_offset_once</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get information from vdif file by processing headers. As many headers as packet_limit are processed.</span>
<span class="sd">    Each of the output parameters are vectors with all the possible values found.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     See get_vdif_stats().</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     num_frames : int</span>
<span class="sd">         number of frames read.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    |</span>
<span class="sd">    | **TO DO:**</span>
<span class="sd">    |</span>
<span class="sd">    |  This is a modified version of get_vdif_stats(), merge with it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f_read</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="n">keep_reading</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">SHOW_ERRORS</span> <span class="o">=</span> <span class="mi">0</span>

    
    <span class="n">packet_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">f_read</span> <span class="c1">#sys.stdin</span>

    <span class="n">v_epoch</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_seconds</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_frames</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_data_type</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_sizes</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_stations</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_numchannels</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">v_bpsamp</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">num_frames</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">total_size</span><span class="o">=</span><span class="mi">0</span>

    <span class="k">while</span> <span class="n">keep_reading</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">packet_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">packet_limit</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">packet_count</span> <span class="o">==</span> <span class="n">packet_limit</span><span class="p">:</span>
                <span class="n">keep_reading</span> <span class="o">=</span> <span class="mi">0</span>
       
        
        <span class="c1"># Get header and samples from VDIF packet</span>
        <span class="p">[</span><span class="n">header</span><span class="p">,</span><span class="n">samples</span><span class="p">,</span><span class="n">check_size_samples</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_vdif_frame</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span><span class="n">SHOW_ERRORS</span><span class="p">,</span><span class="n">forced_packet_size</span><span class="p">,</span><span class="n">offset_bytes</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">only_offset_once</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">offset_bytes</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">header</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>

            <span class="c1"># Decode header</span>
            <span class="p">[</span><span class="n">seconds_fr</span><span class="p">,</span><span class="n">invalid</span><span class="p">,</span><span class="n">legacy</span><span class="p">,</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">frame_num</span><span class="p">,</span><span class="n">vdif_version</span><span class="p">,</span><span class="n">log_2_channels</span><span class="p">,</span>
                <span class="n">frame_length</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">thread_id</span><span class="p">,</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
            
            <span class="k">if</span> <span class="n">ref_epoch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_epoch</span><span class="p">:</span>
                <span class="n">v_epoch</span><span class="o">+=</span><span class="p">[</span><span class="n">ref_epoch</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">seconds_fr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_seconds</span><span class="p">:</span>
                <span class="n">v_seconds</span><span class="o">+=</span><span class="p">[</span><span class="n">seconds_fr</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">frame_num</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_frames</span><span class="p">:</span>
                <span class="n">v_frames</span><span class="o">+=</span><span class="p">[</span><span class="n">frame_num</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">frame_length</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_sizes</span><span class="p">:</span>
                <span class="n">v_sizes</span><span class="o">+=</span><span class="p">[</span><span class="n">frame_length</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_data_type</span><span class="p">:</span>
                <span class="n">v_data_type</span><span class="o">+=</span><span class="p">[</span><span class="n">data_type</span><span class="p">]</span>    
            <span class="k">if</span> <span class="n">station_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_stations</span><span class="p">:</span>
                <span class="n">v_stations</span><span class="o">+=</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span>
            <span class="n">num_channels</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="n">log_2_channels</span>
            <span class="k">if</span> <span class="n">num_channels</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_numchannels</span><span class="p">:</span>
                <span class="n">v_numchannels</span><span class="o">+=</span><span class="p">[</span><span class="n">num_channels</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bits_per_sample</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">v_bpsamp</span><span class="p">:</span>
                <span class="n">v_bpsamp</span><span class="o">+=</span><span class="p">[</span><span class="n">bits_per_sample</span><span class="p">]</span>
            <span class="n">total_size</span><span class="o">+=</span><span class="n">frame_length</span>
            
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v_seconds</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">keep_reading</span><span class="o">=</span><span class="mi">0</span>
                

        <span class="k">else</span><span class="p">:</span>
            <span class="n">keep_reading</span><span class="o">=</span><span class="mi">0</span>

    <span class="n">f_read</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">v_frames</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">num_frames</span><span class="p">)</span></div>


<div class="viewcode-block" id="show_headers_vdif"><a class="viewcode-back" href="../lib_vdif.html#lib_vdif.show_headers_vdif">[docs]</a><span class="k">def</span> <span class="nf">show_headers_vdif</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">limit_frames</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">skip_frames</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">brief</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get tabulated information from vdif file headers. The first &quot;limit_frames&quot; after &quot;skip_frames&quot; are read.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">     filename : str</span>
<span class="sd">         path to file.</span>
<span class="sd">     limit_frames : int</span>
<span class="sd">         maximum number of lines to display (-1 for no limit).</span>
<span class="sd">     skip_frames : int</span>
<span class="sd">         number of frames to skip before starting displaying frames (default &lt;=0).</span>
<span class="sd">     brief : int</span>
<span class="sd">         1 to avoid displaying descriptions for columns.</span>
<span class="sd">     </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">     N/A</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f_read</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>

    <span class="n">SHOW_ERRORS</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">counter_frames</span><span class="o">=-</span><span class="mi">1</span>
    
    <span class="n">keep_reading</span><span class="o">=</span><span class="mi">1</span>
    
    
    <span class="n">print_header_vdif_info</span><span class="p">(</span><span class="n">brief</span><span class="p">)</span>
    
    <span class="k">while</span> <span class="n">keep_reading</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        
        
        <span class="k">if</span> <span class="n">limit_frames</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">skip_frames</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">counter_frames</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">counter_frames</span><span class="o">==</span><span class="p">(</span><span class="n">limit_frames</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">keep_reading</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">limit_frames</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">limit_frames</span><span class="o">&lt;-</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">counter_frames</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">f_read</span>
        
        <span class="c1"># Get header and samples from VDIF packet</span>
        <span class="p">[</span><span class="n">header</span><span class="p">,</span><span class="n">samples</span><span class="p">,</span><span class="n">check_size_samples</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_vdif_frame</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span><span class="n">SHOW_ERRORS</span><span class="p">)</span>
        

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">header</span> <span class="o">==</span> <span class="kc">None</span><span class="p">):</span>
           
            
            <span class="c1"># Decode header</span>
            <span class="p">[</span><span class="n">seconds_fr</span><span class="p">,</span><span class="n">invalid</span><span class="p">,</span><span class="n">legacy</span><span class="p">,</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">frame_num</span><span class="p">,</span><span class="n">vdif_version</span><span class="p">,</span><span class="n">log_2_channels</span><span class="p">,</span>
                <span class="n">frame_length</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">thread_id</span><span class="p">,</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>

            <span class="k">if</span> <span class="n">skip_frames</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">skip_frames</span><span class="o">-=</span><span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">print_header_vdif_row</span><span class="p">(</span><span class="n">counter_frames</span><span class="p">,</span><span class="n">seconds_fr</span><span class="p">,</span><span class="n">invalid</span><span class="p">,</span><span class="n">legacy</span><span class="p">,</span><span class="n">ref_epoch</span><span class="p">,</span><span class="n">frame_num</span><span class="p">,</span><span class="n">vdif_version</span><span class="p">,</span><span class="n">log_2_channels</span><span class="p">,</span>
                <span class="n">frame_length</span><span class="p">,</span><span class="n">data_type</span><span class="p">,</span><span class="n">bits_per_sample</span><span class="p">,</span><span class="n">thread_id</span><span class="p">,</span><span class="n">station_id</span><span class="p">)</span>
            <span class="c1">#print(&quot;--------------------&quot;)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">keep_reading</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">f_read</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1"># &lt;codecell&gt;</span>


</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Antonio Vazquez Alvarez, Victor Pankratius, and Pedro Elosegui.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>